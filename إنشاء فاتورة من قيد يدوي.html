<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ â€” Demo</title>
  <!--
  README (ÙƒÙŠÙÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§)
  -----------------------------------------:
  â€¢ Ù‡Ø°Ø§ Ù…Ù„Ù ÙˆØ§Ø­Ø¯ (index.html). Ø§Ø­ÙØ¸Ù‡ ÙƒÙ…Ù„Ù .html ÙˆØ§ÙØªØ­Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ ÙÙŠ Ù…ØªØµÙØ­ Ø­Ø¯ÙŠØ« (Chrome/Edge/Firefox).
  â€¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©. ÙƒÙ„ Ø´ÙŠØ¡ Vanilla (HTML/CSS/JS).
  â€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¶Ù…Ù†Ø© (JOURNALS). Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ J-2025-000186 Ø£Ùˆ Ø¨ÙƒÙ„Ù…Ø© "Ø£ØµÙ„".
  â€¢ Ø§Ù„ØªØ¯ÙÙ‚:
      1) Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ ÙˆØ§Ø®ØªØ±Ù‡.
      2) Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Mapping) ÙˆØ­Ø±Ù‘Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØ§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ø²Ù….
      3) Ø§Ø¶ØºØ· "ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© ZATCA" Ø«Ù… "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©".
      4) Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø³ØªØ¹Ù…Ù„ Ø£Ø²Ø±Ø§Ø±: Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©ØŒ ØªØµØ¯ÙŠØ± JSON. (ØªØµØ¯ÙŠØ± PDF = window.print())
  â€¢ QR Ù‡Ù†Ø§ Placeholder (ØªÙ…Ø«ÙŠÙ„ Ù†ØµÙ‘ÙŠ/Ù…Ø±Ø¦ÙŠ Ù…Ø¨Ø³Ù‘Ø·ØŒ Ù„ÙŠØ³ Ù…ÙˆÙ„Ø¯ ZATCA ÙØ¹Ù„ÙŠ).
  â€¢ Ø£Ù…Ø§ÙƒÙ† Ø§Ù„ØªÙˆØ³Ø¹Ø© Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨ØªØ¹Ù„ÙŠÙ‚Ø§Øª // TODO Ù„Ø±Ø¨Ø· API Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§.
  -----------------------------------------
  Ø¨Ù†ÙŠØ© Ù…Ù†Ø·Ù‚ÙŠØ© ØªØ­Ø§ÙƒÙŠ Ù…Ù„ÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø¶Ù…Ù† ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©:
  - styles.css            => Ù…Ø¶Ù…Ù‘Ù† Ø¯Ø§Ø®Ù„ <style id="styles-base">
  - invoice-preview.css   => Ù…Ø¶Ù…Ù‘Ù† Ø¯Ø§Ø®Ù„ <style id="styles-print">
  - app.js + state.js + mapping.js + validators.js + ui.js => Ø¶Ù…Ù† <script type="module">
  -->

  <style id="styles-base">
    :root{
      --blue:#1877f2; /* Ø£Ø²Ø±Ù‚ Ù‚Ø±ÙŠØ¨ Ù…Ù† ÙÙŠØ³Ø¨ÙˆÙƒ */
      --blue-600:#166fe0;
      --blue-700:#125ec8;
      --bg:#ffffff;
      --text:#0f172a; /* slate-900 */
      --muted:#64748b; /* slate-500 */
      --border:#e2e8f0; /* slate-200 */
      --success:#16a34a;
      --error:#dc2626;
      --warning:#f59e0b;
      --card:#ffffff;
      --shadow:0 8px 20px rgba(2,6,23,.06);
      --radius:16px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220;
        --text:#e5e7eb;
        --muted:#94a3b8;
        --border:#1f2a44;
        --card:#0f172a;
        --shadow:0 8px 24px rgba(0,0,0,.35);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic UI", Arial, sans-serif;
    }

    /* Ø±Ø£Ø³ Ø«Ø§Ø¨Øª */
    header.appbar{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(6px);
      background:color-mix(in srgb, var(--bg) 70%, transparent);
      border-bottom:1px solid var(--border);
    }
    .appbar .wrap{display:flex; align-items:center; gap:14px; padding:10px 16px; max-width:1200px; margin:auto}
    .logo{width:28px; height:28px; border-radius:8px; background:var(--blue); display:grid; place-items:center; color:white; font-weight:700}
    .title{font-weight:800}
    .badge{margin-inline-start:auto; font-size:12px; color:var(--muted)}

    /* ØªØ®Ø·ÙŠØ· Ø§Ù„ØµÙØ­Ø© */
    main{max-width:1200px; margin:18px auto; padding:0 12px}
    .grid{display:grid; gap:16px}
    @media(min-width:980px){
      .grid-cols-2{grid-template-columns:1.1fr .9fr}
    }

    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .card header{padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700}
    .card .content{padding:14px 16px}

    /* Ø£Ø²Ø±Ø§Ø± */
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{
      background:var(--blue); color:#fff; border:none; cursor:pointer;
      padding:10px 14px; border-radius:12px; font-weight:700; transition:.15s;
    }
    .btn:hover{background:var(--blue-600)}
    .btn:active{transform:translateY(1px)}
    .btn.ghost{background:transparent; color:var(--blue); border:1px solid var(--blue)}
    .btn.muted{background:#eef2ff; color:#1e3a8a; border:1px solid #c7d2fe}
    .btn.success{background:var(--success)}
    .btn.error{background:var(--error)}

    /* Ù†Ù…Ø§Ø°Ø¬ */
    .field{margin:8px 0}
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .input, select, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text);
    }
    .input:focus, select:focus, textarea:focus{outline:2px solid color-mix(in srgb, var(--blue) 30%, transparent)}
    .hint{font-size:12px; color:var(--muted)}
    .error-text{color:var(--error); font-size:12px; margin-top:4px}

    /* Ø¬Ø¯Ø§ÙˆÙ„ */
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:color-mix(in srgb, var(--card) 95%, var(--blue) 5%); text-align:start; font-size:12px; color:var(--muted); border-bottom:1px solid var(--border)}
    th,td{padding:10px 8px}
    tbody tr{border-bottom:1px solid var(--border)}
    tbody tr:hover{background:color-mix(in srgb, var(--blue) 7%, transparent)}

    /* ØªÙˆØ³Øª */
    .toast{position:fixed; inset-inline:0; bottom:16px; display:grid; place-items:center; z-index:60; pointer-events:none}
    .toast .msg{pointer-events:auto; background:var(--card); border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow)}

    /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
    .modal{position:fixed; inset:0; background:rgba(2,6,23,.35); display:none; align-items:center; justify-content:center; z-index:70; padding:20px}
    .modal.show{display:flex}
    .modal .panel{width:min(900px, 100%); max-height:90vh; overflow:auto; background:#fff; color:#111827; border-radius:16px; box-shadow:0 16px 40px rgba(0,0,0,.35); padding:24px}

    /* Ø¨Ø·Ø§Ù‚Ø© Check-list */
    .checklist{display:grid; gap:8px; font-size:14px}

    /* Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
    .status-chip{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:12px; background:#f8fafc; color:#0f172a; border:1px solid var(--border)}

    /* Ù…Ù†Ø·Ù‚Ø© QR */
    .qr-box{display:grid; grid-template-columns:120px 1fr; gap:12px; align-items:center}
    canvas.qr{width:120px; height:120px; border:1px dashed var(--border); border-radius:8px}

    /* Ø£Ø´Ø±Ø·Ø© ÙØ±Ø¹ÙŠØ© */
    .subgrid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    @media(max-width:640px){.subgrid{grid-template-columns:1fr}}

    /* Ø£Ø²Ø±Ø§Ø± Ø£Ø³ÙÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .toolbar{display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-start}

  </style>

  <!-- Ø·Ø¨Ø§Ø¹Ø©/Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
  <style id="styles-print">
    @media print{
      body{background:#fff; color:#111827}
      header.appbar, .no-print{display:none !important}
      .print-area{display:block}
    }
    .invoice-preview{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; direction:rtl}
    .invoice{max-width:820px; margin:auto; border:1px solid #e5e7eb; border-radius:12px; padding:24px}
    .invoice header{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .invoice .logo{width:48px; height:48px; border-radius:10px; background:#1877f2; color:#fff; display:grid; place-items:center; font-weight:800}
    .invoice h1{font-size:20px; margin:0}
    .muted{color:#64748b}
    .grid2{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px}
    .box{border:1px solid #e5e7eb; border-radius:10px; padding:12px}
    .totals{display:grid; gap:6px}
    .qr-row{display:flex; gap:12px; align-items:center}
    .qr{width:120px; height:120px; border:1px dashed #cbd5e1; border-radius:8px}
    table.inv{width:100%; border-collapse:separate; border-spacing:0}
    table.inv thead th{font-size:12px; color:#64748b; border-bottom:1px solid #e5e7eb}
    table.inv td, table.inv th{padding:10px}
    table.inv tbody tr{border-bottom:1px solid #f1f5f9}
  </style>
</head>
<body>
  <header class="appbar" role="banner">
    <div class="wrap" aria-label="Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ">
      <div class="logo" aria-hidden="true">SL</div>
      <div class="title">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ù‚ÙŠØ¯ ÙŠØ¯ÙˆÙŠ</div>
      <div class="badge"><span class="status-chip" id="statusChip">Ù…Ø³ÙˆØ¯Ø©</span></div>
    </div>
  </header>

  <main>
    <div class="grid grid-cols-2">
      <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù‚ÙŠØ¯ -->
      <section class="card" aria-label="Ø¨Ø­Ø« Ø§Ù„Ù‚ÙŠØ¯">
        <header>Ø¨Ø­Ø« Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ</header>
        <div class="content">
          <div class="row">
            <input id="searchInput" class="input" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯ / Ø§Ù„ØªØ§Ø±ÙŠØ® / Ø§Ù„ÙˆØµÙ" aria-label="Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«" />
            <button class="btn" id="btnSearch" aria-label="Ø²Ø± Ø§Ù„Ø¨Ø­Ø«">Ø¨Ø­Ø«</button>
            <button class="btn ghost" id="btnReset">Ù…Ø³Ø­</button>
          </div>
          <div class="hint">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ø¯Ù†Ø§Ù‡. Ø§Ø¶ØºØ· "Ø§Ø®ØªÙŠØ§Ø±" Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯.</div>
          <div style="margin-top:10px; max-height:280px; overflow:auto; border:1px solid var(--border); border-radius:12px">
            <table aria-label="Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬">
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ù„ÙØ§ØªÙˆØ±Ø© -->
      <section class="card" aria-label="Ù…Ø­ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø¥Ù„Ù‰ ÙØ§ØªÙˆØ±Ø©">
        <header>Ù…ÙØ­ÙˆÙ‘ÙÙ„ Ø§Ù„Ù‚ÙŠØ¯ â†’ ÙØ§ØªÙˆØ±Ø©</header>
        <div class="content" id="converter">
          <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø± -->
          <div class="field">
            <label>Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø±</label>
            <div class="subgrid">
              <input class="input" id="jId" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯" readonly aria-readonly="true" />
              <input class="input" id="jDate" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ¯" readonly aria-readonly="true" />
              <input class="input" id="jCurr" placeholder="Ø§Ù„Ø¹Ù…Ù„Ø©" readonly aria-readonly="true" />
              <input class="input" id="jDesc" placeholder="Ø§Ù„ÙˆØµÙ" readonly aria-readonly="true" />
            </div>
          </div>

          <!-- Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ø¨Ø· -->
          <div class="field">
            <label>ØªØ­Ø¯ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</label>
            <div class="row">
              <select id="customerSelect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„" class="input" style="max-width:60%"></select>
              <button class="btn muted" id="btnUseGuess">Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ù‚ÙŠØ¯</button>
            </div>
            <div id="errCustomer" class="error-text" hidden>ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù…ÙŠÙ„.</div>
          </div>

          <!-- Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
          <div class="card" style="margin-top:10px">
            <header>Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</header>
            <div class="content">
              <div class="subgrid">
                <div class="field">
                  <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹ (Ø§Ù„Ù…Ù†Ø´Ø£Ø©)</label>
                  <input class="input" id="sellerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©" />
                  <div id="errSellerName" class="error-text" hidden>Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ù„Ø²Ø§Ù…ÙŠ.</div>
                </div>
                <div class="field">
                  <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (Ø§Ù„Ø¨Ø§Ø¦Ø¹)</label>
                  <input class="input" id="sellerVAT" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ" />
                  <div id="errSellerVAT" class="error-text" hidden>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù…Ø·Ù„ÙˆØ¨.</div>
                </div>
                <div class="field">
                  <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹</label>
                  <input class="input" id="sellerAddr" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
                </div>
                <div class="field">
                  <label>Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                  <input class="input" id="invCurr" value="SAR" />
                </div>
              </div>
              <hr style="border:none; border-top:1px solid var(--border); margin:10px 0"/>
              <div class="subgrid">
                <div class="field">
                  <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input class="input" id="buyerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
                  <div id="errBuyerName" class="error-text" hidden>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨.</div>
                </div>
                <div class="field">
                  <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ (Ø§Ù„Ø¹Ù…ÙŠÙ„)</label>
                  <input class="input" id="buyerVAT" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
                </div>
                <div class="field">
                  <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input class="input" id="buyerAddr" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
                </div>
                <div class="field">
                  <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input class="input" id="buyerCode" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
                </div>
              </div>
              <hr style="border:none; border-top:1px solid var(--border); margin:10px 0"/>
              <div class="subgrid">
                <div class="field">
                  <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</label>
                  <input class="input" id="invId" placeholder="Ø³ÙŠÙÙˆÙ„Ù‘Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§" readonly />
                </div>
                <div class="field">
                  <label>ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
                  <input class="input" id="issueDate" type="datetime-local" />
                  <div id="errIssueDate" class="error-text" hidden>ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù…Ø·Ù„ÙˆØ¨.</div>
                </div>
              </div>

              <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
              <div class="field">
                <label>Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                <div style="border:1px solid var(--border); border-radius:12px; overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th style="width:30%">Ø§Ù„ÙˆØµÙ</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© %</th>
                        <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        <th class="no-print">ğŸ’ </th>
                      </tr>
                    </thead>
                    <tbody id="linesBody"></tbody>
                  </table>
                </div>
                <div class="toolbar no-print" style="margin-top:8px">
                  <button class="btn" id="btnAddLine">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button>
                </div>
                <div id="errLines" class="error-text" hidden>ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¨Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­.</div>
              </div>

              <!-- Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª + QR -->
              <div class="subgrid">
                <div>
                  <div class="field">
                    <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª</label>
                    <div class="totals">
                      <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong id="tNet">0.00</strong></div>
                      <div>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong id="tVAT">0.00</strong></div>
                      <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: <strong id="tGrand">0.00</strong></div>
                    </div>
                  </div>
                </div>
                <div>
                  <div class="field">
                    <label>QR / TLV (Placeholder)</label>
                    <div class="qr-box">
                      <canvas class="qr" id="qrCanvas" aria-label="Ø±Ù…Ø² Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø³Ø±ÙŠØ¹ ØªØ¬Ø±ÙŠØ¨ÙŠ"></canvas>
                      <div>
                        <textarea id="qrText" class="input" rows="4" placeholder="TLV:..."></textarea>
                        <div class="toolbar" style="margin-top:8px">
                          <button class="btn ghost" id="btnGenQR">ØªØ­Ø¯ÙŠØ« QR</button>
                          <button class="btn" id="btnCopyQR">Ù†Ø³Ø® Ù†Øµ TLV/QR</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
              <div class="toolbar no-print" style="margin-top:12px">
                <button class="btn muted" id="btnZATCA">ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© ZATCA</button>
                <button class="btn" id="btnSaveDraft">Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©</button>
                <button class="btn success" id="btnGenerate">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                <button class="btn ghost" id="btnPreview" disabled>Ù…Ø¹Ø§ÙŠÙ†Ø©/Ø·Ø¨Ø§Ø¹Ø©</button>
                <button class="btn ghost" id="btnExportPDF" disabled>ØªØµØ¯ÙŠØ± PDF</button>
                <button class="btn ghost" id="btnExportJSON" disabled>ØªØµØ¯ÙŠØ± JSON</button>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- ØªÙØ§ØµÙŠÙ„ Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø± -->
      <section class="card" aria-label="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯" style="grid-column:1 / -1">
        <header>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø®ØªØ§Ø±</header>
        <div class="content">
          <div style="max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px">
            <table aria-label="Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù‚ÙŠØ¯">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ù…Ø¯ÙŠÙ†</th>
                  <th>Ø¯Ø§Ø¦Ù†</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                </tr>
              </thead>
              <tbody id="journalLines"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© / Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚ -->
  <div class="modal" id="modal">
    <div class="panel" role="dialog" aria-modal="true">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:12px">
        <strong id="modalTitle">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</strong>
        <button class="btn ghost" id="btnCloseModal" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true" hidden>
    <div class="msg" id="toastMsg">Ø±Ø³Ø§Ù„Ø©</div>
  </div>

  <script type="module">
    // ===============================
    // state.js â€” Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    // ===============================
    const State = {
      journals: [],
      current: { journal: null, invoice: null, generated: false },
      nextSerial(){
        const y = new Date().getFullYear();
        const key = `INV-SERIAL-${y}`;
        let n = Number(localStorage.getItem(key) || 0) + 1;
        localStorage.setItem(key, String(n));
        return `INV-${y}-${String(n).padStart(6,'0')}`;
      }
    };

    // ===============================
    // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€” JOURNALS (Ù…Ø·Ù„ÙˆØ¨Ø©)
    // ===============================
    const JOURNALS = [
      {
        id: "J-2025-000186",
        date: "2025-10-10T14:25:00",
        currency: "SAR",
        description: "Ø¨ÙŠØ¹ Ø£ØµÙ„ Ø±Ù‚Ù… 37",
        lines: [
          { account: "1110 Ø£ØµÙ„ Ù…Ø¹Ø¯Ø§Øª", debit: 0, credit: 100000, note: "Ø³Ø¹Ø± Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙ„" },
          { account: "2110 Ø¶Ø±ÙŠØ¨Ø© Ù…Ø®Ø±Ø¬Ø§Øª", debit: 0, credit: 15000, note: "VAT 15%" },
          { account: "1310 Ù…Ø¬Ù…Ø¹ Ø¥Ù‡Ù„Ø§Ùƒ", debit: 20000, credit: 0, note: "ØªØ³ÙˆÙŠØ© Ù…Ø­Ø§Ø³Ø¨ÙŠØ©" },
          { account: "3110 Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø© Ø¨ÙŠØ¹ Ø£ØµÙ„", debit: 0, credit: 5000, note: "Ø±Ø¨Ø­ Ø¨ÙŠØ¹" },
          { account: "1210 Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø±ÙˆÙ‘Ø§Ø³ÙŠ", debit: 110000, credit: 0, note: "Ø·Ø±Ù Ø¹Ù…ÙŠÙ„" }
        ],
        customerGuess: { name: "Ø´Ø±ÙƒØ© Ø§Ù„Ø±ÙˆÙ‘Ø§Ø³ÙŠ", vat: "300000000000003", code: "C-001" }
      }
    ];

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø©
    State.journals = JOURNALS;

    // ===============================
    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø©
    // ===============================
    const $ = (s, ctx=document) => ctx.querySelector(s);
    const $$ = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
    const fmt = (n) => Number(n||0).toLocaleString('ar-EG',{minimumFractionDigits:2, maximumFractionDigits:2});
    const parseNum = (v) => isFinite(+v) ? +v : 0;

    function toast(msg, ms=2200){
      const box = $('#toast'); const t = $('#toastMsg');
      t.textContent = msg; box.hidden = false;
      setTimeout(()=> box.hidden = true, ms);
    }

    function setStatus(label){
      $('#statusChip').textContent = label;
    }

    // ===============================
    // mapping.js â€” ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ â†’ ÙØ§ØªÙˆØ±Ø©
    // ===============================
    const ExcludedAccounts = [/Ù…Ø¬Ù…Ø¹\s*Ø¥Ù‡Ù„Ø§Ùƒ/, /Ø±Ø¨Ø­\/Ø®Ø³Ø§Ø±Ø©/, /ØªØ³ÙˆÙŠØ©/i];
    const CustomerAccountHint = /(Ø¹Ù…Ù„Ø§Ø¡|Ø­Ø³Ø§Ø¨Ø§Øª\s*Ù…Ø¯ÙŠÙ†Ø©|AR)/i;
    const VATAccountHint = /(Ø¶Ø±ÙŠØ¨Ø©\s*Ù…Ø®Ø±Ø¬Ø§Øª|VAT)/i;

    function detectCustomerLine(lines){
      // Ø£ÙˆÙ„ Ø¨Ù†Ø¯ (Ù…Ø¯ÙŠÙ†) ÙŠØ´ÙŠØ± Ù„Ø¹Ù…Ù„Ø§Ø¡/AR
      for(const ln of lines){
        if(ln.debit>0 && CustomerAccountHint.test(ln.account)) return ln;
      }
      return null;
    }

    function detectVATTotal(lines){
      let vat = 0;
      for(const ln of lines){
        if(VATAccountHint.test(ln.account)) vat += ln.credit; // Ù…Ø®Ø±Ø¬Ø§Øª Ø¹Ø§Ø¯Ø© Ø¯Ø§Ø¦Ù†
      }
      return vat;
    }

    function isExcludedRevenueAccount(acc){
      return ExcludedAccounts.some(rx => rx.test(acc));
    }

    function journalToInvoice(j){
      // Ø®Ø·ÙˆØ· Ø§Ù„ÙØ§ØªÙˆØ±Ø© = Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø¯Ø§Ø¦Ù†Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ÙŠØ©/Ø³Ø¹Ø± Ø¨ÙŠØ¹ Ø£ØµÙ„ (ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø©)
      const invLines = [];
      const vatDetected = detectVATTotal(j.lines);

      for(const ln of j.lines){
        if(ln.credit>0 && !isExcludedRevenueAccount(ln.account)){
          invLines.push({
            description: ln.note || ln.account,
            qty: 1,
            unitPrice: ln.credit - (vatDetected?0:0), // ÙŠÙØ¹Ø¯Ù‘Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©
            vatRate: vatDetected? 15 : 15, // Ø§ÙØªØ±Ø§Ø¶ÙŠ 15%
            vatAmount: 0,
            lineTotal: 0
          });
        }
      }

      const custLn = detectCustomerLine(j.lines);
      const buyer = {
        name: j.customerGuess?.name || '',
        vat: j.customerGuess?.vat || '',
        address: '',
        code: j.customerGuess?.code || ''
      };

      const invoice = {
        id: State.nextSerial(),
        issueDate: new Date().toISOString().slice(0,16),
        currency: j.currency || 'SAR',
        lines: invLines,
        totals: { net:0, vat:0, grand:0 },
        sourceJournalId: j.id
      };

      return { buyer, invoice, custLn, vatDetected };
    }

    function recalcTotals(){
      const rows = $$('#linesBody tr');
      let net=0, vat=0, grand=0;
      rows.forEach(tr=>{
        const qty = parseNum(tr.querySelector('.qty').value);
        const price = parseNum(tr.querySelector('.price').value);
        const rate = parseNum(tr.querySelector('.rate').value);
        const lineNet = qty * price;
        const lineVAT = (lineNet * rate)/100;
        const lineTotal = lineNet + lineVAT;
        tr.querySelector('.vat').textContent = fmt(lineVAT);
        tr.querySelector('.total').textContent = fmt(lineTotal);
        net += lineNet; vat += lineVAT; grand += lineTotal;
      });
      $('#tNet').textContent = fmt(net);
      $('#tVAT').textContent = fmt(vat);
      $('#tGrand').textContent = fmt(grand);
      return {net, vat, grand};
    }

    // ===============================
    // validators.js â€” Ø§Ù„ØªØ­Ù‚Ù‚
    // ===============================
    function validate(){
      let ok = true;
      const setErr = (id, show) => { const el = $(id); if(!el) return; el.hidden = !show; if(show) ok=false; };
      setErr('#errSellerName', !$('#sellerName').value.trim());
      setErr('#errSellerVAT', !$('#sellerVAT').value.trim());
      setErr('#errBuyerName', !$('#buyerName').value.trim());
      setErr('#errIssueDate', !$('#issueDate').value);

      // Ø¹Ù…ÙŠÙ„
      const custSel = $('#customerSelect');
      setErr('#errCustomer', !custSel.value);

      // Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ØµØ§Ù„Ø­
      const rows = $$('#linesBody tr');
      let hasValid = false;
      for(const tr of rows){
        const qty = parseNum(tr.querySelector('.qty').value);
        const price = parseNum(tr.querySelector('.price').value);
        const rate = parseNum(tr.querySelector('.rate').value);
        if(qty>0 && price>=0 && rate>=0 && rate<=100){ hasValid = true; break; }
      }
      setErr('#errLines', !hasValid);

      // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª ØªØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ÙŠÙØ¹Ø§Ø¯ Ø­Ø³Ø§Ø¨Ù‡Ø§ Ù‡Ù†Ø§)
      recalcTotals();
      return ok;
    }

    function zatcaChecklist(){
      const items = [
        {label:'Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹', ok: !!$('#sellerName').value.trim()},
        {label:'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¨Ø§Ø¦Ø¹', ok: !!$('#sellerVAT').value.trim()},
        {label:'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', ok: !!$('#buyerName').value.trim()},
        {label:'ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø±', ok: !!$('#issueDate').value},
        {label:'Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØªØ³Ù„Ø³Ù„ÙŠ', ok: !!$('#invId').value},
        {label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª Ù…Ø­Ø³ÙˆØ¨Ø©', ok: recalcTotals().grand>0},
        {label:'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (Ù†Ø³Ø¨Ø©/Ù‚ÙŠÙ…Ø©)', ok: $$('#linesBody tr').length>0}
      ];
      return items;
    }

    // ===============================
    // ui.js â€” Ø§Ù„Ø±Ø¨Ø· Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    // ===============================
    function renderResults(list){
      const tb = $('#resultsBody'); tb.innerHTML = '';
      for(const j of list){
        const amt = j.lines.reduce((s,ln)=> s + ln.credit - ln.debit, 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${j.id}</td>
          <td>${new Date(j.date).toLocaleString('ar-SA')}</td>
          <td>${j.description}</td>
          <td>Ù…Ù‚ÙÙ„</td>
          <td>${fmt(amt)}</td>
          <td><button class="btn" data-id="${j.id}">Ø§Ø®ØªÙŠØ§Ø±</button></td>
        `;
        tb.appendChild(tr);
      }
      // Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø±
      tb.querySelectorAll('button.btn').forEach(btn=>{
        btn.addEventListener('click', ()=> selectJournal(btn.dataset.id));
      });
    }

    function renderJournalLines(j){
      const tb = $('#journalLines'); tb.innerHTML='';
      j.lines.forEach(ln=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ln.account}</td>
          <td>${fmt(ln.debit)}</td>
          <td>${fmt(ln.credit)}</td>
          <td>${ln.note||''}</td>
        `;
        tb.appendChild(tr);
      });
    }

    function populateCustomerOptions(j){
      const sel = $('#customerSelect'); sel.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± â€”</option>';
      // Ø§Ø³ØªØ®Ø±Ø¬ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ù…Ø¯ÙŠÙ†) + ØªØ®Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù‚ÙŠØ¯
      const candidates = [];
      for(const ln of j.lines){
        if(ln.debit>0){ candidates.push({id: ln.account, name: ln.account}); }
      }
      const guess = j.customerGuess?.name ? [{id:'guess', name:`${j.customerGuess.name} (Ø§Ù‚ØªØ±Ø§Ø­)`}] : [];
      [...guess, ...candidates].forEach(c=>{
        const opt = document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt);
      });
    }

    function renderInvoiceForm(bundle){
      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¹Ø·ÙŠØ§Øª
      $('#invId').value = bundle.invoice.id;
      $('#issueDate').value = bundle.invoice.issueDate;
      $('#invCurr').value = bundle.invoice.currency;

      // Ø¹Ù…ÙŠÙ„ Ù…Ù‚ØªØ±Ø­
      $('#buyerName').value = bundle.buyer.name||'';
      $('#buyerVAT').value = bundle.buyer.vat||'';
      $('#buyerAddr').value = bundle.buyer.address||'';
      $('#buyerCode').value = bundle.buyer.code||'';

      // Ø®Ø·ÙˆØ·
      const tb = $('#linesBody'); tb.innerHTML='';
      bundle.invoice.lines.forEach((ln, idx)=> addLineRow(ln));
      recalcTotals();
    }

    function addLineRow(ln={description:'', qty:1, unitPrice:0, vatRate:15}){
      const tb = $('#linesBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input desc" value="${ln.description||''}"/></td>
        <td><input class="input qty" type="number" min="0" step="1" value="${ln.qty||1}"></td>
        <td><input class="input price" type="number" min="0" step="0.01" value="${ln.unitPrice||0}"></td>
        <td><input class="input rate" type="number" min="0" max="100" step="0.1" value="${ln.vatRate??15}"></td>
        <td class="vat">0.00</td>
        <td class="total">0.00</td>
        <td class="no-print"><button class="btn ghost btnDel">Ø­Ø°Ù</button></td>
      `;
      tb.appendChild(tr);
      tr.querySelectorAll('input').forEach(i=> i.addEventListener('input', recalcTotals));
      tr.querySelector('.btnDel').addEventListener('click', ()=>{ tr.remove(); recalcTotals(); });
      recalcTotals();
    }

    function selectJournal(id){
      const j = State.journals.find(x=> x.id===id);
      if(!j){ toast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠØ¯'); return; }
      State.current.journal = j;
      $('#jId').value = j.id; $('#jDate').value = new Date(j.date).toLocaleString('ar-SA');
      $('#jCurr').value = j.currency; $('#jDesc').value = j.description;
      renderJournalLines(j);
      populateCustomerOptions(j);

      const bundle = journalToInvoice(j);
      State.current.invoice = bundle.invoice;
      renderInvoiceForm(bundle);

      // Ø§Ø®ØªØ± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
      $('#btnUseGuess').onclick = ()=>{
        const sel = $('#customerSelect');
        if(j.customerGuess?.name){ sel.value = 'guess'; $('#buyerName').value = j.customerGuess.name; $('#buyerVAT').value = j.customerGuess.vat||''; $('#buyerCode').value = j.customerGuess.code||''; }
      };

      toast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯.');
    }

    // QR Placeholder â€” ÙŠØ±Ø³Ù… Ù…Ø±Ø¨Ø¹Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø¨Ø³ÙŠØ·Ø© + ÙŠÙˆÙ„Ø¯ TLV Ù†ØµÙŠ Ù…Ø¨Ø³Ù‘Ø·
    function drawQRPlaceholder(text=''){
      const c = $('#qrCanvas'); const ctx = c.getContext('2d');
      const w = c.width = 120; const h = c.height = 120;
      ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = '#cbd5e1'; ctx.setLineDash([4,4]); ctx.strokeRect(2,2,w-4,h-4);
      ctx.setLineDash([]);
      // Ø´Ø¨ÙƒØ© Ù†Ù‚Ø·ÙŠØ© Ù…Ø¨Ø³Ø·Ø©
      ctx.fillStyle = '#111827';
      let seed = [...(text||'SMART-LIFE')].reduce((s,ch)=> s + ch.charCodeAt(0), 0);
      function rnd(){ seed = (seed*1664525 + 1013904223) % 4294967296; return seed/4294967296; }
      for(let y=8; y<h-8; y+=8){
        for(let x=8; x<w-8; x+=8){ if(rnd()>.72) ctx.fillRect(x,y,3,3); }
      }
    }

    function buildTLV(){
      // TLV Ù†ØµÙ‘ÙŠ (Placeholder)â€” Ù„ÙŠØ³ Ù…Ø¹ÙŠØ§Ø± ZATCA Ø§Ù„ÙØ¹Ù„ÙŠ
      const parts = {
        seller: $('#sellerName').value.trim(),
        sellerVAT: $('#sellerVAT').value.trim(),
        issue: $('#issueDate').value,
        total: $('#tGrand').textContent,
        vat: $('#tVAT').textContent
      };
      return `TLV|seller:${parts.seller}|vat:${parts.sellerVAT}|dt:${parts.issue}|total:${parts.total}|vatAmt:${parts.vat}`;
    }

    // Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    function buildPreviewHTML(){
      const inv = collectInvoiceObject();
      return `
        <div class="invoice-preview">
          <div class="invoice">
            <header>
              <div style="display:flex; gap:10px; align-items:center">
                <div class="logo">SL</div>
                <div>
                  <h1>ÙØ§ØªÙˆØ±Ø© Ø¶Ø±ÙŠØ¨ÙŠØ© (AR Invoice)</h1>
                  <div class="muted">Ø±Ù‚Ù…: ${inv.invoice.id} â€” Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(inv.invoice.issueDate).toLocaleString('ar-SA')}</div>
                </div>
              </div>
              <div class="totals">
                <div><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</strong> ${fmt(inv.invoice.totals.grand)}</div>
                <div class="muted">Ø§Ù„Ø¹Ù…Ù„Ø©: ${inv.invoice.currency}</div>
              </div>
            </header>

            <div class="grid2" style="margin-top:14px">
              <div class="box"><strong>Ø§Ù„Ø¨Ø§Ø¦Ø¹</strong><br>
                ${inv.seller.name}<br>
                VAT: ${inv.seller.vat}<br>
                ${inv.seller.address||''}
              </div>
              <div class="box"><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„</strong><br>
                ${inv.buyer.name}<br>
                ${inv.buyer.vat?`VAT: ${inv.buyer.vat}<br>`:''}
                ${inv.buyer.address||''}
              </div>
            </div>

            <div class="box" style="margin-top:14px">
              <table class="inv">
                <thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
                <tbody>
                  ${inv.invoice.lines.map(l=>`<tr>
                    <td>${l.description}</td>
                    <td>${fmt(l.qty)}</td>
                    <td>${fmt(l.unitPrice)}</td>
                    <td>${fmt(l.vatRate)}%</td>
                    <td>${fmt(l.vatAmount)}</td>
                    <td>${fmt(l.lineTotal)}</td>
                  </tr>`).join('')}
                </tbody>
              </table>
            </div>

            <div class="grid2" style="margin-top:14px">
              <div class="box">
                <div><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</strong> ${fmt(inv.invoice.totals.net)}</div>
                <div><strong>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</strong> ${fmt(inv.invoice.totals.vat)}</div>
                <div><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</strong> ${fmt(inv.invoice.totals.grand)}</div>
              </div>
              <div class="box">
                <div class="qr-row">
                  <div class="qr"></div>
                  <div class="muted" style="font-size:12px; word-break:break-all">${inv.qr}</div>
                </div>
              </div>
            </div>

            <div class="muted" style="margin-top:8px">Ø§Ù„Ù…ØµØ¯Ø±: ${inv.invoice.sourceJournalId}</div>
          </div>
        </div>
      `;
    }

    function collectInvoiceObject(){
      const lines = $$('#linesBody tr').map(tr=>{
        const desc = tr.querySelector('.desc').value.trim();
        const qty = parseNum(tr.querySelector('.qty').value);
        const unitPrice = parseNum(tr.querySelector('.price').value);
        const rate = parseNum(tr.querySelector('.rate').value);
        const net = qty*unitPrice; const vat = net*rate/100; const total = net+vat;
        return { description: desc, qty, unitPrice, vatRate: rate, vatAmount: vat, lineTotal: total };
      });
      const totals = recalcTotals();
      const obj = {
        seller:{ name: $('#sellerName').value.trim(), vat: $('#sellerVAT').value.trim(), address: $('#sellerAddr').value.trim() },
        buyer:{ name: $('#buyerName').value.trim(), vat: $('#buyerVAT').value.trim(), address: $('#buyerAddr').value.trim(), code: $('#buyerCode').value.trim() },
        invoice:{
          id: $('#invId').value,
          issueDate: $('#issueDate').value,
          currency: $('#invCurr').value.trim()||'SAR',
          lines,
          totals: { net: totals.net, vat: totals.vat, grand: totals.grand },
          sourceJournalId: $('#jId').value || (State.current.journal?.id || '')
        },
        qr: $('#qrText').value.trim() || buildTLV()
      };
      return obj;
    }

    // Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø© Ø¨Ø³ÙŠØ·Ø© ÙÙŠ localStorage
    function saveDraft(){
      const obj = collectInvoiceObject();
      localStorage.setItem('DRAFT-INVOICE', JSON.stringify(obj));
      toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§');
    }
    function loadDraft(){
      const raw = localStorage.getItem('DRAFT-INVOICE');
      if(!raw) return;
      try{
        const inv = JSON.parse(raw);
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
        $('#sellerName').value = inv.seller.name||'';
        $('#sellerVAT').value = inv.seller.vat||'';
        $('#sellerAddr').value = inv.seller.address||'';
        $('#buyerName').value = inv.buyer.name||'';
        $('#buyerVAT').value = inv.buyer.vat||'';
        $('#buyerAddr').value = inv.buyer.address||'';
        $('#buyerCode').value = inv.buyer.code||'';
        $('#invId').value = inv.invoice.id||State.nextSerial();
        $('#issueDate').value = inv.invoice.issueDate || new Date().toISOString().slice(0,16);
        $('#invCurr').value = inv.invoice.currency||'SAR';
        const tb = $('#linesBody'); tb.innerHTML='';
        inv.invoice.lines.forEach(addLineRow);
        $('#qrText').value = inv.qr||'';
        recalcTotals();
        toast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø³ÙˆØ¯Ø© Ø³Ø§Ø¨Ù‚Ø©');
      }catch{}
    }

    // ØªØµØ¯ÙŠØ± JSON
    function exportJSON(){
      const obj = collectInvoiceObject();
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${obj.invoice.id}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Ø·Ø¨Ø§Ø¹Ø© â€” Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø£ÙŠØ¶Ù‹Ø§
    function exportPDF(){ window.print(); }

    // ÙˆØ§Ø¬Ù‡Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚ ZATCA
    function showChecklist(){
      const list = zatcaChecklist();
      $('#modalTitle').textContent = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚ â€” Ø¬Ø§Ù‡Ø²ÙŠØ© ZATCA';
      const ul = document.createElement('div'); ul.className='checklist';
      list.forEach(it=>{
        const row = document.createElement('div');
        row.innerHTML = `${it.ok? 'âœ…':'âŒ'} ${it.label}`;
        ul.appendChild(row);
      });
      $('#modalBody').innerHTML=''; $('#modalBody').appendChild(ul);
      $('#modal').classList.add('show');
    }

    function showPreview(){
      $('#modalTitle').textContent = 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
      $('#modalBody').innerHTML = buildPreviewHTML();
      $('#modal').classList.add('show');
    }

    // Ø£Ø­Ø¯Ø§Ø« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function bindEvents(){
      // Ø¨Ø­Ø«
      $('#btnSearch').addEventListener('click', ()=>{
        const q = $('#searchInput').value.trim();
        const res = State.journals.filter(j=> [j.id, j.description, new Date(j.date).toLocaleString('ar-SA')].some(x=> String(x).includes(q)) );
        renderResults(res);
      });
      $('#btnReset').addEventListener('click', ()=>{ $('#searchInput').value=''; renderResults(State.journals); });

      // Ø®Ø·ÙˆØ·
      $('#btnAddLine').addEventListener('click', ()=> addLineRow());

      // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
      $('#btnZATCA').addEventListener('click', showChecklist);
      $('#btnSaveDraft').addEventListener('click', saveDraft);

      $('#btnGenerate').addEventListener('click', ()=>{
        if(!validate()){ toast('ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©'); return; }
        State.current.generated = true; setStatus('ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯');
        toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
        $('#btnPreview').disabled = false;
        $('#btnExportJSON').disabled = false;
        $('#btnExportPDF').disabled = false;
      });

      $('#btnPreview').addEventListener('click', showPreview);
      $('#btnExportPDF').addEventListener('click', exportPDF);
      $('#btnExportJSON').addEventListener('click', exportJSON);

      // QR
      $('#btnGenQR').addEventListener('click', ()=>{ const t = buildTLV(); $('#qrText').value = t; drawQRPlaceholder(t); });
      $('#btnCopyQR').addEventListener('click', async ()=>{
        try{ await navigator.clipboard.writeText($('#qrText').value); toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®'); }catch{ toast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ù†Ø³Ø®'); }
      });

      // Ù…ÙˆØ¯Ø§Ù„
      $('#btnCloseModal').addEventListener('click', ()=> $('#modal').classList.remove('show'));

      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ù‚ÙŠÙ…Ø© â€” Ø£Ø¹ÙØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
      $('#converter').addEventListener('input', (e)=>{
        if(e.target.classList.contains('input')) recalcTotals();
      });
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ©
    function init(){
      renderResults(State.journals);
      drawQRPlaceholder();
      loadDraft();
      bindEvents();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
