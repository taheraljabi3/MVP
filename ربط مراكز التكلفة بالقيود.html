<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÙØ§ØªÙˆØ±Ø© + Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© â€” ØªØ¬Ø±Ø¨Ø© ØªÙØ§Ø¹Ù„ÙŠØ©</title>
  <style>
    :root{
      --bg:#ffffff;--ink:#0f172a;--muted:#475569;--border:#e2e8f0;--row:#f8fafc;
      --blue:#2563eb;--blue-600:#1d4ed8;--green:#16a34a;--orange:#ea580c;--red:#dc2626;--violet:#7c3aed
    }
    [data-theme="dark"]{--bg:#0b1220;--ink:#e5e7eb;--muted:#9aa4b2;--border:#1f2937;--row:#0f172a}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic",Tahoma,Arial;background:var(--bg);color:var(--ink)}
    a{color:var(--blue)}
    .container{max-width:1200px;margin:0 auto;padding:1rem}
    header.site{position:sticky;top:0;z-index:40;background:var(--bg);border-bottom:1px solid var(--border);backdrop-filter:saturate(180%) blur(8px)}
    .site__bar{display:flex;gap:1rem;align-items:center;justify-content:space-between;padding:.8rem 1rem}
    .brand{display:flex;align-items:center;gap:.6rem}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--violet))}
    .brand h1{font-size:1.05rem;margin:0}

    .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab{padding:.45rem .8rem;border:1px solid var(--border);border-radius:.6rem;cursor:pointer;background:transparent}
    .tab[aria-selected="true"]{background:var(--blue);border-color:var(--blue);color:#fff}

    .card{border:1px solid var(--border);border-radius:1rem;background:var(--bg);overflow:hidden}
    .card__head{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid var(--border)}
    .card__body{padding:1rem}

    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:.4rem;padding:.5rem .8rem;border:1px solid var(--border);border-radius:.6rem;background:#fff;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.success{background:var(--green);border-color:var(--green);color:#fff}
    .btn.warn{background:#fff7ed;border-color:#fed7aa;color:var(--orange)}
    .btn.ghost{background:transparent}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .input,.select{border:1px solid var(--border);border-radius:.6rem;padding:.45rem .6rem;background:var(--bg);color:var(--ink)}
    .row{display:flex;gap:.75rem;flex-wrap:wrap}

    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.6rem;border-bottom:1px solid var(--border);vertical-align:middle}
    .table thead th{background:var(--row);font-weight:600}
    .table tfoot td{background:var(--row);font-weight:600}
    .table tr:hover td{background-color:rgba(37,99,235,.06)}
    .scroll-x{overflow-x:auto}

    .hint{font-size:.85rem;color:var(--muted)}
    .tag{font-size:.75rem;border:1px solid var(--border);padding:.1rem .35rem;border-radius:.4rem}
    .tag.inherited{background:#eef;color:#334155}
    .tag.custom{background:#fff7ed;color:#a16207}
    .tag.multi{background:#f3e8ff;color:#6d28d9}

    .cc-picker{position:relative;min-width:260px}
    .cc-input{width:100%;border:1px solid var(--border);border-radius:.6rem;padding:.45rem .6rem}
    .cc-dropdown{position:absolute;inset-inline:0;top:calc(100% + .25rem);border:1px solid var(--border);border-radius:.6rem;background:var(--bg);box-shadow:0 14px 32px rgba(0,0,0,.08);max-height:260px;overflow:auto;z-index:20}
    .cc-option{display:flex;align-items:center;gap:.5rem;padding:.45rem .6rem;cursor:pointer}
    .cc-option[aria-selected="true"],.cc-option:hover{background:rgba(37,99,235,.08)}
    .cc-code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;color:var(--muted)}
    .cc-footer{position:sticky;bottom:0;background:var(--row);border-top:1px solid var(--border);padding:.4rem .6rem}

    .modal[hidden]{display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:100}
    .modal__panel{width:min(920px,96vw);background:var(--bg);border:1px solid var(--border);border-radius:1rem;overflow:hidden}
    .modal-header,.modal-footer{padding:1rem;border-bottom:1px solid var(--border)}
    .modal-footer{border-top:1px solid var(--border);border-bottom:none;display:flex;gap:.5rem;flex-wrap:wrap}
    .modal-body{padding:1rem}

    @media (max-width:760px){.hide-sm{display:none}.lines-cards{display:grid;grid-template-columns:1fr;gap:.6rem}}
    @media print{header.site,.no-print{display:none!important}.card{border:none}}
  </style>
</head>
<body>
  <header class="site">
    <div class="site__bar container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>ÙØ§ØªÙˆØ±Ø© + Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</h1>
      </div>
      <div class="toolbar no-print">
        <button id="themeToggle" class="btn" aria-pressed="false">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>
        <nav class="tabs" role="tablist">
          <button class="tab" role="tab" aria-selected="true" data-tab="invoice">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="journal">ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ (Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² ÙÙ‚Ø·)</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="reports">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="container" id="app">

    <!-- ============ Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ============ -->
    <section id="panel-invoice" role="tabpanel">
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:end">
            <div>
              <label class="hint">Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
              <input id="cust" class="input" placeholder="Ø§Ø³Ù…/ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„" />
            </div>
            <div>
              <label class="hint">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="invDate" type="date" class="input" />
            </div>
            <div class="cc-picker" style="min-width:320px">
              <label class="hint">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©)</label>
              <input id="cc-head" class="cc-input" placeholder="Ø§Ø¨Ø­Ø« ÙˆØ§Ø®ØªØ± Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©" />
              <div id="cc-head-list" class="cc-dropdown" hidden></div>
            </div>
            <button id="btnApplyHead" class="btn" title="ØªÙˆØ±ÙŠØ« Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙˆØ±ÙˆØ«Ø© ÙÙ‚Ø·">â†ªï¸ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
            <button id="btnHeadAlloc" class="btn" title="ØªÙˆØ²ÙŠØ¹ Ù…ØªØ¹Ø¯Ø¯ Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ù…Ø³ØªÙ†Ø¯">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø£Ø³</button>
          </div>
          <div class="toolbar">
            <button id="btnAddLine" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
            <button id="btnImportLines" class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†ÙˆØ¯ CSV</button>
            <button id="btnClearLines" class="btn danger">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
            <span class="hint">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙˆØ±ÙˆØ«Ø© ØªØ±Ø« Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© Ù…Ù† Ø§Ù„Ø±Ø£Ø³ Ø­ØªÙ‰ Ø£ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„.</span>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table class="table" id="linesTable">
              <thead>
                <tr>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†Ø¯)</th>
                  <th>ØªÙˆØ²ÙŠØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th class="hide-sm">Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="3">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</td>
                  <td id="subTotal">0.00</td>
                  <td colspan="4"></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="row" style="justify-content:space-between;align-items:center;margin-top:.8rem">
            <div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯: <b id="docAlloc">â€”</b></div>
            <div class="toolbar">
              <button id="btnValidate" class="btn warn">âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
              <button id="btnSaveDraft" class="btn">ğŸ’¾ Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©</button>
              <button id="btnPost" class="btn success">ğŸš€ ØªØ±Ø­ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ (Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² ÙÙ‚Ø·) ============ -->
    <section id="panel-journal" role="tabpanel" hidden>
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:end">
            <div>
              <label class="hint">Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</label>
              <input id="jvNumber" class="input" placeholder="Ù…Ø«Ø§Ù„: JV-2025-00123" />
            </div>
            <button id="btnLoadJV" class="btn">ğŸ” ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯</button>
            <span class="hint">Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø§Ø´Ø© ØªØ³Ù…Ø­ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© ÙÙ‚Ø· Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ø£Ø±ØµØ¯Ø©.</span>
          </div>
          <div class="toolbar">
            <button id="btnJVHeadCC" class="btn">ğŸ“Œ ØªØ¹ÙŠÙŠÙ† Ù…Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚ÙŠØ¯</button>
            <button id="btnApplyJVHead" class="btn">â†ªï¸ ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
            <button id="btnJVValidate" class="btn warn">âœ… ØªØ­Ù‚Ù‚</button>
            <button id="btnJVCommit" class="btn success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø·</button>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table class="table" id="jvLines">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ù…Ø¯ÙŠÙ†</th>
                  <th>Ø¯Ø§Ø¦Ù†</th>
                  <th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                  <th>ØªÙˆØ²ÙŠØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙˆØ²ÙŠØ¹ ============ -->
    <section id="panel-reports" role="tabpanel" hidden>
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:center">
            <div class="cc-picker">
              <label class="hint">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©</label>
              <input id="reportCC" class="cc-input" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²/Ù…Ø±Ø§ÙƒØ²" />
              <div id="reportCCList" class="cc-dropdown" hidden></div>
            </div>
            <input id="dateFrom" class="input" type="date" />
            <input id="dateTo" class="input" type="date" />
            <button id="btnRunReport" class="btn primary">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
            <button id="btnExportCSV" class="btn">ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table class="table" id="reportTable">
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© (Ù…Ù„Ø®Øµ)</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Ù†Ø§ÙØ°Ø© ØªÙˆØ²ÙŠØ¹ -->
  <div id="allocModal" class="modal" hidden>
    <div class="modal__panel">
      <div class="modal-header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="allocTitle">ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</h3>
          <button id="allocClose" class="btn ghost">âœ–</button>
        </div>
        <div class="hint">Ø§Ù…Ù„Ø£ Ø§Ù„Ù†ÙØ³ÙØ¨ (%) Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ 100% Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ø¯.</div>
      </div>
      <div class="modal-body">
        <table class="table" id="allocTable">
          <thead><tr><th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th><th style="width:120px">%</th><th style="width:160px">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th style="width:80px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:.6rem">
          <span class="hint">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨: <b id="sumPct">0%</b></span>
          <span class="hint">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ…: <b id="sumVal">0.00</b></span>
          <span id="allocError" class="hint" style="color:var(--red)"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="allocAdd" class="btn">â• Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
        <button id="allocSave" class="btn primary" disabled>Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
      </div>
    </div>
  </div>

  <template id="lineRowTpl">
    <tr>
      <td><input class="input desc" placeholder="ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯" /></td>
      <td><input class="input qty" type="number" min="0" step="0.01" value="1" /></td>
      <td><input class="input price" type="number" min="0" step="0.01" value="0" /></td>
      <td class="amount">0.00</td>
      <td>
        <div class="cc-picker">
          <input class="cc-input line-cc" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²" />
          <div class="cc-dropdown" hidden></div>
        </div>
      </td>
      <td><button class="btn allocBtn">ğŸ“Š ØªÙˆØ²ÙŠØ¹</button></td>
      <td class="state"><span class="tag inherited">Ù…ÙˆØ±ÙˆØ«</span></td>
      <td class="hide-sm"><button class="btn danger delLine">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
    </tr>
  </template>

  <template id="allocRowTpl">
    <tr>
      <td>
        <div class="cc-picker">
          <input class="cc-input alloc-cc" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²" />
          <div class="cc-dropdown" hidden></div>
        </div>
      </td>
      <td><input class="input pct" type="number" min="0" max="100" step="0.01"></td>
      <td><input class="input val" type="number" min="0" step="0.01"></td>
      <td><button class="btn danger removeAlloc">Ø­Ø°Ù</button></td>
    </tr>
  </template>

  <script>
    // ===== Theme & Tabs =====
    const $ = (s,root=document)=>root.querySelector(s); const $$=(s,root=document)=>[...root.querySelectorAll(s)];
    const state = {
      theme: localStorage.getItem('theme')||'light',
      headCC:null, headHeadAlloc:[],
      lines:[],
      allocCtx:null, // {target: 'line'|'head'|'jv-line', id, total, rows:[]}
      jv:{ loaded:false, headCC:null, lines:[] },
      centers: Array.from({length:200}, (_,i)=>({ id:`CC-${String(i+1).padStart(4,'0')}`, name:`Ù…Ø±ÙƒØ² ${i+1}`, active: i%9!==0 }))
    };
    function applyTheme(){
      document.documentElement.setAttribute('data-theme', state.theme==='dark'?'dark':'light');
      const btn=$('#themeToggle'); btn.textContent = state.theme==='dark'? 'â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
      btn.setAttribute('aria-pressed', state.theme==='dark');
    }
    $('#themeToggle').addEventListener('click',()=>{ state.theme= state.theme==='dark'?'light':'dark'; localStorage.setItem('theme',state.theme); applyTheme(); });
    applyTheme();

    $$('.tab').forEach(b=>b.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.setAttribute('aria-selected','false')); b.setAttribute('aria-selected','true');
      const key=b.dataset.tab; $('#panel-invoice').hidden = key!=='invoice'; $('#panel-journal').hidden = key!=='journal'; $('#panel-reports').hidden = key!=='reports';
    }));

    // ===== Helpers =====
    const fmtMoney = x=> Number(x||0).toFixed(2);
    function lineAmount(tr){ const q=Number($('.qty',tr).value||0), p=Number($('.price',tr).value||0); return q*p; }

    // ===== Cost Center Picker (generic) =====
    function attachPicker(input,{onPick}={}){
      const wrap=input.closest('.cc-picker'); const list=$('.cc-dropdown',wrap);
      function render(q=''){
        const rows = state.centers.filter(c=> (c.active) && (c.id.toLowerCase().includes(q)||c.name.includes(q)) ).slice(0,30);
        list.innerHTML = rows.map((c,i)=>`<div class="cc-option" role="option" data-id="${c.id}" data-name="${c.name}"><span class="cc-code">${c.id}</span> ${c.name}</div>`).join('');
        list.hidden=false;
      }
      input.addEventListener('input',()=>render(input.value.trim().toLowerCase()));
      input.addEventListener('focus',()=>render(''));
      document.addEventListener('click',e=>{ if(!wrap.contains(e.target)) list.hidden=true; });
      list.addEventListener('click',e=>{
        const opt=e.target.closest('.cc-option'); if(!opt) return; input.value=`${opt.dataset.id} â€” ${opt.dataset.name}`; list.hidden=true; onPick && onPick({id:opt.dataset.id,name:opt.dataset.name});
      });
    }

    // ===== Invoice Lines =====
    const linesBody = $('#linesTable tbody');
    function addLine(data={}){
      const tpl=$('#lineRowTpl').content.firstElementChild.cloneNode(true); const tr=tpl;
      $('.desc',tr).value = data.desc||''; $('.qty',tr).value = data.qty||1; $('.price',tr).value = data.price||0;
      $('.amount',tr).textContent = fmtMoney(lineAmount(tr));
      // picker per line
      attachPicker($('.line-cc',tr),{onPick:(cc)=>{ tr.dataset.cc = JSON.stringify(cc); $('.state',tr).innerHTML='<span class="tag custom">Ù…Ø®ØµØµ</span>'; }});
      // handlers
      ['input','change'].forEach(ev=>{
        $('.qty',tr).addEventListener(ev,()=>{ $('.amount',tr).textContent=fmtMoney(lineAmount(tr)); renderTotals(); });
        $('.price',tr).addEventListener(ev,()=>{ $('.amount',tr).textContent=fmtMoney(lineAmount(tr)); renderTotals(); });
      });
      $('.delLine',tr).addEventListener('click',()=>{ tr.remove(); renderTotals(); });
      $('.allocBtn',tr).addEventListener('click',()=>openAllocForLine(tr));
      linesBody.appendChild(tr); renderTotals();
    }
    function renderTotals(){
      let sub=0; const allocMap=new Map();
      $$('#linesTable tbody tr').forEach(tr=>{
        const amt=lineAmount(tr); sub+=amt;
        const alloc=JSON.parse(tr.dataset.alloc||'[]');
        if(alloc.length){ alloc.forEach(a=> allocMap.set(a.cc_id,(allocMap.get(a.cc_id)||0)+Number(a.value||0)) ); }
        else if(tr.dataset.cc){ const cc=JSON.parse(tr.dataset.cc); allocMap.set(cc.id,(allocMap.get(cc.id)||0)+amt); }
        else if(state.headCC){ allocMap.set(state.headCC.id,(allocMap.get(state.headCC.id)||0)+amt); }
      });
      $('#subTotal').textContent=fmtMoney(sub);
      const parts=[...allocMap.entries()].map(([id,v])=>`${id}: ${fmtMoney(v)}`);
      $('#docAlloc').textContent = parts.length? parts.join(' | ') : 'â€”';
    }

    $('#btnAddLine').addEventListener('click',()=>addLine());
    $('#btnClearLines').addEventListener('click',()=>{ linesBody.innerHTML=''; renderTotals(); });

    // Head CC & distribution
    attachPicker($('#cc-head'),{onPick:(cc)=>{ state.headCC=cc; }});
    $('#btnApplyHead').addEventListener('click',()=>{
      $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !(tr.dataset.alloc)){ $('.state',tr).innerHTML='<span class="tag inherited">Ù…ÙˆØ±ÙˆØ«</span>'; });
      renderTotals();
    });

    // ===== Allocation Modal (line/head) =====
    function openAllocForLine(tr){
      const total=lineAmount(tr); const rows=JSON.parse(tr.dataset.alloc||'[]');
      state.allocCtx={ target:'line', id:tr, total, rows };
      openAllocModal(rows,total,'ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ø¨Ù†Ø¯');
    }
    function openAllocForHead(){
      // Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙŠ Ù„Ø§ ØªÙ…Ù„Ùƒ CC Ù…Ø®ØµØµ
      let total=0; $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !(tr.dataset.alloc)) total+=lineAmount(tr); });
      state.allocCtx={ target:'head', id:null, total, rows: state.headHeadAlloc||[] };
      openAllocModal(state.headHeadAlloc||[], total, 'ØªÙˆØ²ÙŠØ¹ Ù…Ù† Ø±Ø£Ø³ Ø§Ù„Ù…Ø³ØªÙ†Ø¯');
    }
    $('#btnHeadAlloc').addEventListener('click', openAllocForHead);

    function openAllocModal(rows,total,title){
      $('#allocTitle').textContent=title; const tbody=$('#allocTable tbody'); tbody.innerHTML='';
      if(!rows.length) rows=[{cc_id:null,percent:null,value:null}];
      rows.forEach(r=>addAllocRow(r));
      $('#allocModal').hidden=false; recalcAlloc(total);
    }
    function closeAlloc(){ $('#allocModal').hidden=true; }
    $('#allocClose').addEventListener('click',closeAlloc);

    function addAllocRow(r={}){
      const tr=$('#allocRowTpl').content.firstElementChild.cloneNode(true);
      if(r.cc_id) $('.alloc-cc',tr).value=r.cc_id; if(r.percent!=null) $('.pct',tr).value=r.percent; if(r.value!=null) $('.val',tr).value=r.value;
      attachPicker($('.alloc-cc',tr),{onPick:(cc)=>{ $('.alloc-cc',tr).value=cc.id; recalcAlloc(state.allocCtx.total); }});
      $('.pct',tr).addEventListener('input',()=>{ const p=Number($('.pct',tr).value||0); $('.val',tr).value=(p/100)*state.allocCtx.total; recalcAlloc(state.allocCtx.total); })
      $('.val',tr).addEventListener('input',()=>{ const v=Number($('.val',tr).value||0); $('.pct',tr).value= state.allocCtx.total? (v/state.allocCtx.total)*100 : 0; recalcAlloc(state.allocCtx.total); })
      $('.removeAlloc',tr).addEventListener('click',()=>{ tr.remove(); recalcAlloc(state.allocCtx.total); })
      $('#allocTable tbody').appendChild(tr);
    }
    $('#allocAdd').addEventListener('click',()=>addAllocRow({}));

    function recalcAlloc(total){
      let p=0,v=0; const rows=[]; let ok=false; let neg=false;
      $$('#allocTable tbody tr').forEach(tr=>{
        const cc=$('.alloc-cc',tr).value.trim(); const pct=Number($('.pct',tr).value||0); const val=Number($('.val',tr).value||0);
        if(pct<0||val<0) neg=true; p+=pct; v+=val; if(cc) rows.push({cc_id:cc,percent: pct||null,value: val||null});
      });
      $('#sumPct').textContent=`${p.toFixed(2)}%`; $('#sumVal').textContent=v.toFixed(2);
      ok = (!neg) && (Math.abs(p-100)<=0.01 || Math.abs(v-total)<=0.01) && rows.length>0;
      $('#allocError').textContent = neg? 'Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø©.' : (!ok? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­ â€” ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ 100% Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ø¯.':'' );
      $('#allocSave').disabled=!ok; state.allocCtx.rows=rows; state.allocCtx.valid=ok;
    }

    $('#allocSave').addEventListener('click',()=>{
      if(!state.allocCtx?.valid) return; const rows=state.allocCtx.rows; const total=state.allocCtx.total;
      const normalized = rows.map(r=>({ cc_id:r.cc_id, percent: r.percent!=null? Number(r.percent): (r.value!=null? (Number(r.value)/total)*100: null), value: r.value!=null? Number(r.value): (r.percent!=null? (Number(r.percent)/100)*total: null) }));
      if(state.allocCtx.target==='line'){
        const tr=state.allocCtx.id; tr.dataset.alloc = JSON.stringify(normalized); delete tr.dataset.cc; $('.state',tr).innerHTML='<span class="tag multi">Ù…ØªØ¹Ø¯Ø¯</span>';
      }else if(state.allocCtx.target==='head'){
        state.headHeadAlloc = normalized;
        // Ø·Ø¨Ù‘Ù‚ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙˆØ±ÙˆØ«Ø©
        $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !(tr.dataset.alloc)){ tr.dataset.alloc = JSON.stringify(normalized.map(a=>({cc_id:a.cc_id,percent:a.percent,value:(a.percent/100)*lineAmount(tr)}))); $('.state',tr).innerHTML='<span class="tag multi">Ù…ØªØ¹Ø¯Ø¯</span>'; } });
      } else if(state.allocCtx.target==='jv-line'){
        const idx=state.allocCtx.id; state.jv.lines[idx].alloc = normalized; renderJVLines();
      }
      closeAlloc(); renderTotals();
    });

    // Validate & Save & Post (Demo)
    $('#btnValidate').addEventListener('click',()=>{
      const ok = $$('#linesTable tbody tr').length>0; alert(ok? 'âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§ÙƒÙ„ ÙˆØ§Ø¶Ø­Ø© ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹.' : 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø¨Ù†ÙˆØ¯.');
    });
    $('#btnSaveDraft').addEventListener('click',()=>{ alert('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© (Ù…Ø­Ø§ÙƒØ§Ø©).'); });
    $('#btnPost').addEventListener('click',()=>{ alert('ğŸš€ ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø­Ø§ÙƒØ§Ø©).'); });

    // ===== JV: Rebind cost centers only =====
    $('#btnLoadJV').addEventListener('click',()=>{
      const no=$('#jvNumber').value.trim(); if(!no) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯');
      // Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©
      state.jv.loaded=true; state.jv.headCC=null; state.jv.lines=[
        {acc:'110101-Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡', debit:1000, credit:0, cc:null, alloc:[]},
        {acc:'410100-Ø¥ÙŠØ±Ø§Ø¯Ø§Øª', debit:0, credit:1000, cc:null, alloc:[]},
      ];
      renderJVLines();
    });
    function renderJVLines(){
      const tb=$('#jvLines tbody'); tb.innerHTML='';
      state.jv.lines.forEach((ln,i)=>{
        const tr=document.createElement('tr'); tr.innerHTML=`
          <td>${i+1}</td>
          <td>${ln.acc}</td>
          <td>${fmtMoney(ln.debit)}</td>
          <td>${fmtMoney(ln.credit)}</td>
          <td><div class="cc-picker"><input class="cc-input jv-cc" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²" value="${ln.cc? ln.cc.id+' â€” '+ln.cc.name:''}"><div class="cc-dropdown" hidden></div></div></td>
          <td><button class="btn jv-alloc">ğŸ“Š ØªÙˆØ²ÙŠØ¹</button></td>
          <td>${ln.alloc?.length? '<span class="tag multi">Ù…ØªØ¹Ø¯Ø¯</span>': (ln.cc? '<span class="tag custom">Ù…Ø®ØµØµ</span>':'<span class="tag inherited">â€”</span>')}</td>`;
        tb.appendChild(tr);
        // pickers
        attachPicker($('.jv-cc',tr),{onPick:(cc)=>{ state.jv.lines[i].cc=cc; state.jv.lines[i].alloc=[]; renderJVLines(); }});
        $('.jv-alloc',tr).addEventListener('click',()=>{
          const total=(Number(ln.debit)||0)+(Number(ln.credit)||0); state.allocCtx={ target:'jv-line', id:i, total, rows: ln.alloc||[] }; openAllocModal(state.allocCtx.rows,total,`ØªÙˆØ²ÙŠØ¹ Ù„Ù„Ø¨Ù†Ø¯ #${i+1}`);
        });
      });
    }
    $('#btnJVHeadCC').addEventListener('click',()=>{
      const ccInput = document.createElement('input'); ccInput.className='cc-input'; ccInput.placeholder='Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²';
      const wrap=document.createElement('div'); wrap.className='cc-picker'; wrap.appendChild(ccInput); const modal=document.createElement('div');
      attachPicker(ccInput,{onPick:(cc)=>{ state.jv.headCC=cc; document.body.removeChild(modal); renderJVLines(); }});
      modal.className='modal'; modal.appendChild(Object.assign(document.createElement('div'),{className:'modal__panel',innerHTML:`<div class="modal-header"><h3>ØªØ¹ÙŠÙŠÙ† Ù…Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚ÙŠØ¯</h3></div><div class="modal-body"></div>`}));
      modal.querySelector('.modal-body').appendChild(wrap); document.body.appendChild(modal);
      modal.addEventListener('click',e=>{ if(e.target===modal) document.body.removeChild(modal); });
    });
    $('#btnApplyJVHead').addEventListener('click',()=>{
      if(!state.jv.headCC) return alert('Ø§Ø®ØªØ± Ù…Ø±ÙƒØ² Ø£ÙˆÙ„Ù‹Ø§');
      state.jv.lines.forEach(ln=>{ if(!ln.cc && !(ln.alloc?.length)) ln.cc=state.jv.headCC; }); renderJVLines();
    });
    $('#btnJVValidate').addEventListener('click',()=>{ alert('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§ØªØŒ ÙÙ‚Ø· Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©.'); });
    $('#btnJVCommit').addEventListener('click',()=>{ alert('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø· (Ù…Ø­Ø§ÙƒØ§Ø©).'); });

    // ===== Reports (mock) =====
    attachPicker($('#reportCC'),{onPick:(cc)=>{ $('#reportCC').dataset.selected = ( ($('#reportCC').dataset.selected||'') + ',' + cc.id ).replace(/^,/,''); }});
    $('#btnRunReport').addEventListener('click',()=>{
      const tb=$('#reportTable tbody'); tb.innerHTML='';
      // ØªÙˆÙ„ÙŠØ¯ ØµÙÙˆÙ Ù…Ù† Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙƒØ¹Ø±Ø¶ ØªÙˆØ¶ÙŠØ­ÙŠ
      $$('#linesTable tbody tr').forEach((tr,i)=>{
        const amount=lineAmount(tr);
        const list = tr.dataset.alloc? JSON.parse(tr.dataset.alloc).map(a=>a.cc_id).join('+') : (tr.dataset.cc? JSON.parse(tr.dataset.cc).id : (state.headCC? state.headCC.id : 'â€”'));
        const row=document.createElement('tr'); row.innerHTML=`<td>${1000+i}</td><td>${$('#invDate').value||new Date().toISOString().slice(0,10)}</td><td>${list}</td><td>${fmtMoney(amount)}</td>`; tb.appendChild(row);
      });
    });
    $('#btnExportCSV').addEventListener('click',()=>{
      const rows = [['DocNo','Date','CCs','Amount']].concat($$('#reportTable tbody tr').map(tr=>[...tr.children].map(td=>td.textContent.trim())));
      const csv = rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='cc-report.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    // Quick demo data
    addLine({desc:'Ø®Ø¯Ù…Ø© Ø§Ø³ØªØ´Ø§Ø±Ø©', qty:2, price:150});
    addLine({desc:'ØµÙŠØ§Ù†Ø© Ø´Ù‡Ø±ÙŠØ©', qty:1, price:300});
  </script>
</body>
</html>
