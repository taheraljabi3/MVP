<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© + Ø±Ø¨Ø· Ø´Ø§Ù…Ù„ Ø¨Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</title>
  <style>
    :root{
      --bg:#ffffff;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--row:#f8fafc;
      --blue:#2563eb;--blue-600:#1d4ed8;--green:#059669;--amber:#b45309;--red:#b91c1c;--violet:#7c3aed
    }
    [data-theme="dark"]{--bg:#0b1220;--ink:#e5e7eb;--muted:#9aa4b2;--border:#1f2937;--row:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic",Tahoma,Arial}
    a{color:var(--blue);text-decoration:none}
    .container{max-width:1440px;margin:0 auto;padding:1rem}
    header.site{position:sticky;top:0;z-index:50;border-bottom:1px solid var(--border);background:var(--bg);backdrop-filter:saturate(180%) blur(6px)}
    .site__bar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.75rem 1rem}
    .brand{display:flex;align-items:center;gap:.6rem}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--violet))}
    h1{font-size:1rem;margin:0}
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap}
    .tab{padding:.5rem .9rem;border:1px solid var(--border);border-radius:.6rem;background:transparent;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--blue);color:#fff;border-color:var(--blue)}

    section{margin-top:1rem}
    .grid{display:grid;gap:1rem}
    @media(min-width:1000px){.grid.cols-2{grid-template-columns:1.2fr .8fr}}

    .card{border:1px solid var(--border);border-radius:1rem;background:var(--bg);overflow:hidden}
    .card__head{padding:1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    .card__body{padding:1rem}

    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .row{display:flex;gap:.6rem;flex-wrap:wrap}

    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .9rem;border:1px solid var(--border);border-radius:.7rem;background:#fff;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.success{background:#e6fff2;border-color:#baf7d1;color:#065f46}
    .btn.warn{background:#fff7ed;border-color:#fed7aa;color:var(--amber)}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .input,.select,.textarea{border:1px solid var(--border);border-radius:.6rem;padding:.5rem .6rem;background:var(--bg);color:var(--ink)}
    .textarea{min-height:88px;width:100%;resize:vertical}
    .hint{font-size:.85rem;color:var(--muted)}

    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.6rem;border-bottom:1px solid var(--border);vertical-align:middle}
    .table thead th{background:var(--row);font-weight:600}
    .table tr:hover td{background:rgba(37,99,235,.06)}
    .scroll-x{overflow-x:auto}

    .tag{font-size:.8rem;padding:.12rem .45rem;border-radius:.4rem;border:1px solid var(--border)}
    .tag.inherited{background:#eef;color:#334155}
    .tag.custom{background:#edfdf6;color:#065f46}
    .tag.multi{background:#f3e8ff;color:#6d28d9}

    .cc-picker{position:relative;min-width:280px}
    .cc-input{width:100%;border:1px solid var(--border);border-radius:.6rem;padding:.5rem .6rem}
    .cc-dropdown{position:absolute;inset-inline:0;top:calc(100% + .25rem);border:1px solid var(--border);border-radius:.6rem;background:var(--bg);box-shadow:0 10px 30px rgba(0,0,0,.08);max-height:280px;overflow:auto}
    .cc-option{padding:.45rem .6rem;cursor:pointer}
    .cc-option:hover{background:rgba(37,99,235,.08)}

    .modal[hidden]{display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:200}
    .modal__panel{width:min(980px,96vw);background:var(--bg);border:1px solid var(--border);border-radius:1rem;overflow:hidden}
    .modal-header,.modal-footer{padding:1rem;border-bottom:1px solid var(--border)}
    .modal-footer{border-top:1px solid var(--border);border-bottom:none;display:flex;gap:.5rem;flex-wrap:wrap}
    .modal-body{padding:1rem}

    .alloc-table{width:100%;border-collapse:separate;border-spacing:0}
    .alloc-table th,.alloc-table td{padding:.5rem;border-bottom:1px solid var(--border)}

    .policy{display:grid;gap:.5rem;grid-template-columns:220px 1fr}
    @media(max-width:760px){.policy{grid-template-columns:1fr}}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#f1f5f9;border:1px solid var(--border);border-radius:.4rem;padding:.1rem .35rem}

    @media print{header.site,.no-print{display:none !important};body{background:#fff;color:#000}.card{border:none}}
  </style>
</head>
<body>
  <header class="site">
    <div class="site__bar container">
      <div class="brand"><div class="logo" aria-hidden="true"></div><h1>ÙØ§ØªÙˆØ±Ø© + Ù…Ø±Ø§ÙƒØ² ØªÙƒÙ„ÙØ© â€” ØªØ¬Ø±Ø¨Ø© ÙƒØ§Ù…Ù„Ø©</h1></div>
      <div class="row no-print">
        <button id="themeToggle" class="btn" aria-pressed="false">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>
        <nav class="tabs" role="tablist">
          <button class="tab" data-tab="invoice" aria-selected="true">Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</button>
          <button class="tab" data-tab="journal" aria-selected="false">ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ (Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² ÙÙ‚Ø·)</button>
          <button class="tab" data-tab="reports" aria-selected="false">ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- ================== Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø© ================== -->
    <section id="panel-invoice" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <div class="card__head">
            <div class="row" style="align-items:end">
              <div>
                <label class="hint">Ø§Ù„Ø¹Ù…ÙŠÙ„</label><br>
                <input id="custName" class="input" placeholder="Ø§Ø®ØªØ±/Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„" style="min-width:280px" />
              </div>
              <div>
                <label class="hint">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><br>
                <input id="invDate" class="input" type="date" />
              </div>
              <div class="cc-picker">
                <label class="hint">Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ© (Ø±Ø£Ø³ Ø§Ù„ÙØ§ØªÙˆØ±Ø©)</label><br>
                <input id="cc-head" class="cc-input" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²Ù‹Ø§" aria-autocomplete="list" />
                <div class="cc-dropdown" hidden></div>
              </div>
              <div>
                <label class="hint">Ø³ÙŠØ§Ø³Ø© Ø±Ø¨Ø· Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</label><br>
                <select id="policy-cust" class="select">
                  <option value="head">ÙŠØ±Ø« Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø£Ø³</option>
                  <option value="by-lines">ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ù†Ø³Ø¨ Ø§Ù„Ø¨Ù†ÙˆØ¯</option>
                </select>
              </div>
            </div>
            <div class="toolbar">
              <button id="btnApplyHead" class="btn">ØªØ·Ø¨ÙŠÙ‚ Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø£Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
              <button id="btnHeadAlloc" class="btn">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø£Ø³ (Ù…ØªØ¹Ø¯Ø¯)</button>
              <span class="hint">Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙˆØ±ÙˆØ«Ø© ØªÙØ¸Ù‡Ø± <span class="tag inherited">Ù…ÙˆØ±ÙˆØ«</span></span>
            </div>
          </div>
          <div class="card__body">
            <div class="scroll-x">
              <table id="linesTable" class="table">
                <thead>
                  <tr>
                    <th style="width:28px">#</th>
                    <th>Ø§Ù„ÙˆØµÙ</th>
                    <th style="width:120px">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="width:140px">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th style="width:140px">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th style="min-width:280px">Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© (Ø¨Ù†Ø¯)</th>
                    <th style="width:120px">ØªÙˆØ²ÙŠØ¹</th>
                    <th style="width:120px">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th style="width:80px"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="toolbar" style="margin-top:.75rem">
              <button id="btnAddLine" class="btn primary">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
              <button id="btnClearLines" class="btn danger">ğŸ—‘ï¸ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨Ù†ÙˆØ¯</button>
              <span class="hint">Ø´ØºÙ‘Ù„ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ù„Ø¨Ù†Ø¯ Ù„Ù‚Ø³Ù…Ø© Ù‚ÙŠÙ…ØªÙ‡ Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ù…Ø±Ø§ÙƒØ² ØªÙƒÙ„ÙØ©.</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card__head">
            <strong>Ù…Ù„Ø®Ù‘Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</strong>
            <div class="toolbar">
              <button id="btnValidate" class="btn">âœ… ØªØ­Ù‚Ù‚</button>
              <button id="btnSaveDraft" class="btn">ğŸ’¾ Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø©</button>
              <button id="btnPost" class="btn primary">ğŸš€ ØªØ±Ø­ÙŠÙ„</button>
            </div>
          </div>
          <div class="card__body">
            <div class="row">
              <div style="min-width:180px">
                <div class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</div>
                <div id="subTotal" style="font-size:1.25rem;font-weight:700">0.00</div>
              </div>
              <div style="min-width:180px">
                <div class="hint">Ø¶Ø±ÙŠØ¨Ø© (Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© 15% Ø³Ø·Ø±ÙŠØ©)</div>
                <div id="taxTotal" style="font-size:1.25rem;font-weight:700">0.00</div>
              </div>
              <div style="min-width:180px">
                <div class="hint">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
                <div id="grandTotal" style="font-size:1.25rem;font-weight:700">0.00</div>
              </div>
            </div>
            <hr style="border:0;border-top:1px dashed var(--border);margin:1rem 0">
            <div class="row" style="align-items:end">
              <div class="cc-picker" style="min-width:280px">
                <label class="hint">Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ© (Ù‚ÙŠØ¯ Ø§Ù„Ø¯ÙØ¹)</label><br>
                <input id="cc-payment" class="cc-input" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
                <div class="cc-dropdown" hidden></div>
              </div>
              <div>
                <label class="hint">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><br>
                <select id="payMethod" class="select">
                  <option>Ù†Ù‚Ø¯Ù‹Ø§</option>
                  <option>ØªØ­ÙˆÙŠÙ„</option>
                  <option>Ù…Ø¯Ù‰</option>
                  <option>Ø´ÙŠÙƒ</option>
                </select>
              </div>
              <div>
                <label class="hint">Ø¯ÙØ¹Ø© Ø§Ù„Ø¢Ù†</label><br>
                <input id="payNow" class="input" type="number" min="0" step="0.01" value="0" />
              </div>
            </div>
            <div class="hint" style="margin-top:.5rem">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø§ÙƒØ²: <span id="docAlloc">â€”</span></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:1rem">
        <div class="card__head"><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</strong></div>
        <div class="card__body">
          <p class="hint">â€” Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø¨Ù„Ø§ Ù…Ø±ÙƒØ² â†’ ØªØ±Ø« Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø£Ø³ Ø£Ùˆ ØªÙˆØ²ÙŠØ¹Ù‡.
            <br>â€” Ø®ØµÙ…/Ø¶Ø±ÙŠØ¨Ø© Ø³Ø·Ø±ÙŠØ© â†’ ØªØªØ¨Ø¹ ØªÙˆØ²ÙŠØ¹ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø±. Ø®ØµÙ…/Ø¶Ø±ÙŠØ¨Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© â†’ ØªØªØ¨Ø¹ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø±Ø£Ø³.
            <br>â€” Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù…Ù‘Ø§ ÙŠØ±Ø« Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø£Ø³ Ø£Ùˆ ÙŠØªØ¬Ù‘Ù…Ø¹ Ø­Ø³Ø¨ Ù†Ø³Ø¨ Ø§Ù„Ø¨Ù†ÙˆØ¯ (Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©).</p>
        </div>
      </div>
    </section>

    <!-- ================== ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ (Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² ÙÙ‚Ø·) ================== -->
    <section id="panel-journal" role="tabpanel" hidden>
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:end">
            <div>
              <label class="hint">Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</label><br>
              <input id="jvNumber" class="input" placeholder="Ù…Ø«Ø§Ù„: JV-2025-00123" />
            </div>
            <button id="btnLoadJV" class="btn">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯</button>
            <button id="btnJVHeadCC" class="btn">ØªØ¹ÙŠÙŠÙ† Ù…Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚ÙŠØ¯</button>
            <button id="btnApplyJVHead" class="btn">ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„ÙØ§Ø±ØºØ©</button>
          </div>
          <div class="toolbar">
            <button id="btnJVValidate" class="btn">âœ… ØªØ­Ù‚Ù‚</button>
            <button id="btnJVCommit" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø·</button>
            <span class="hint">Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹ Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ù…Ø¨Ø§Ù„Øºâ€”ÙÙ‚Ø· Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©.</span>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table id="jvLines" class="table">
              <thead>
                <tr>
                  <th>#</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th><th>Ù…Ø±ÙƒØ²</th><th>ØªÙˆØ²ÙŠØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ================== ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„ ================== -->
    <section id="panel-reports" role="tabpanel" hidden>
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:end">
            <div class="cc-picker">
              <label class="hint">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ© (Ù…ØªØ¹Ø¯Ø¯)</label><br>
              <input id="reportCC" class="cc-input" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²Ù‹Ø§" />
              <div class="cc-dropdown" hidden></div>
            </div>
            <div>
              <label class="hint">Ù…Ù† ØªØ§Ø±ÙŠØ®</label><br>
              <input id="rFrom" class="input" type="date" />
            </div>
            <div>
              <label class="hint">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><br>
              <input id="rTo" class="input" type="date" />
            </div>
            <button id="btnRunReport" class="btn primary">ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button id="btnExportCSV" class="btn">ØªØµØ¯ÙŠØ± CSV</button>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table id="reportTable" class="table">
              <thead>
                <tr>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ============== Ù†Ø§ÙØ°Ø© ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© ============== -->
  <div id="allocModal" class="modal" hidden>
    <div class="modal__panel">
      <div class="modal-header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="allocTitle">ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</h3>
          <button id="allocClose" class="btn ghost">âœ–</button>
        </div>
        <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ <span class="kbd">%</span> Ø£Ùˆ <span class="kbd">Ø§Ù„Ù‚ÙŠÙ…Ø©</span>â€”Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠØ­Ø³Ø¨ Ø§Ù„Ø£Ø®Ø±Ù‰ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
          ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ 100% Ø£Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ø¯.</div>
      </div>
      <div class="modal-body">
        <table id="allocTable" class="alloc-table">
          <thead><tr><th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th><th style="width:120px">%</th><th style="width:160px">Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th style="width:80px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:.6rem">
          <span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†ÙØ³ÙØ¨: <b id="sumPct">0%</b></span>
          <span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù‚ÙŠÙ…: <b id="sumVal">0.00</b></span>
          <span id="allocError" class="hint" style="color:var(--red)"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="allocAdd" class="btn">â• Ø¥Ø¶Ø§ÙØ© ØµÙ</button>
        <button id="allocSave" class="btn primary" disabled>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
      </div>
    </div>
  </div>

  <!-- Ù‚ÙˆØ§Ù„Ø¨ ØµÙÙˆÙ -->
  <template id="lineRowTpl">
    <tr>
      <td class="rowIndex">#</td>
      <td><input class="input desc" placeholder="ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø¯"></td>
      <td><input class="input qty" type="number" min="0" step="0.001" value="1"></td>
      <td><input class="input price" type="number" min="0" step="0.01" value="0"></td>
      <td class="amount">0.00</td>
      <td>
        <div class="cc-picker"><input class="cc-input line-cc" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²Ù‹Ø§"><div class="cc-dropdown" hidden></div></div>
      </td>
      <td><button class="btn allocBtn">ğŸ“Š ØªÙˆØ²ÙŠØ¹</button></td>
      <td class="state"><span class="tag inherited">Ù…ÙˆØ±ÙˆØ«</span></td>
      <td><button class="btn danger delLine">Ø­Ø°Ù</button></td>
    </tr>
  </template>

  <template id="allocRowTpl">
    <tr>
      <td>
        <div class="cc-picker"><input class="cc-input alloc-cc" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²Ù‹Ø§"><div class="cc-dropdown" hidden></div></div>
      </td>
      <td><input class="input pct" type="number" min="0" max="100" step="0.01"></td>
      <td><input class="input val" type="number" min="0" step="0.01"></td>
      <td><button class="btn danger removeAlloc">Ø­Ø°Ù</button></td>
    </tr>
  </template>

  <script>
  window.addEventListener('DOMContentLoaded',()=>{
    // ===== Helpers =====
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>[...r.querySelectorAll(s)];
    const money = n=> Number(n||0).toFixed(2);

    // ===== State =====
    const state={
      theme: localStorage.getItem('theme')||'light',
      centers: Array.from({length:500},(_,i)=>({id:`CC-${String(i+1).padStart(4,'0')}`,name:`Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ© ${i+1}`,active:i%7!==0})),
      headCC:null,
      headAlloc:[], // [{cc_id,percent,value}]
      lines:[], // runtime only (DOM is source of truth)
      allocCtx:null, // {target:'line'|'head'|'jv-line', id, total, rows}
      jv:{headCC:null,lines:[]}
    };

    // ===== Theme & Tabs =====
    function applyTheme(){document.documentElement.setAttribute('data-theme',state.theme==='dark'?'dark':'light');const t=$('#themeToggle'); if(t){t.textContent=state.theme==='dark'?'â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­':'ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';t.setAttribute('aria-pressed',state.theme==='dark');}}
    $('#themeToggle')?.addEventListener('click',()=>{state.theme=state.theme==='dark'?'light':'dark';localStorage.setItem('theme',state.theme);applyTheme();});
    applyTheme();

    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tab').forEach(b=>b.setAttribute('aria-selected','false')); btn.setAttribute('aria-selected','true');
      const key=btn.dataset.tab; $('#panel-invoice').hidden = key!=='invoice'; $('#panel-journal').hidden = key!=='journal'; $('#panel-reports').hidden = key!=='reports';
    }));

    // ===== Cost Center Picker =====
    function attachPicker(input,{onPick}={}){
      if(!input) return; const wrap=input.closest('.cc-picker'); if(!wrap) return; const list=wrap.querySelector('.cc-dropdown');
      function render(q=''){
        const rows=state.centers.filter(c=>c.active && (c.id.toLowerCase().includes(q)||c.name.includes(q))).slice(0,40);
        list.innerHTML=rows.map(c=>`<div class="cc-option" data-id="${c.id}" data-name="${c.name}"><span class="tag">${c.id}</span> ${c.name}</div>`).join('');
        list.hidden=false;
      }
      input.addEventListener('input',()=>render(input.value.trim().toLowerCase()));
      input.addEventListener('focus',()=>render(''));
      document.addEventListener('click',e=>{ if(!wrap.contains(e.target)) list.hidden=true; });
      list.addEventListener('click',e=>{const opt=e.target.closest('.cc-option'); if(!opt) return; input.value=`${opt.dataset.id} â€” ${opt.dataset.name}`; list.hidden=true; onPick&&onPick({id:opt.dataset.id,name:opt.dataset.name});});
    }

    attachPicker($('#cc-head'),{onPick:(cc)=>{ state.headCC=cc; }});
    attachPicker($('#cc-payment'),{onPick:(cc)=>{ $('#cc-payment').dataset.selected = cc.id; }});

    // ===== Lines Table =====
    const linesBody = $('#linesTable tbody');
    function lineAmount(tr){ const q=Number($('.qty',tr).value||0), p=Number($('.price',tr).value||0); return q*p; }
    function reindex(){ $$('#linesTable tbody tr').forEach((tr,i)=>$('.rowIndex',tr).textContent=i+1); }

    function addLineRow(data={}){
      const tpl=$('#lineRowTpl'); const tr=tpl.content.firstElementChild.cloneNode(true);
      $('.desc',tr).value = data.desc||''; $('.qty',tr).value = data.qty||1; $('.price',tr).value = data.price||0; $('.amount',tr).textContent = money(lineAmount(tr));
      attachPicker($('.line-cc',tr),{onPick:(cc)=>{ tr.dataset.cc = JSON.stringify(cc); tr.dataset.alloc=''; $('.state',tr).innerHTML='<span class="tag custom">Ù…Ø®ØµØµ</span>'; renderTotals(); }});
      ['input','change'].forEach(ev=>{
        $('.qty',tr).addEventListener(ev,()=>{ $('.amount',tr).textContent = money(lineAmount(tr)); renderTotals(); });
        $('.price',tr).addEventListener(ev,()=>{ $('.amount',tr).textContent = money(lineAmount(tr)); renderTotals(); });
      });
      $('.allocBtn',tr).addEventListener('click',()=> openAllocForLine(tr));
      $('.delLine',tr).addEventListener('click',()=>{ tr.remove(); reindex(); renderTotals(); });
      linesBody.appendChild(tr); reindex(); renderTotals();
    }

    $('#btnAddLine')?.addEventListener('click',()=>addLineRow());
    $('#btnClearLines')?.addEventListener('click',()=>{ linesBody.innerHTML=''; renderTotals(); });

    // ØªØ·Ø¨ÙŠÙ‚ Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø£Ø³ Ù…ÙˆØ±ÙˆØ«
    $('#btnApplyHead')?.addEventListener('click',()=>{
      if(!state.headCC) return alert('Ø§Ø®ØªØ± Ù…Ø±ÙƒØ² Ø±Ø£Ø³ Ø£ÙˆÙ„Ù‹Ø§');
      $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !tr.dataset.alloc){ $('.state',tr).innerHTML='<span class="tag inherited">Ù…ÙˆØ±ÙˆØ«</span>'; }});
      renderTotals();
    });

    // ===== Allocation Modal =====
    const allocModal = $('#allocModal'); const allocBody = $('#allocTable tbody');
    function openAllocForLine(tr){ const total=lineAmount(tr); const rows = tr.dataset.alloc? JSON.parse(tr.dataset.alloc) : []; state.allocCtx={target:'line', id:tr, total, rows}; openAllocModal(rows,total,'ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ø¨Ù†Ø¯'); }
    function openAllocForHead(){ let total=0; $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !tr.dataset.alloc) total += lineAmount(tr); }); state.allocCtx={target:'head', id:null, total, rows: state.headAlloc||[]}; openAllocModal(state.headAlloc||[], total, 'ØªÙˆØ²ÙŠØ¹ Ù…Ù† Ø±Ø£Ø³ Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); }
    $('#btnHeadAlloc')?.addEventListener('click', openAllocForHead);

    function openAllocModal(rows,total,title){ $('#allocTitle').textContent=title; allocBody.innerHTML=''; if(!rows.length) rows=[{cc_id:null,percent:null,value:null}]; rows.forEach(r=>addAllocRow(r)); allocModal.hidden=false; recalcAlloc(total); }
    function closeAlloc(){ allocModal.hidden=true; }
    $('#allocClose')?.addEventListener('click',closeAlloc); allocModal.addEventListener('click',e=>{ if(e.target===allocModal) closeAlloc(); });

    function addAllocRow(r={}){
      const tpl=$('#allocRowTpl'); const tr=tpl.content.firstElementChild.cloneNode(true);
      if(r.cc_id) $('.alloc-cc',tr).value=r.cc_id; if(r.percent!=null) $('.pct',tr).value=r.percent; if(r.value!=null) $('.val',tr).value=r.value;
      attachPicker($('.alloc-cc',tr),{onPick:(cc)=>{ $('.alloc-cc',tr).value=cc.id; recalcAlloc(state.allocCtx.total); }});
      $('.pct',tr).addEventListener('input',()=>{ const p=Number($('.pct',tr).value||0); $('.val',tr).value=(p/100)*(state.allocCtx.total||0); recalcAlloc(state.allocCtx.total); });
      $('.val',tr).addEventListener('input',()=>{ const v=Number($('.val',tr).value||0); $('.pct',tr).value = state.allocCtx.total? (v/state.allocCtx.total)*100 : 0; recalcAlloc(state.allocCtx.total); });
      $('.removeAlloc',tr).addEventListener('click',()=>{ tr.remove(); recalcAlloc(state.allocCtx.total); });
      allocBody.appendChild(tr);
    }
    $('#allocAdd')?.addEventListener('click',()=>addAllocRow({}));

    function recalcAlloc(total){ let p=0,v=0; const rows=[]; let neg=false; $$('#allocTable tbody tr').forEach(tr=>{ const cc=$('.alloc-cc',tr).value.trim(); const pct=Number($('.pct',tr).value||0); const val=Number($('.val',tr).value||0); if(pct<0||val<0) neg=true; p+=pct; v+=val; if(cc) rows.push({cc_id:cc,percent:pct||null,value:val||null}); });
      $('#sumPct').textContent = `${p.toFixed(2)}%`; $('#sumVal').textContent = money(v);
      const okTotals = (Math.abs(p-100)<=0.01 || Math.abs(v-(total||0))<=0.01); const ok = !neg && okTotals && rows.length>0; $('#allocError').textContent = neg? 'Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ù‚ÙŠÙ… Ø³Ø§Ù„Ø¨Ø©.' : (ok? '' : 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØºÙŠØ± ØµØ­ÙŠØ­ â€” Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø³Ø¨=100% Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ…=Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†Ø¯.'); $('#allocSave').disabled=!ok; state.allocCtx.rows=rows; state.allocCtx.valid=ok; }

    $('#allocSave')?.addEventListener('click',()=>{
      if(!state.allocCtx?.valid) return; const rows=state.allocCtx.rows; const total=state.allocCtx.total||0;
      const normalized = rows.map(r=>({ cc_id:r.cc_id, percent: r.percent!=null? Number(r.percent): (r.value!=null? (Number(r.value)/total)*100: null), value: r.value!=null? Number(r.value): (r.percent!=null? (Number(r.percent)/100)*total: null) }));
      if(state.allocCtx.target==='line'){
        const tr=state.allocCtx.id; tr.dataset.alloc = JSON.stringify(normalized); tr.dataset.cc=''; $('.state',tr).innerHTML='<span class="tag multi">Ù…ØªØ¹Ø¯Ø¯</span>';
      } else if(state.allocCtx.target==='head'){
        state.headAlloc = normalized;
        // Ø·Ø¨Ù‘Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…ÙˆØ±ÙˆØ«Ø© ÙÙ‚Ø·
        $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !tr.dataset.alloc){ const amt=lineAmount(tr); const rows2 = normalized.map(a=>({cc_id:a.cc_id,percent:a.percent,value:(a.percent/100)*amt})); tr.dataset.alloc = JSON.stringify(rows2); $('.state',tr).innerHTML='<span class="tag multi">Ù…ØªØ¹Ø¯Ø¯</span>'; } });
      } else if(state.allocCtx.target==='jv-line'){
        const idx=state.allocCtx.id; state.jv.lines[idx].alloc = normalized; renderJV();
      }
      closeAlloc(); renderTotals();
    });

    // ===== Totals & Tax (demo 15%) =====
    function renderTotals(){ let sub=0, tax=0; const allocMap=new Map();
      $$('#linesTable tbody tr').forEach(tr=>{
        const amt=lineAmount(tr); sub+=amt; tax += amt*0.15; // Ø¶Ø±ÙŠØ¨Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        if(tr.dataset.alloc){ JSON.parse(tr.dataset.alloc).forEach(a=> allocMap.set(a.cc_id,(allocMap.get(a.cc_id)||0)+Number(a.value||0)) ); }
        else if(tr.dataset.cc){ const cc=JSON.parse(tr.dataset.cc); allocMap.set(cc.id,(allocMap.get(cc.id)||0)+amt); }
        else if(state.headCC){ allocMap.set(state.headCC.id,(allocMap.get(state.headCC.id)||0)+amt); }
      });
      $('#subTotal').textContent = money(sub); $('#taxTotal').textContent = money(tax); $('#grandTotal').textContent = money(sub+tax);
      const parts=[...allocMap.entries()].map(([id,v])=>`${id}: ${money(v)}`); $('#docAlloc').textContent = parts.length? parts.join(' | '):'â€”';
    }

    // ===== Actions =====
    $('#btnValidate')?.addEventListener('click',()=>{ const ok = $$('#linesTable tbody tr').length>0; alert(ok? 'âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø­ÙØ¸/Ø§Ù„ØªØ±Ø­ÙŠÙ„.': 'Ø£Ø¶Ù Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); });
    $('#btnSaveDraft')?.addEventListener('click',()=>alert('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ù…Ø³ÙˆØ¯Ø© (Ù…Ø­Ø§ÙƒØ§Ø©).'));
    $('#btnPost')?.addEventListener('click',()=>alert('ğŸš€ ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ø­Ø§ÙƒØ§Ø©).'));

    // ===== JV: Ø±Ø¨Ø· Ù…Ø±Ø§ÙƒØ² ÙÙ‚Ø· =====
    $('#btnLoadJV')?.addEventListener('click',()=>{ const no=$('#jvNumber').value.trim(); if(!no) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯'); state.jv.lines=[ {acc:'110101-Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡',debit:1000,credit:0,cc:null,alloc:[]}, {acc:'410100-Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',debit:0,credit:1000,cc:null,alloc:[]} ]; renderJV(); });
    function renderJV(){ const tb=$('#jvLines tbody'); tb.innerHTML=''; state.jv.lines.forEach((ln,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${ln.acc}</td><td>${money(ln.debit)}</td><td>${money(ln.credit)}</td><td><div class="cc-picker"><input class="cc-input jv-cc" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²" value="${ln.cc? ln.cc.id+' â€” '+ln.cc.name:''}"><div class="cc-dropdown" hidden></div></div></td><td><button class="btn jv-alloc">ğŸ“Š ØªÙˆØ²ÙŠØ¹</button></td><td>${ln.alloc?.length? '<span class="tag multi">Ù…ØªØ¹Ø¯Ø¯</span>': (ln.cc? '<span class="tag custom">Ù…Ø®ØµØµ</span>':'<span class="tag inherited">â€”</span>')}</td>`; tb.appendChild(tr); attachPicker($('.jv-cc',tr),{onPick:(cc)=>{ state.jv.lines[i].cc=cc; state.jv.lines[i].alloc=[]; renderJV(); }}); $('.jv-alloc',tr).addEventListener('click',()=>{ const total=(Number(ln.debit)||0)+(Number(ln.credit)||0); state.allocCtx={target:'jv-line',id:i,total,rows:ln.alloc||[]}; openAllocModal(state.allocCtx.rows,total,`ØªÙˆØ²ÙŠØ¹ Ù„Ù„Ø¨Ù†Ø¯ #${i+1}`); }); }); }
    $('#btnJVHeadCC')?.addEventListener('click',()=>{ const temp=document.createElement('div'); temp.className='modal'; temp.innerHTML=`<div class="modal__panel"><div class="modal-header"><h3>Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚ÙŠØ¯</h3></div><div class="modal-body"><div class="cc-picker"><input id="tmpJVHead" class="cc-input" placeholder="Ø§Ø®ØªØ± Ù…Ø±ÙƒØ²"><div class="cc-dropdown" hidden></div></div></div></div>`; document.body.appendChild(temp); attachPicker($('#tmpJVHead'),{onPick:(cc)=>{ state.jv.headCC=cc; document.body.removeChild(temp); renderJV(); }}); temp.addEventListener('click',e=>{ if(e.target===temp) document.body.removeChild(temp); }); });
    $('#btnApplyJVHead')?.addEventListener('click',()=>{ if(!state.jv.headCC) return alert('Ø§Ø®ØªØ± Ù…Ø±ÙƒØ² Ø£ÙˆÙ„Ù‹Ø§'); state.jv.lines.forEach(ln=>{ if(!ln.cc && !(ln.alloc?.length)) ln.cc = state.jv.headCC; }); renderJV(); });
    $('#btnJVValidate')?.addEventListener('click',()=>alert('âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù†Ø§Ø¬Ø­: ØªØ¹Ø¯ÙŠÙ„ Ù…Ø±Ø§ÙƒØ² ÙÙ‚Ø·.'));
    $('#btnJVCommit')?.addEventListener('click',()=>alert('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø· (Ù…Ø­Ø§ÙƒØ§Ø©).'));

    // ===== Reports =====
    attachPicker($('#reportCC'),{onPick:(cc)=>{ const inp=$('#reportCC'); inp.dataset.selected = ((inp.dataset.selected||'')+','+cc.id).replace(/^,/, ''); }});
    $('#btnRunReport')?.addEventListener('click',()=>{ const tb=$('#reportTable tbody'); tb.innerHTML=''; $$('#linesTable tbody tr').forEach((tr,i)=>{ const amount=lineAmount(tr); const list = tr.dataset.alloc? JSON.parse(tr.dataset.alloc).map(a=>a.cc_id).join('+') : (tr.dataset.cc? JSON.parse(tr.dataset.cc).id : (state.headCC? state.headCC.id : 'â€”')); const row=document.createElement('tr'); row.innerHTML=`<td>${1000+i}</td><td>${$('#invDate').value||new Date().toISOString().slice(0,10)}</td><td>${list}</td><td>${money(amount)}</td>`; tb.appendChild(row); }); });
    $('#btnExportCSV')?.addEventListener('click',()=>{ const tb=$('#reportTable tbody'); const rows=[["DocNo","Date","CCs","Amount"]].concat($$('tr',tb).map(tr=>[...tr.children].map(td=>td.textContent.trim()))); const csv=rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='cc-report.csv'; a.click(); URL.revokeObjectURL(a.href); });

    // ===== Seed some demo lines =====
    $('#invDate').value = new Date().toISOString().slice(0,10);
    addLineRow({desc:'Ù…Ù†ØªØ¬ A',qty:2,price:150});
    addLineRow({desc:'Ø®Ø¯Ù…Ø© B',qty:1,price:300});
  });
  </script>
</body>
</html>
