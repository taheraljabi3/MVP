<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إنشاء فاتورة + ربط شامل بمراكز التكلفة</title>
  <style>
    :root{
      --bg:#ffffff;--ink:#0f172a;--muted:#64748b;--border:#e2e8f0;--row:#f8fafc;
      --blue:#2563eb;--blue-600:#1d4ed8;--green:#059669;--amber:#b45309;--red:#b91c1c;--violet:#7c3aed
    }
    [data-theme="dark"]{--bg:#0b1220;--ink:#e5e7eb;--muted:#9aa4b2;--border:#1f2937;--row:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic",Tahoma,Arial}
    a{color:var(--blue);text-decoration:none}
    .container{max-width:1440px;margin:0 auto;padding:1rem}
    header.site{position:sticky;top:0;z-index:50;border-bottom:1px solid var(--border);background:var(--bg);backdrop-filter:saturate(180%) blur(6px)}
    .site__bar{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:.75rem 1rem}
    .brand{display:flex;align-items:center;gap:.6rem}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--violet))}
    h1{font-size:1rem;margin:0}
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap}
    .tab{padding:.5rem .9rem;border:1px solid var(--border);border-radius:.6rem;background:transparent;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--blue);color:#fff;border-color:var(--blue)}

    section{margin-top:1rem}
    .grid{display:grid;gap:1rem}
    @media(min-width:1000px){.grid.cols-2{grid-template-columns:1.2fr .8fr}}

    .card{border:1px solid var(--border);border-radius:1rem;background:var(--bg);overflow:hidden}
    .card__head{padding:1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap}
    .card__body{padding:1rem}

    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .row{display:flex;gap:.6rem;flex-wrap:wrap}

    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .9rem;border:1px solid var(--border);border-radius:.7rem;background:#fff;color:var(--ink);cursor:pointer}
    .btn.primary{background:var(--blue);border-color:var(--blue);color:#fff}
    .btn.success{background:#e6fff2;border-color:#baf7d1;color:#065f46}
    .btn.warn{background:#fff7ed;border-color:#fed7aa;color:var(--amber)}
    .btn.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .input,.select,.textarea{border:1px solid var(--border);border-radius:.6rem;padding:.5rem .6rem;background:var(--bg);color:var(--ink)}
    .textarea{min-height:88px;width:100%;resize:vertical}
    .hint{font-size:.85rem;color:var(--muted)}

    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.6rem;border-bottom:1px solid var(--border);vertical-align:middle}
    .table thead th{background:var(--row);font-weight:600}
    .table tr:hover td{background:rgba(37,99,235,.06)}
    .scroll-x{overflow-x:auto}

    .tag{font-size:.8rem;padding:.12rem .45rem;border-radius:.4rem;border:1px solid var(--border)}
    .tag.inherited{background:#eef;color:#334155}
    .tag.custom{background:#edfdf6;color:#065f46}
    .tag.multi{background:#f3e8ff;color:#6d28d9}

    .cc-picker{position:relative;min-width:280px}
    .cc-input{width:100%;border:1px solid var(--border);border-radius:.6rem;padding:.5rem .6rem}
    .cc-dropdown{position:absolute;inset-inline:0;top:calc(100% + .25rem);border:1px solid var(--border);border-radius:.6rem;background:var(--bg);box-shadow:0 10px 30px rgba(0,0,0,.08);max-height:280px;overflow:auto}
    .cc-option{padding:.45rem .6rem;cursor:pointer}
    .cc-option:hover{background:rgba(37,99,235,.08)}

    .modal[hidden]{display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:1rem;z-index:200}
    .modal__panel{width:min(980px,96vw);background:var(--bg);border:1px solid var(--border);border-radius:1rem;overflow:hidden}
    .modal-header,.modal-footer{padding:1rem;border-bottom:1px solid var(--border)}
    .modal-footer{border-top:1px solid var(--border);border-bottom:none;display:flex;gap:.5rem;flex-wrap:wrap}
    .modal-body{padding:1rem}

    .alloc-table{width:100%;border-collapse:separate;border-spacing:0}
    .alloc-table th,.alloc-table td{padding:.5rem;border-bottom:1px solid var(--border)}

    .policy{display:grid;gap:.5rem;grid-template-columns:220px 1fr}
    @media(max-width:760px){.policy{grid-template-columns:1fr}}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#f1f5f9;border:1px solid var(--border);border-radius:.4rem;padding:.1rem .35rem}

    @media print{header.site,.no-print{display:none !important};body{background:#fff;color:#000}.card{border:none}}
  </style>
</head>
<body>
  <header class="site">
    <div class="site__bar container">
      <div class="brand"><div class="logo" aria-hidden="true"></div><h1>فاتورة + مراكز تكلفة — تجربة كاملة</h1></div>
      <div class="row no-print">
        <button id="themeToggle" class="btn" aria-pressed="false">🌙 الوضع الداكن</button>
        <nav class="tabs" role="tablist">
          <button class="tab" data-tab="invoice" aria-selected="true">إنشاء فاتورة</button>
          <button class="tab" data-tab="journal" aria-selected="false">تعديل قيد (ربط مراكز فقط)</button>
          <button class="tab" data-tab="reports" aria-selected="false">تقارير وتحليل</button>
        </nav>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- ================== إنشاء فاتورة ================== -->
    <section id="panel-invoice" role="tabpanel">
      <div class="grid cols-2">
        <div class="card">
          <div class="card__head">
            <div class="row" style="align-items:end">
              <div>
                <label class="hint">العميل</label><br>
                <input id="custName" class="input" placeholder="اختر/أدخل العميل" style="min-width:280px" />
              </div>
              <div>
                <label class="hint">تاريخ الفاتورة</label><br>
                <input id="invDate" class="input" type="date" />
              </div>
              <div class="cc-picker">
                <label class="hint">مركز تكلفة (رأس الفاتورة)</label><br>
                <input id="cc-head" class="cc-input" placeholder="اختر مركزًا" aria-autocomplete="list" />
                <div class="cc-dropdown" hidden></div>
              </div>
              <div>
                <label class="hint">سياسة ربط حساب العميل</label><br>
                <select id="policy-cust" class="select">
                  <option value="head">يرث مركز الرأس</option>
                  <option value="by-lines">تجميع حسب نسب البنود</option>
                </select>
              </div>
            </div>
            <div class="toolbar">
              <button id="btnApplyHead" class="btn">تطبيق مركز الرأس على البنود</button>
              <button id="btnHeadAlloc" class="btn">📊 توزيع الرأس (متعدد)</button>
              <span class="hint">البنود الموروثة تُظهر <span class="tag inherited">موروث</span></span>
            </div>
          </div>
          <div class="card__body">
            <div class="scroll-x">
              <table id="linesTable" class="table">
                <thead>
                  <tr>
                    <th style="width:28px">#</th>
                    <th>الوصف</th>
                    <th style="width:120px">الكمية</th>
                    <th style="width:140px">السعر</th>
                    <th style="width:140px">الإجمالي</th>
                    <th style="min-width:280px">مركز التكلفة (بند)</th>
                    <th style="width:120px">توزيع</th>
                    <th style="width:120px">الحالة</th>
                    <th style="width:80px"></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="toolbar" style="margin-top:.75rem">
              <button id="btnAddLine" class="btn primary">➕ إضافة بند</button>
              <button id="btnClearLines" class="btn danger">🗑️ حذف كل البنود</button>
              <span class="hint">شغّل التوزيع للبند لقسمة قيمته على عدة مراكز تكلفة.</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card__head">
            <strong>ملخّص الفاتورة</strong>
            <div class="toolbar">
              <button id="btnValidate" class="btn">✅ تحقق</button>
              <button id="btnSaveDraft" class="btn">💾 حفظ مسودة</button>
              <button id="btnPost" class="btn primary">🚀 ترحيل</button>
            </div>
          </div>
          <div class="card__body">
            <div class="row">
              <div style="min-width:180px">
                <div class="hint">إجمالي قبل الضريبة</div>
                <div id="subTotal" style="font-size:1.25rem;font-weight:700">0.00</div>
              </div>
              <div style="min-width:180px">
                <div class="hint">ضريبة (اختبارية 15% سطرية)</div>
                <div id="taxTotal" style="font-size:1.25rem;font-weight:700">0.00</div>
              </div>
              <div style="min-width:180px">
                <div class="hint">الإجمالي</div>
                <div id="grandTotal" style="font-size:1.25rem;font-weight:700">0.00</div>
              </div>
            </div>
            <hr style="border:0;border-top:1px dashed var(--border);margin:1rem 0">
            <div class="row" style="align-items:end">
              <div class="cc-picker" style="min-width:280px">
                <label class="hint">مركز تكلفة (قيد الدفع)</label><br>
                <input id="cc-payment" class="cc-input" placeholder="(اختياري)" />
                <div class="cc-dropdown" hidden></div>
              </div>
              <div>
                <label class="hint">طريقة الدفع</label><br>
                <select id="payMethod" class="select">
                  <option>نقدًا</option>
                  <option>تحويل</option>
                  <option>مدى</option>
                  <option>شيك</option>
                </select>
              </div>
              <div>
                <label class="hint">دفعة الآن</label><br>
                <input id="payNow" class="input" type="number" min="0" step="0.01" value="0" />
              </div>
            </div>
            <div class="hint" style="margin-top:.5rem">توزيع المستند الإجمالي حسب المراكز: <span id="docAlloc">—</span></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:1rem">
        <div class="card__head"><strong>ملاحظات</strong></div>
        <div class="card__body">
          <p class="hint">— البنود بلا مركز → ترث مركز الرأس أو توزيعه.
            <br>— خصم/ضريبة سطرية → تتبع توزيع نفس السطر. خصم/ضريبة إجمالية → تتبع توزيع الرأس.
            <br>— حساب العميل إمّا يرث مركز الرأس أو يتجّمع حسب نسب البنود (حسب السياسة المختارة).</p>
        </div>
      </div>
    </section>

    <!-- ================== تعديل قيد (ربط مراكز فقط) ================== -->
    <section id="panel-journal" role="tabpanel" hidden>
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:end">
            <div>
              <label class="hint">رقم القيد</label><br>
              <input id="jvNumber" class="input" placeholder="مثال: JV-2025-00123" />
            </div>
            <button id="btnLoadJV" class="btn">تحميل القيد</button>
            <button id="btnJVHeadCC" class="btn">تعيين مركز على مستوى القيد</button>
            <button id="btnApplyJVHead" class="btn">تطبيقه على البنود الفارغة</button>
          </div>
          <div class="toolbar">
            <button id="btnJVValidate" class="btn">✅ تحقق</button>
            <button id="btnJVCommit" class="btn primary">💾 حفظ الربط</button>
            <span class="hint">هذا الوضع لا يغيّر الحسابات أو المبالغ—فقط مراكز التكلفة.</span>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table id="jvLines" class="table">
              <thead>
                <tr>
                  <th>#</th><th>الحساب</th><th>مدين</th><th>دائن</th><th>مركز</th><th>توزيع</th><th>الحالة</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- ================== تقارير وتحليل ================== -->
    <section id="panel-reports" role="tabpanel" hidden>
      <div class="card">
        <div class="card__head">
          <div class="row" style="align-items:end">
            <div class="cc-picker">
              <label class="hint">فلترة حسب مركز تكلفة (متعدد)</label><br>
              <input id="reportCC" class="cc-input" placeholder="اختر مركزًا" />
              <div class="cc-dropdown" hidden></div>
            </div>
            <div>
              <label class="hint">من تاريخ</label><br>
              <input id="rFrom" class="input" type="date" />
            </div>
            <div>
              <label class="hint">إلى تاريخ</label><br>
              <input id="rTo" class="input" type="date" />
            </div>
            <button id="btnRunReport" class="btn primary">تشغيل التقرير</button>
            <button id="btnExportCSV" class="btn">تصدير CSV</button>
          </div>
        </div>
        <div class="card__body">
          <div class="scroll-x">
            <table id="reportTable" class="table">
              <thead>
                <tr>
                  <th>رقم المستند</th>
                  <th>التاريخ</th>
                  <th>مراكز التكلفة</th>
                  <th>المبلغ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- ============== نافذة توزيع مراكز التكلفة ============== -->
  <div id="allocModal" class="modal" hidden>
    <div class="modal__panel">
      <div class="modal-header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="allocTitle">توزيع مراكز التكلفة</h3>
          <button id="allocClose" class="btn ghost">✖</button>
        </div>
        <div class="hint">يمكنك إدخال <span class="kbd">%</span> أو <span class="kbd">القيمة</span>—البرنامج يحسب الأخرى تلقائيًا.
          يجب أن يساوي مجموع النسب 100% أو مجموع القيم إجمالي البند.</div>
      </div>
      <div class="modal-body">
        <table id="allocTable" class="alloc-table">
          <thead><tr><th>مركز التكلفة</th><th style="width:120px">%</th><th style="width:160px">القيمة</th><th style="width:80px"></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:.6rem">
          <span>مجموع النِسَب: <b id="sumPct">0%</b></span>
          <span>مجموع القيم: <b id="sumVal">0.00</b></span>
          <span id="allocError" class="hint" style="color:var(--red)"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="allocAdd" class="btn">➕ إضافة صف</button>
        <button id="allocSave" class="btn primary" disabled>💾 حفظ التوزيع</button>
      </div>
    </div>
  </div>

  <!-- قوالب صفوف -->
  <template id="lineRowTpl">
    <tr>
      <td class="rowIndex">#</td>
      <td><input class="input desc" placeholder="وصف البند"></td>
      <td><input class="input qty" type="number" min="0" step="0.001" value="1"></td>
      <td><input class="input price" type="number" min="0" step="0.01" value="0"></td>
      <td class="amount">0.00</td>
      <td>
        <div class="cc-picker"><input class="cc-input line-cc" placeholder="اختر مركزًا"><div class="cc-dropdown" hidden></div></div>
      </td>
      <td><button class="btn allocBtn">📊 توزيع</button></td>
      <td class="state"><span class="tag inherited">موروث</span></td>
      <td><button class="btn danger delLine">حذف</button></td>
    </tr>
  </template>

  <template id="allocRowTpl">
    <tr>
      <td>
        <div class="cc-picker"><input class="cc-input alloc-cc" placeholder="اختر مركزًا"><div class="cc-dropdown" hidden></div></div>
      </td>
      <td><input class="input pct" type="number" min="0" max="100" step="0.01"></td>
      <td><input class="input val" type="number" min="0" step="0.01"></td>
      <td><button class="btn danger removeAlloc">حذف</button></td>
    </tr>
  </template>

  <script>
  window.addEventListener('DOMContentLoaded',()=>{
    // ===== Helpers =====
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>[...r.querySelectorAll(s)];
    const money = n=> Number(n||0).toFixed(2);

    // ===== State =====
    const state={
      theme: localStorage.getItem('theme')||'light',
      centers: Array.from({length:500},(_,i)=>({id:`CC-${String(i+1).padStart(4,'0')}`,name:`مركز تكلفة ${i+1}`,active:i%7!==0})),
      headCC:null,
      headAlloc:[], // [{cc_id,percent,value}]
      lines:[], // runtime only (DOM is source of truth)
      allocCtx:null, // {target:'line'|'head'|'jv-line', id, total, rows}
      jv:{headCC:null,lines:[]}
    };

    // ===== Theme & Tabs =====
    function applyTheme(){document.documentElement.setAttribute('data-theme',state.theme==='dark'?'dark':'light');const t=$('#themeToggle'); if(t){t.textContent=state.theme==='dark'?'☀️ الوضع الفاتح':'🌙 الوضع الداكن';t.setAttribute('aria-pressed',state.theme==='dark');}}
    $('#themeToggle')?.addEventListener('click',()=>{state.theme=state.theme==='dark'?'light':'dark';localStorage.setItem('theme',state.theme);applyTheme();});
    applyTheme();

    $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      $$('.tab').forEach(b=>b.setAttribute('aria-selected','false')); btn.setAttribute('aria-selected','true');
      const key=btn.dataset.tab; $('#panel-invoice').hidden = key!=='invoice'; $('#panel-journal').hidden = key!=='journal'; $('#panel-reports').hidden = key!=='reports';
    }));

    // ===== Cost Center Picker =====
    function attachPicker(input,{onPick}={}){
      if(!input) return; const wrap=input.closest('.cc-picker'); if(!wrap) return; const list=wrap.querySelector('.cc-dropdown');
      function render(q=''){
        const rows=state.centers.filter(c=>c.active && (c.id.toLowerCase().includes(q)||c.name.includes(q))).slice(0,40);
        list.innerHTML=rows.map(c=>`<div class="cc-option" data-id="${c.id}" data-name="${c.name}"><span class="tag">${c.id}</span> ${c.name}</div>`).join('');
        list.hidden=false;
      }
      input.addEventListener('input',()=>render(input.value.trim().toLowerCase()));
      input.addEventListener('focus',()=>render(''));
      document.addEventListener('click',e=>{ if(!wrap.contains(e.target)) list.hidden=true; });
      list.addEventListener('click',e=>{const opt=e.target.closest('.cc-option'); if(!opt) return; input.value=`${opt.dataset.id} — ${opt.dataset.name}`; list.hidden=true; onPick&&onPick({id:opt.dataset.id,name:opt.dataset.name});});
    }

    attachPicker($('#cc-head'),{onPick:(cc)=>{ state.headCC=cc; }});
    attachPicker($('#cc-payment'),{onPick:(cc)=>{ $('#cc-payment').dataset.selected = cc.id; }});

    // ===== Lines Table =====
    const linesBody = $('#linesTable tbody');
    function lineAmount(tr){ const q=Number($('.qty',tr).value||0), p=Number($('.price',tr).value||0); return q*p; }
    function reindex(){ $$('#linesTable tbody tr').forEach((tr,i)=>$('.rowIndex',tr).textContent=i+1); }

    function addLineRow(data={}){
      const tpl=$('#lineRowTpl'); const tr=tpl.content.firstElementChild.cloneNode(true);
      $('.desc',tr).value = data.desc||''; $('.qty',tr).value = data.qty||1; $('.price',tr).value = data.price||0; $('.amount',tr).textContent = money(lineAmount(tr));
      attachPicker($('.line-cc',tr),{onPick:(cc)=>{ tr.dataset.cc = JSON.stringify(cc); tr.dataset.alloc=''; $('.state',tr).innerHTML='<span class="tag custom">مخصص</span>'; renderTotals(); }});
      ['input','change'].forEach(ev=>{
        $('.qty',tr).addEventListener(ev,()=>{ $('.amount',tr).textContent = money(lineAmount(tr)); renderTotals(); });
        $('.price',tr).addEventListener(ev,()=>{ $('.amount',tr).textContent = money(lineAmount(tr)); renderTotals(); });
      });
      $('.allocBtn',tr).addEventListener('click',()=> openAllocForLine(tr));
      $('.delLine',tr).addEventListener('click',()=>{ tr.remove(); reindex(); renderTotals(); });
      linesBody.appendChild(tr); reindex(); renderTotals();
    }

    $('#btnAddLine')?.addEventListener('click',()=>addLineRow());
    $('#btnClearLines')?.addEventListener('click',()=>{ linesBody.innerHTML=''; renderTotals(); });

    // تطبيق مركز الرأس موروث
    $('#btnApplyHead')?.addEventListener('click',()=>{
      if(!state.headCC) return alert('اختر مركز رأس أولًا');
      $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !tr.dataset.alloc){ $('.state',tr).innerHTML='<span class="tag inherited">موروث</span>'; }});
      renderTotals();
    });

    // ===== Allocation Modal =====
    const allocModal = $('#allocModal'); const allocBody = $('#allocTable tbody');
    function openAllocForLine(tr){ const total=lineAmount(tr); const rows = tr.dataset.alloc? JSON.parse(tr.dataset.alloc) : []; state.allocCtx={target:'line', id:tr, total, rows}; openAllocModal(rows,total,'توزيع مراكز التكلفة للبند'); }
    function openAllocForHead(){ let total=0; $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !tr.dataset.alloc) total += lineAmount(tr); }); state.allocCtx={target:'head', id:null, total, rows: state.headAlloc||[]}; openAllocModal(state.headAlloc||[], total, 'توزيع من رأس الفاتورة'); }
    $('#btnHeadAlloc')?.addEventListener('click', openAllocForHead);

    function openAllocModal(rows,total,title){ $('#allocTitle').textContent=title; allocBody.innerHTML=''; if(!rows.length) rows=[{cc_id:null,percent:null,value:null}]; rows.forEach(r=>addAllocRow(r)); allocModal.hidden=false; recalcAlloc(total); }
    function closeAlloc(){ allocModal.hidden=true; }
    $('#allocClose')?.addEventListener('click',closeAlloc); allocModal.addEventListener('click',e=>{ if(e.target===allocModal) closeAlloc(); });

    function addAllocRow(r={}){
      const tpl=$('#allocRowTpl'); const tr=tpl.content.firstElementChild.cloneNode(true);
      if(r.cc_id) $('.alloc-cc',tr).value=r.cc_id; if(r.percent!=null) $('.pct',tr).value=r.percent; if(r.value!=null) $('.val',tr).value=r.value;
      attachPicker($('.alloc-cc',tr),{onPick:(cc)=>{ $('.alloc-cc',tr).value=cc.id; recalcAlloc(state.allocCtx.total); }});
      $('.pct',tr).addEventListener('input',()=>{ const p=Number($('.pct',tr).value||0); $('.val',tr).value=(p/100)*(state.allocCtx.total||0); recalcAlloc(state.allocCtx.total); });
      $('.val',tr).addEventListener('input',()=>{ const v=Number($('.val',tr).value||0); $('.pct',tr).value = state.allocCtx.total? (v/state.allocCtx.total)*100 : 0; recalcAlloc(state.allocCtx.total); });
      $('.removeAlloc',tr).addEventListener('click',()=>{ tr.remove(); recalcAlloc(state.allocCtx.total); });
      allocBody.appendChild(tr);
    }
    $('#allocAdd')?.addEventListener('click',()=>addAllocRow({}));

    function recalcAlloc(total){ let p=0,v=0; const rows=[]; let neg=false; $$('#allocTable tbody tr').forEach(tr=>{ const cc=$('.alloc-cc',tr).value.trim(); const pct=Number($('.pct',tr).value||0); const val=Number($('.val',tr).value||0); if(pct<0||val<0) neg=true; p+=pct; v+=val; if(cc) rows.push({cc_id:cc,percent:pct||null,value:val||null}); });
      $('#sumPct').textContent = `${p.toFixed(2)}%`; $('#sumVal').textContent = money(v);
      const okTotals = (Math.abs(p-100)<=0.01 || Math.abs(v-(total||0))<=0.01); const ok = !neg && okTotals && rows.length>0; $('#allocError').textContent = neg? 'لا يُسمح بقيم سالبة.' : (ok? '' : 'المجموع غير صحيح — اجعل النسب=100% أو القيم=إجمالي البند.'); $('#allocSave').disabled=!ok; state.allocCtx.rows=rows; state.allocCtx.valid=ok; }

    $('#allocSave')?.addEventListener('click',()=>{
      if(!state.allocCtx?.valid) return; const rows=state.allocCtx.rows; const total=state.allocCtx.total||0;
      const normalized = rows.map(r=>({ cc_id:r.cc_id, percent: r.percent!=null? Number(r.percent): (r.value!=null? (Number(r.value)/total)*100: null), value: r.value!=null? Number(r.value): (r.percent!=null? (Number(r.percent)/100)*total: null) }));
      if(state.allocCtx.target==='line'){
        const tr=state.allocCtx.id; tr.dataset.alloc = JSON.stringify(normalized); tr.dataset.cc=''; $('.state',tr).innerHTML='<span class="tag multi">متعدد</span>';
      } else if(state.allocCtx.target==='head'){
        state.headAlloc = normalized;
        // طبّق على البنود الموروثة فقط
        $$('#linesTable tbody tr').forEach(tr=>{ if(!tr.dataset.cc && !tr.dataset.alloc){ const amt=lineAmount(tr); const rows2 = normalized.map(a=>({cc_id:a.cc_id,percent:a.percent,value:(a.percent/100)*amt})); tr.dataset.alloc = JSON.stringify(rows2); $('.state',tr).innerHTML='<span class="tag multi">متعدد</span>'; } });
      } else if(state.allocCtx.target==='jv-line'){
        const idx=state.allocCtx.id; state.jv.lines[idx].alloc = normalized; renderJV();
      }
      closeAlloc(); renderTotals();
    });

    // ===== Totals & Tax (demo 15%) =====
    function renderTotals(){ let sub=0, tax=0; const allocMap=new Map();
      $$('#linesTable tbody tr').forEach(tr=>{
        const amt=lineAmount(tr); sub+=amt; tax += amt*0.15; // ضريبة تجريبية
        if(tr.dataset.alloc){ JSON.parse(tr.dataset.alloc).forEach(a=> allocMap.set(a.cc_id,(allocMap.get(a.cc_id)||0)+Number(a.value||0)) ); }
        else if(tr.dataset.cc){ const cc=JSON.parse(tr.dataset.cc); allocMap.set(cc.id,(allocMap.get(cc.id)||0)+amt); }
        else if(state.headCC){ allocMap.set(state.headCC.id,(allocMap.get(state.headCC.id)||0)+amt); }
      });
      $('#subTotal').textContent = money(sub); $('#taxTotal').textContent = money(tax); $('#grandTotal').textContent = money(sub+tax);
      const parts=[...allocMap.entries()].map(([id,v])=>`${id}: ${money(v)}`); $('#docAlloc').textContent = parts.length? parts.join(' | '):'—';
    }

    // ===== Actions =====
    $('#btnValidate')?.addEventListener('click',()=>{ const ok = $$('#linesTable tbody tr').length>0; alert(ok? '✅ جاهز للحفظ/الترحيل.': 'أضف بندًا واحدًا على الأقل.'); });
    $('#btnSaveDraft')?.addEventListener('click',()=>alert('💾 تم حفظ مسودة (محاكاة).'));
    $('#btnPost')?.addEventListener('click',()=>alert('🚀 تم ترحيل الفاتورة (محاكاة).'));

    // ===== JV: ربط مراكز فقط =====
    $('#btnLoadJV')?.addEventListener('click',()=>{ const no=$('#jvNumber').value.trim(); if(!no) return alert('أدخل رقم القيد'); state.jv.lines=[ {acc:'110101-العملاء',debit:1000,credit:0,cc:null,alloc:[]}, {acc:'410100-إيرادات',debit:0,credit:1000,cc:null,alloc:[]} ]; renderJV(); });
    function renderJV(){ const tb=$('#jvLines tbody'); tb.innerHTML=''; state.jv.lines.forEach((ln,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${ln.acc}</td><td>${money(ln.debit)}</td><td>${money(ln.credit)}</td><td><div class="cc-picker"><input class="cc-input jv-cc" placeholder="اختر مركز" value="${ln.cc? ln.cc.id+' — '+ln.cc.name:''}"><div class="cc-dropdown" hidden></div></div></td><td><button class="btn jv-alloc">📊 توزيع</button></td><td>${ln.alloc?.length? '<span class="tag multi">متعدد</span>': (ln.cc? '<span class="tag custom">مخصص</span>':'<span class="tag inherited">—</span>')}</td>`; tb.appendChild(tr); attachPicker($('.jv-cc',tr),{onPick:(cc)=>{ state.jv.lines[i].cc=cc; state.jv.lines[i].alloc=[]; renderJV(); }}); $('.jv-alloc',tr).addEventListener('click',()=>{ const total=(Number(ln.debit)||0)+(Number(ln.credit)||0); state.allocCtx={target:'jv-line',id:i,total,rows:ln.alloc||[]}; openAllocModal(state.allocCtx.rows,total,`توزيع للبند #${i+1}`); }); }); }
    $('#btnJVHeadCC')?.addEventListener('click',()=>{ const temp=document.createElement('div'); temp.className='modal'; temp.innerHTML=`<div class="modal__panel"><div class="modal-header"><h3>اختيار مركز على مستوى القيد</h3></div><div class="modal-body"><div class="cc-picker"><input id="tmpJVHead" class="cc-input" placeholder="اختر مركز"><div class="cc-dropdown" hidden></div></div></div></div>`; document.body.appendChild(temp); attachPicker($('#tmpJVHead'),{onPick:(cc)=>{ state.jv.headCC=cc; document.body.removeChild(temp); renderJV(); }}); temp.addEventListener('click',e=>{ if(e.target===temp) document.body.removeChild(temp); }); });
    $('#btnApplyJVHead')?.addEventListener('click',()=>{ if(!state.jv.headCC) return alert('اختر مركز أولًا'); state.jv.lines.forEach(ln=>{ if(!ln.cc && !(ln.alloc?.length)) ln.cc = state.jv.headCC; }); renderJV(); });
    $('#btnJVValidate')?.addEventListener('click',()=>alert('✅ التحقق ناجح: تعديل مراكز فقط.'));
    $('#btnJVCommit')?.addEventListener('click',()=>alert('💾 تم حفظ الربط (محاكاة).'));

    // ===== Reports =====
    attachPicker($('#reportCC'),{onPick:(cc)=>{ const inp=$('#reportCC'); inp.dataset.selected = ((inp.dataset.selected||'')+','+cc.id).replace(/^,/, ''); }});
    $('#btnRunReport')?.addEventListener('click',()=>{ const tb=$('#reportTable tbody'); tb.innerHTML=''; $$('#linesTable tbody tr').forEach((tr,i)=>{ const amount=lineAmount(tr); const list = tr.dataset.alloc? JSON.parse(tr.dataset.alloc).map(a=>a.cc_id).join('+') : (tr.dataset.cc? JSON.parse(tr.dataset.cc).id : (state.headCC? state.headCC.id : '—')); const row=document.createElement('tr'); row.innerHTML=`<td>${1000+i}</td><td>${$('#invDate').value||new Date().toISOString().slice(0,10)}</td><td>${list}</td><td>${money(amount)}</td>`; tb.appendChild(row); }); });
    $('#btnExportCSV')?.addEventListener('click',()=>{ const tb=$('#reportTable tbody'); const rows=[["DocNo","Date","CCs","Amount"]].concat($$('tr',tb).map(tr=>[...tr.children].map(td=>td.textContent.trim()))); const csv=rows.map(r=>r.join(',')).join('\n'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='cc-report.csv'; a.click(); URL.revokeObjectURL(a.href); });

    // ===== Seed some demo lines =====
    $('#invDate').value = new Date().toISOString().slice(0,10);
    addLineRow({desc:'منتج A',qty:2,price:150});
    addLineRow({desc:'خدمة B',qty:1,price:300});
  });
  </script>
</body>
</html>
