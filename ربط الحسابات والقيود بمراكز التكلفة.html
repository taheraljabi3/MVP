<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart ERP â€” Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</title>
  <style>
    :root{
      --blue:#1877f2;--gold:#d4a017;--bg:#ffffff;--ink:#0f172a;--ink-2:#334155;--muted:#f1f5f9;--danger:#dc2626;--ok:#16a34a;--warn:#f59e0b;--shadow:0 8px 24px rgba(15,23,42,.08)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Tahoma,Arial}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #e5e7eb;box-shadow:0 2px 10px rgba(0,0,0,.03)}
    .wrap{max-width:1200px;margin:auto;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--blue),#4ea5ff);box-shadow:var(--shadow)}
    .actions{margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}
    .search{position:relative;min-width:260px}
    .search input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}

    .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--blue);color:#fff;cursor:pointer;box-shadow:var(--shadow)}
    .btn:focus{outline:3px solid rgba(24,119,242,.25)}
    .btn.secondary{background:#eef3ff;color:var(--blue)}
    .btn.gold{background:var(--gold);color:#111}
    .btn.ghost{background:#fff;color:var(--blue);border:1px solid #e5e7eb}
    .btn.danger{background:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    nav.tabs{border-bottom:1px solid #e5e7eb;margin-top:8px}
    .tablist{display:flex;gap:6px;flex-wrap:wrap}
    .tab{border:0;background:#fff;padding:10px 12px;border-radius:12px 12px 0 0}
    .tab[aria-selected="true"], .tab:hover{background:#f8fbff;color:var(--blue);border-bottom:2px solid var(--blue)}

    section{padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:var(--shadow);padding:12px}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-weight:600;text-align:right;padding:10px;color:var(--ink-2)}
    tbody tr{background:#fff;border:1px solid #e5e7eb}
    tbody td{padding:10px;border-top:1px solid #e5e7eb}
    tbody tr{border-radius:10px;overflow:hidden}
    tbody tr:hover{box-shadow:var(--shadow)}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb;background:#fff}
    .badge.blue{background:#eef3ff;color:var(--blue);border-color:#dce9ff}
    .badge.gold{background:#fff7e6;color:#7a5b00;border-color:#ffe7b3}
    .badge.lock{background:#f3f4f6;color:#6b7280}

    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f5f9;margin:2px;font-size:12px;border:1px solid #e5e7eb}

    .grid{display:grid;gap:12px}
    .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}

    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}

    /* Modals */
    dialog{border:0;border-radius:16px;box-shadow:var(--shadow);width:min(720px,96vw)}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:1px solid #eee}
    .modal-body{padding:12px;max-height:65vh;overflow:auto}
    .modal-foot{padding:12px;display:flex;gap:8px;justify-content:flex-start;border-top:1px solid #eee}

    /* Toast */
    #toasts{position:fixed;inset-inline-end:16px;top:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow)}

    /* Progress */
    .progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden}
    .progress span{display:block;height:100%;background:var(--blue);width:0}

    /* Footer */
    footer{border-top:1px solid #e5e7eb;padding:12px;color:#475569}

    /* Inputs */
    input[type="text"], input[type="number"], input[type="date"], select, textarea{
      width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff
    }
    label{font-size:12px;color:#475569}
    .hint{font-size:12px;color:#64748b}

    /* Print */
    @media print{
      header, nav.tabs, .actions, .toolbar, .modal-foot, .btn, footer, #toasts{display:none !important}
      body{background:#fff}
      .card{box-shadow:none;border:0}
    }
  </style>
</head>
<body>
  <header aria-label="Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©">
    <div class="wrap">
      <div class="row">
        <div class="brand" aria-label="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…">
          <div class="logo" aria-hidden="true"></div>
          <h1>Smart ERP â€” Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</h1>
        </div>
        <div class="actions" role="toolbar" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª">
          <button class="btn" id="btnAddAccount">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
          <button class="btn" id="btnAddCC">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©</button>
          <button class="btn gold" id="btnPresets">Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
          <button class="btn ghost" id="btnExport">ØªØµØ¯ÙŠØ±</button>
          <button class="btn secondary" id="btnSettings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <div class="search" aria-label="Ø¨Ø­Ø« Ø¹Ø§Ù…">
            <input id="globalSearch" type="text" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª/Ø§Ù„Ù…Ø±Ø§ÙƒØ²/Ø§Ù„Ù‚ÙŠÙˆØ¯â€¦ (Ctrl+/)" aria-label="Ø¨Ø­Ø«" />
          </div>
        </div>
      </div>
    </div>
    <nav class="tabs wrap" role="tablist" aria-label="Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª">
      <div class="tablist">
        <button class="tab" role="tab" aria-selected="true" data-tab="accounts">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª & Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="journal">Ù‚ÙŠÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="centers">Ù…Ø±Ø§ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="audit">Ø§Ù„Ø³Ø¬Ù„</button>
      </div>
    </nav>
  </header>

  <main class="wrap" id="app" tabindex="-1"></main>

  <footer class="wrap">
    <div class="row">
      <span>Ù†Ø³Ø®Ø© Demo â€” ØªØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ (localStorage).</span>
      <button class="btn danger" id="btnClear">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©</button>
    </div>
  </footer>

  <!-- Modals -->
  <dialog id="modal-defaults" aria-label="ØªØ¹ÙŠÙŠÙ† Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©">
    <form method="dialog">
      <div class="modal-head">
        <strong>ØªØ¹ÙŠÙŠÙ† Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ <span id="defaultsAccountName"></span></strong>
        <button class="btn ghost" value="close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="grid cols-3">
          <div>
            <label for="defaultsMode">ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶</label>
            <select id="defaultsMode" aria-label="ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶">
              <option value="none">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
              <option value="suggest">Ø§Ù‚ØªØ±Ø§Ø­ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</option>
              <option value="fixed">Ù‚ÙŠÙ…Ø© Ø«Ø§Ø¨ØªØ© ØºÙŠØ± Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</option>
            </select>
            <div class="hint">Ø¥Ø°Ø§ ÙƒØ§Ù† "Ø«Ø§Ø¨Øª" Ø³ÙŠØ¸Ù‡Ø± Ù‚ÙÙ„ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯ ÙˆÙ„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.</div>
          </div>
          <div>
            <label>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ² ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø©ØŸ</label>
            <div class="row"><input type="checkbox" id="showInactiveInDefaults" /> <span class="hint">Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ù‚Øª</span></div>
          </div>
        </div>
        <div class="toolbar"><button type="button" class="btn secondary" id="btnAddSplitRow">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ²</button></div>
        <div class="card" role="region" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹">
          <table>
            <thead>
              <tr>
                <th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                <th style="width:140px">Ø§Ù„Ù†Ø³Ø¨Ø© %</th>
                <th style="width:80px">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="defaultsSplitBody"></tbody>
          </table>
          <div class="progress" aria-label="Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„"><span id="defaultsProgress"></span></div>
          <div class="hint" id="defaultsHint"></div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" id="btnSaveDefaults" value="save">Ø­ÙØ¸</button>
        <button class="btn ghost" value="close">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </dialog>

  <dialog id="modal-split" aria-label="ØªÙˆØ²ÙŠØ¹ Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ø³Ø·Ø±">
    <form method="dialog">
      <div class="modal-head">
        <strong>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø·Ø± â€” <span id="splitLineTitle"></span></strong>
        <div class="row">
          <select id="splitMode">
            <option value="pct">Ø§Ù„Ù†Ø³Ø¨ Ùª</option>
            <option value="amt">Ø§Ù„Ù…Ø¨Ø§Ù„Øº</option>
          </select>
          <button class="btn gold" id="btnApplyPreset" type="button">ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ù„Ø¨</button>
          <button class="btn ghost" value="close" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="toolbar">
          <button type="button" class="btn secondary" id="btnAddSplitLine">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ²</button>
        </div>
        <div class="card">
          <table>
            <thead>
              <tr>
                <th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                <th style="width:160px"><span id="splitValueHdr">Ø§Ù„Ù†Ø³Ø¨Ø© %</span></th>
                <th style="width:80px">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="splitBody"></tbody>
          </table>
          <div class="progress" aria-label="Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„"><span id="splitProgress"></span></div>
          <div class="hint" id="splitHint"></div>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" id="btnSaveSplit" value="save">Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹</button>
        <button class="btn ghost" value="close">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </form>
  </dialog>

  <dialog id="modal-presets" aria-label="Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„ØªÙˆØ²ÙŠØ¹">
    <form method="dialog">
      <div class="modal-head">
        <strong>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</strong>
        <button class="btn ghost" value="close">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body">
        <div class="toolbar">
          <input id="presetName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ (Ù…Ø«Ø§Ù„: Utilities 60/30/10)"/>
          <button class="btn secondary" id="btnPresetFromCurrent" type="button">Ø­ÙØ¸ Ù…Ù† Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        </div>
        <div class="card" id="presetsList"></div>
      </div>
      <div class="modal-foot">
        <button class="btn" value="close">ØªÙ…</button>
      </div>
    </form>
  </dialog>

  <dialog id="modal-settings" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
    <form method="dialog">
      <div class="modal-head">
        <strong>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯</strong>
        <button class="btn ghost" value="close">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="modal-body grid cols-2">
        <div class="card">
          <label>Ø¥Ù„Ø²Ø§Ù… Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ù„Ù„Ø£Ù†ÙˆØ§Ø¹</label>
          <div>
            <label><input type="checkbox" id="enfExp"> Ù…ØµØ±ÙˆÙ</label>
            <label><input type="checkbox" id="enfRev"> Ø¥ÙŠØ±Ø§Ø¯</label>
          </div>
          <div class="hint">Ù„Ù† ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø­ÙØ¸ Ø¥Ù† Ù„Ù… ØªÙØ­Ø¯Ø¯ Ù…Ø±Ø§ÙƒØ² Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹.</div>
        </div>
        <div class="card">
          <label><input type="checkbox" id="allowOverride"> Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ù…Ù† Ø§Ù„Ù‚ÙŠØ¯</label>
          <label><input type="checkbox" id="hideInactiveCC"> Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø±Ø§ÙƒØ² ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§</label>
        </div>
      </div>
      <div class="modal-foot">
        <button class="btn" id="btnSaveSettings" value="save">Ø­ÙØ¸</button>
      </div>
    </form>
  </dialog>

  <div id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script>
    // =================== Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ===================
    const LS_KEY = 'smart-erp-cc-state-v1';
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const demoState = {
      costCenters:[
        { id:"CC-100", name:"Ø§Ù„ØªØµÙ†ÙŠØ¹", active:true, group:"ØªØ´ØºÙŠÙ„ÙŠ" },
        { id:"CC-200", name:"Ø§Ù„ØªØ³ÙˆÙŠÙ‚", active:true, group:"Ø¥Ø¯Ø§Ø±ÙŠ" },
        { id:"CC-300", name:"Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", active:true, group:"Ø¹Ø§Ù…" },
        { id:"CC-400", name:"Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª", active:false, group:"ØªØ´ØºÙŠÙ„ÙŠ" }
      ],
      accounts:[
        { id:"6000", name:"Ù…Ø±Ø§ÙÙ‚ ÙˆÙƒÙ‡Ø±Ø¨Ø§Ø¡", type:"expense", defaultCC:{ mode:"suggest", split:[{ccId:"CC-100", pct:60},{ccId:"CC-200", pct:30},{ccId:"CC-300", pct:10}] }},
        { id:"6110", name:"Ø³ÙØ± ÙˆØªØ±Ø­ÙŠÙ„", type:"expense", defaultCC:{ mode:"none", split:[] }},
        { id:"1200", name:"Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", type:"balance", defaultCC:{ mode:"none", split:[] }},
        { id:"4000", name:"Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Øª", type:"revenue", defaultCC:{ mode:"none", split:[] }}
      ],
      journalEntries:[{
        id:"JE-0001", date:new Date().toISOString().slice(0,10), memo:"ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡",
        lines:[
          { accountId:"6000", desc:"ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø³Ø¨ØªÙ…Ø¨Ø±", debit:1000, credit:0, ccAlloc:{ source:"default", split:[{ccId:"CC-100", pct:60},{ccId:"CC-200", pct:40}] }},
          { accountId:"1000", desc:"ØµÙ†Ø¯ÙˆÙ‚", debit:0, credit:1000, ccAlloc:{ source:"none", split:[] }}
        ]
      }],
      presets:[{ id:"P-UTIL-631", name:"Utilities 60/30/10", split:[{ccId:"CC-100", pct:60},{ccId:"CC-200", pct:30},{ccId:"CC-300", pct:10}] }],
      settings:{ enforceCCFor:["expense","revenue"], allowOverride:true, hideInactiveCC:true },
      audit:[{ ts: Date.now()-86400000, action:"UPDATE_DEFAULTS", details:"6000 => 60/30/10 suggest" }]
    };

    let state = loadState();

    function loadState(){
      try{ const s = JSON.parse(localStorage.getItem(LS_KEY)); if(s) return s; }catch(e){}
      return structuredClone(demoState);
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    function pushAudit(action, details){
      state.audit.unshift({ ts: Date.now(), action, details, user:"Local User" });
      saveState();
    }
    function toast(msg){
      const el=document.createElement('div'); el.className='toast'; el.role='status'; el.textContent=msg; $('#toasts').appendChild(el);
      setTimeout(()=>{ el.remove(); }, 2600);
    }

    // ============== ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØªÙ‡ÙŠØ¦Ø© ==============
    const app = $('#app');
    let activeTab = 'accounts';

    function render(){
      if(activeTab==='accounts') renderAccounts();
      else if(activeTab==='journal') renderJournal();
      else if(activeTab==='centers') renderCenters();
      else if(activeTab==='reports') renderReports();
      else if(activeTab==='audit') renderAudit();
    }

    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      activeTab = t.dataset.tab; render();
    }));

    $('#globalSearch').addEventListener('keydown',e=>{ if(e.key==='/' && e.ctrlKey){ e.preventDefault(); e.target.focus(); } });
    $('#btnClear').addEventListener('click',()=>{ localStorage.removeItem(LS_KEY); state=structuredClone(demoState); render(); toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ'); });

    // Header actions
    $('#btnSettings').addEventListener('click',openSettings);
    $('#btnPresets').addEventListener('click',openPresets);
    $('#btnExport').addEventListener('click',doExport);
    $('#btnAddCC').addEventListener('click',()=>addCC());
    $('#btnAddAccount').addEventListener('click',()=>addAccount());

    // ============== Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ==============
    function getAccount(id){ return state.accounts.find(a=>a.id===id); }
    function getCC(id){ return state.costCenters.find(c=>c.id===id); }

    function sum(arr,sel){ return arr.reduce((t,x)=>t+(sel?sel(x):x),0); }
    function fmt(n){ return Number(n||0).toLocaleString('ar-EG',{maximumFractionDigits:2}); }

    // ============== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ==============
    function renderAccounts(){
      const q=($('#globalSearch').value||'').trim();
      const rows = state.accounts.filter(a=>!q || a.id.includes(q) || a.name.includes(q));
      app.innerHTML = `
      <section class="card" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª">
        <div class="toolbar">
          <span class="hint">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: ${rows.length}</span>
        </div>
        <table>
          <thead><tr>
            <th style="width:120px">ÙƒÙˆØ¯</th><th>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</th><th style="width:120px">Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§ÙØªØ±Ø§Ø¶ Ù…Ø±ÙƒØ²/Ù…Ø±Ø§ÙƒØ²</th><th style="width:140px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr></thead>
          <tbody>
            ${rows.map(a=>{
              const d=a.defaultCC||{mode:'none',split:[]};
              const badges = (d.split||[]).map(s=>`<span class="chip" title="${s.pct||0}%">${getCC(s.ccId)?.name||s.ccId} â€” ${s.pct||0}%</span>`).join('');
              const modeBadge = d.mode==='fixed'?'<span class="badge lock">Ù…ØºÙ„Ù‚ ğŸ”’</span>':(d.mode==='suggest'?'<span class="badge gold">Ø§Ù‚ØªØ±Ø§Ø­</span>':'<span class="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>');
              return `<tr>
                <td>${a.id}</td>
                <td>${a.name}</td>
                <td>${a.type}</td>
                <td>${modeBadge} ${badges}</td>
                <td><button class="btn secondary" data-act="setdef" data-id="${a.id}">ØªØ¹ÙŠÙŠÙ† Ø§ÙØªØ±Ø§Ø¶Ø§Øª</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </section>`;

      $$('[data-act="setdef"]').forEach(b=>b.addEventListener('click',()=>openDefaults(b.dataset.id)));
    }

    // ======= Ù†Ø§ÙØ°Ø© Ø§ÙØªØ±Ø§Ø¶Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ =======
    const modalDefaults = $('#modal-defaults');
    const defaultsBody = $('#defaultsSplitBody');
    let defaultsEditingAccId = null; let defaultsSplitDraft = [];

    function openDefaults(accId){
      const acc=getAccount(accId); defaultsEditingAccId=accId; $('#defaultsAccountName').textContent=`(${acc.id}) ${acc.name}`;
      const d=acc.defaultCC||{mode:'none',split:[]};
      $('#defaultsMode').value=d.mode||'none';
      defaultsSplitDraft= (d.split||[]).map(x=>({ccId:x.ccId, pct:Number(x.pct)||0}));
      $('#showInactiveInDefaults').checked=!state.settings.hideInactiveCC;
      renderDefaultsSplit();
      modalDefaults.showModal();
    }

    function renderDefaultsSplit(){
      defaultsBody.innerHTML = '';
      const visibleCCs = state.costCenters.filter(c=> c.active || $('#showInactiveInDefaults').checked);
      defaultsSplitDraft.forEach((row,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>
            <select data-k="ccId" data-idx="${idx}">
              ${visibleCCs.map(c=>`<option value="${c.id}" ${c.id===row.ccId?'selected':''}>${c.name} (${c.id}) ${c.active?'':'â€” Ù…Ø®ÙÙŠ'}</option>`).join('')}
            </select>
          </td>
          <td><input type="number" step="0.01" min="0" max="100" data-k="pct" data-idx="${idx}" value="${row.pct}"></td>
          <td><button type="button" class="btn ghost" data-del="${idx}">Ø­Ø°Ù</button></td>`;
        defaultsBody.appendChild(tr);
      });
      const total = sum(defaultsSplitDraft,x=>Number(x.pct)||0);
      $('#defaultsProgress').style.width=Math.min(100,total)+"%";
      $('#defaultsHint').textContent = `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ = ${total.toFixed(2)}% â€” ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ 100%`;

      defaultsBody.querySelectorAll('select, input').forEach(el=>{
        el.addEventListener('input',e=>{
          const i=Number(e.target.dataset.idx); const k=e.target.dataset.k;
          defaultsSplitDraft[i][k] = k==='pct'?Number(e.target.value):e.target.value;
          renderDefaultsSplit();
        });
      });
      defaultsBody.querySelectorAll('[data-del]').forEach(btn=>btn.addEventListener('click',()=>{
        defaultsSplitDraft.splice(Number(btn.dataset.del),1); renderDefaultsSplit();
      }));
    }

    $('#btnAddSplitRow').addEventListener('click',()=>{ defaultsSplitDraft.push({ccId: state.costCenters[0].id, pct:0}); renderDefaultsSplit(); });
    $('#btnSaveDefaults').addEventListener('click',e=>{
      e.preventDefault();
      const mode = $('#defaultsMode').value;
      const total = sum(defaultsSplitDraft,x=>Number(x.pct)||0);
      if(mode!=='none' && Math.abs(total-100)>0.001){ toast('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ 100%'); return; }
      const acc=getAccount(defaultsEditingAccId);
      acc.defaultCC = { mode, split: mode==='none'?[]:defaultsSplitDraft.map(x=>({ccId:x.ccId,pct:Number(x.pct)})) };
      saveState(); pushAudit('UPDATE_DEFAULTS', `Ø­Ø³Ø§Ø¨ ${acc.id} => ${mode}`); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶Ø§Øª'); modalDefaults.close(); render();
    });

    // ============== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù‚ÙŠÙˆØ¯ ==============
    let currentJEIndex = 0; // Ù†Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ù‚ÙŠØ¯ ÙƒØªØ¬Ø±ÙŠØ¨

    function renderJournal(){
      const je = state.journalEntries[currentJEIndex] || { id:"JE-TEMP", date:new Date().toISOString().slice(0,10), memo:"", lines:[] };
      app.innerHTML = `
        <section class="card">
          <div class="grid cols-3">
            <div><label>Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ¯</label><input id="jeId" value="${je.id}"></div>
            <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="jeDate" type="date" value="${je.date}"></div>
            <div><label>ÙˆØµÙ Ø¹Ø§Ù…</label><input id="jeMemo" value="${je.memo||''}"></div>
          </div>
          <div class="toolbar"><button class="btn secondary" id="btnAddLine">Ø¥Ø¶Ø§ÙØ© Ø³Ø·Ø±</button></div>
          <div class="card" role="region" aria-label="Ø£Ø³Ø·Ø± Ø§Ù„Ù‚ÙŠØ¯">
            <table>
              <thead>
                <tr><th style="width:170px">Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>ÙˆØµÙ</th><th style="width:120px">Ù…Ø¯ÙŠÙ†</th><th style="width:120px">Ø¯Ø§Ø¦Ù†</th><th>Ù…Ø±Ø§ÙƒØ² ØªÙƒÙ„ÙØ©</th><th style="width:140px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
              </thead>
              <tbody id="linesBody"></tbody>
            </table>
          </div>
          <div class="row" style="justify-content:space-between;margin-top:8px">
            <div>
              <span class="badge">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¯ÙŠÙ†: <b id="totDebit">0</b></span>
              <span class="badge">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø§Ø¦Ù†: <b id="totCredit">0</b></span>
              <span class="badge" id="balBadge"></span>
            </div>
            <div class="row">
              <button class="btn" id="btnSaveJE">Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯</button>
              <button class="btn ghost" id="btnResetJE">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
            </div>
          </div>
        </section>`;

      const body = $('#linesBody');
      function drawLines(){
        body.innerHTML='';
        je.lines.forEach((ln,idx)=>{
          const acc = getAccount(ln.accountId) || {id:ln.accountId,name:'â€”'};
          const dMode = (getAccount(ln.accountId)?.defaultCC?.mode)||'none';
          const badge = ln.ccAlloc?.source==='custom'?'<span class="badge blue">Ù…Ø®ØµØµ</span>':(ln.ccAlloc?.source==='default'?`<span class="badge gold">Ø§ÙØªØ±Ø§Ø¶ÙŠ${dMode==='fixed'?' ğŸ”’':''}</span>`:'<span class="badge">â€”</span>');
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>
              <select data-k="accountId" data-idx="${idx}">
                ${state.accounts.map(a=>`<option value="${a.id}" ${a.id===ln.accountId?'selected':''}>${a.id} â€” ${a.name}</option>`).join('')}
              </select>
            </td>
            <td><input data-k="desc" data-idx="${idx}" value="${ln.desc||''}" /></td>
            <td><input type="number" step="0.01" min="0" data-k="debit" data-idx="${idx}" value="${ln.debit||0}" /></td>
            <td><input type="number" step="0.01" min="0" data-k="credit" data-idx="${idx}" value="${ln.credit||0}" /></td>
            <td>${badge} ${(ln.ccAlloc?.split||[]).map(s=>`<span class="chip">${getCC(s.ccId)?.name||s.ccId} â€” ${(s.pct!=null?s.pct+'%':fmt(s.amt))}</span>`).join('')}</td>
            <td>
              <button class="btn secondary" data-act="split" data-idx="${idx}">ØªÙˆØ²ÙŠØ¹</button>
              <button class="btn ghost" data-act="del" data-idx="${idx}">Ø­Ø°Ù</button>
            </td>`;
          body.appendChild(tr);
        });
        body.querySelectorAll('select,input').forEach(el=>el.addEventListener('input',onLineEdit));
        body.querySelectorAll('[data-act="del"]').forEach(b=>b.addEventListener('click',()=>{ je.lines.splice(Number(b.dataset.idx),1); drawLines(); refreshTotals(); }));
        body.querySelectorAll('[data-act="split"]').forEach(b=>b.addEventListener('click',()=>openSplit(Number(b.dataset.idx))));
        refreshTotals();
      }
      drawLines();

      $('#btnAddLine').addEventListener('click',()=>{ je.lines.push({ accountId: state.accounts[0].id, desc:'', debit:0, credit:0, ccAlloc:{source:'none', split:[]} }); drawLines(); });
      $('#btnResetJE').addEventListener('click',()=>{ state.journalEntries[currentJEIndex]=structuredClone(demoState.journalEntries[0]); saveState(); renderJournal(); toast('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠØ¯'); });
      $('#btnSaveJE').addEventListener('click',()=>{
        je.id=$('#jeId').value; je.date=$('#jeDate').value; je.memo=$('#jeMemo').value;
        const v = validateJournal(je);
        if(!v.ok){ toast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ÙØ¸: '+v.msg); return; }
        state.journalEntries[currentJEIndex]=je; saveState(); pushAudit('SAVE_JE', je.id+" | "+je.date); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯');
      });

      function onLineEdit(e){
        const i=Number(e.target.dataset.idx); const k=e.target.dataset.k; let v=e.target.value;
        if(k==='debit'||k==='credit'){ v=Number(v)||0; if(k==='debit' && v>0) je.lines[i].credit=0; if(k==='credit' && v>0) je.lines[i].debit=0; }
        je.lines[i][k]=v;
        if(k==='accountId') applyAccountDefaults(je.lines[i]);
        drawLines();
      }

      function refreshTotals(){
        const td = sum(je.lines,x=>Number(x.debit)||0); const tc = sum(je.lines,x=>Number(x.credit)||0);
        $('#totDebit').textContent=fmt(td); $('#totCredit').textContent=fmt(tc);
        const ok = Math.abs(td-tc)<0.001; const badge=$('#balBadge');
        badge.textContent = ok? 'Ù…ØªÙˆØ§Ø²Ù† âœ…' : `ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù† â€” Ø§Ù„ÙØ§Ø±Ù‚: ${fmt(Math.abs(td-tc))}`;
        badge.className = 'badge '+(ok?'':'gold');
      }
    }

    function applyAccountDefaults(line){
      const acc=getAccount(line.accountId); const d=acc?.defaultCC||{mode:'none',split:[]};
      if(d.mode==='none'){ line.ccAlloc={source:'none', split:[]}; return; }
      line.ccAlloc={ source:'default', split:d.split.map(s=>({ccId:s.ccId, pct:s.pct})) };
    }

    function validateJournal(je){
      const td=sum(je.lines,x=>Number(x.debit)||0), tc=sum(je.lines,x=>Number(x.credit)||0);
      if(Math.abs(td-tc)>0.001) return {ok:false,msg:'Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†'};
      for(const ln of je.lines){
        const acc=getAccount(ln.accountId); const needCC=state.settings.enforceCCFor.includes(acc.type);
        if(needCC){
          const has = ln.ccAlloc && ln.ccAlloc.split && ln.ccAlloc.split.length>0;
          if(!has) return {ok:false,msg:`Ø§Ù„Ø­Ø³Ø§Ø¨ ${acc.id} (${acc.name}) ÙŠØªØ·Ù„Ø¨ Ù…Ø±Ø§ÙƒØ² ØªÙƒÙ„ÙØ©`};
        }
        const src = ln.ccAlloc?.source||'none';
        const accMode = acc.defaultCC?.mode||'none';
        if(accMode==='fixed' && src==='custom' && !state.settings.allowOverride){
          return {ok:false,msg:`Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªØ¬Ø§ÙˆØ² Ø§ÙØªØ±Ø§Ø¶ Ø«Ø§Ø¨Øª Ù„Ù„Ø­Ø³Ø§Ø¨ ${acc.id}`};
        }
        // ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙˆØ²ÙŠØ¹
        const mode = ln.ccAlloc?.split?.[0]?.pct!=null?'pct':'amt';
        if(mode==='pct'){
          const total = sum(ln.ccAlloc.split,x=>Number(x.pct)||0);
          if(Math.abs(total-100)>0.001) return {ok:false,msg:`Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø³Ø·Ø± Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ 100%`};
        }else{
          const base = (Number(ln.debit)||0) + (Number(ln.credit)||0);
          const total = sum(ln.ccAlloc.split,x=>Number(x.amt)||0);
          if(Math.abs(total-base)>0.001) return {ok:false,msg:`Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø·Ø±`};
        }
      }
      return {ok:true};
    }

    // ======= Ù†Ø§ÙØ°Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø·Ø± =======
    const modalSplit = $('#modal-split');
    let splitJE, splitIndex, splitDraft, splitDraftMode='pct';

    function openSplit(idx){
      const je = state.journalEntries[currentJEIndex]; const ln=je.lines[idx];
      splitJE=je; splitIndex=idx; splitDraftMode = (ln.ccAlloc?.split?.[0]?.pct!=null)?'pct':'amt';
      $('#splitMode').value=splitDraftMode;
      $('#splitLineTitle').textContent = `${getAccount(ln.accountId)?.id||''} â€” ${ln.desc||''}`;
      splitDraft = (ln.ccAlloc?.split||[]).map(s=>({ccId:s.ccId, pct:s.pct, amt:s.amt}));
      renderSplit(); modalSplit.showModal();
    }

    $('#splitMode').addEventListener('change',()=>{ splitDraftMode=$('#splitMode').value; renderSplit(); });
    $('#btnAddSplitLine').addEventListener('click',()=>{ splitDraft.push({ccId:state.costCenters[0].id, pct:0, amt:0}); renderSplit(); });

    function renderSplit(){
      const body=$('#splitBody'); body.innerHTML='';
      const visible = state.costCenters.filter(c=> state.settings.hideInactiveCC? c.active : true);
      $('#splitValueHdr').textContent = splitDraftMode==='pct'? 'Ø§Ù„Ù†Ø³Ø¨Ø© %' : 'Ø§Ù„Ù…Ø¨Ù„Øº';
      splitDraft.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><select data-k="ccId" data-i="${i}">${visible.map(c=>`<option value="${c.id}" ${c.id===r.ccId?'selected':''}>${c.name} (${c.id})</option>`).join('')}</select></td>
          <td><input type="number" step="0.01" min="0" data-k="${splitDraftMode}" data-i="${i}" value="${splitDraftMode==='pct'?(r.pct||0):(r.amt||0)}"></td>
          <td><button class="btn ghost" type="button" data-del="${i}">Ø­Ø°Ù</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('select,input').forEach(el=>el.addEventListener('input',e=>{
        const i=Number(e.target.dataset.i); const k=e.target.dataset.k; let v=e.target.value;
        if(k==='pct'||k==='amt') v=Number(v)||0; splitDraft[i][k]=v; renderSplit();
      }));
      body.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{ splitDraft.splice(Number(b.dataset.del),1); renderSplit(); }));

      // progress
      let total=0, hint='';
      if(splitDraftMode==='pct'){ total = sum(splitDraft,x=>Number(x.pct)||0); hint=`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${total.toFixed(2)}% â€” ÙŠØ¬Ø¨ 100%`; }
      else{ const ln = splitJE.lines[splitIndex]; const base=(Number(ln.debit)||0)+(Number(ln.credit)||0); total=sum(splitDraft,x=>Number(x.amt)||0); hint=`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ${fmt(total)} â€” Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø·Ø± ${fmt(base)}`; }
      $('#splitProgress').style.width = Math.min(100, splitDraftMode==='pct'? total : 100*(total/((Number(splitJE.lines[splitIndex].debit)||0)+(Number(splitJE.lines[splitIndex].credit)||0) || 1) ) )+"%";
      $('#splitHint').textContent=hint;
    }

    $('#btnSaveSplit').addEventListener('click',e=>{
      e.preventDefault();
      // validate
      if(splitDraftMode==='pct'){
        const t=sum(splitDraft,x=>Number(x.pct)||0); if(Math.abs(t-100)>0.001){ toast('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ø³Ø¨ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ 100%'); return; }
      }else{
        const ln = splitJE.lines[splitIndex]; const base=(Number(ln.debit)||0)+(Number(ln.credit)||0); const t=sum(splitDraft,x=>Number(x.amt)||0);
        if(Math.abs(t-base)>0.001){ toast('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù„Ø§ ÙŠØ³Ø§ÙˆÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ø·Ø±'); return; }
      }
      // save
      const je = splitJE; const ln = je.lines[splitIndex];
      const acc=getAccount(ln.accountId); const accMode=acc.defaultCC?.mode||'none';
      if(accMode==='fixed' && !state.settings.allowOverride){ toast('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø«Ø§Ø¨Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨'); return; }
      ln.ccAlloc = { source: accMode==='fixed'?'default':'custom', split: splitDraft.map(x=> splitDraftMode==='pct'? ({ccId:x.ccId,pct:Number(x.pct)||0}) : ({ccId:x.ccId,amt:Number(x.amt)||0}) ) };
      saveState(); pushAudit('SET_LINE_SPLIT', `${je.id} â€” Ø³Ø·Ø± ${splitIndex+1}`); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆØ²ÙŠØ¹'); modalSplit.close(); renderJournal();
    });

    // ======= Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ =======
    const modalPresets=$('#modal-presets');
    function openPresets(){ renderPresets(); modalPresets.showModal(); }
    function renderPresets(){
      const box=$('#presetsList');
      box.innerHTML = state.presets.map(p=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid #eee;padding:8px 0">
        <div><b>${p.name}</b> â€” ${p.split.map(s=>`${getCC(s.ccId)?.name||s.ccId}:${s.pct||0}%`).join(' | ')}</div>
        <div>
          <button class="btn ghost" data-act="apply" data-id="${p.id}">ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙØªÙˆØ­</button>
          <button class="btn danger" data-act="del" data-id="${p.id}">Ø­Ø°Ù</button>
        </div>
      </div>`).join('') || '<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨</div>';
      box.querySelectorAll('[data-act="del"]').forEach(b=>b.addEventListener('click',()=>{ state.presets=state.presets.filter(x=>x.id!==b.dataset.id); saveState(); renderPresets(); toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨'); }));
      box.querySelectorAll('[data-act="apply"]').forEach(b=>b.addEventListener('click',()=>{
        if(!modalSplit.open){ toast('Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø·Ø± Ø£ÙˆÙ„Ø§Ù‹'); return; }
        const p=state.presets.find(x=>x.id===b.dataset.id); if(!p) return; splitDraft = p.split.map(s=>({ccId:s.ccId,pct:s.pct})); splitDraftMode='pct'; $('#splitMode').value='pct'; renderSplit(); toast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨');
      }));
    }
    $('#btnPresetFromCurrent').addEventListener('click',()=>{
      if(!modalSplit.open){ toast('Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø·Ø± Ø«Ù… Ø§Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨'); return; }
      const name=$('#presetName').value.trim(); if(!name){ toast('Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‹Ø§ Ù„Ù„Ù‚Ø§Ù„Ø¨'); return; }
      const id='P-'+Math.random().toString(36).slice(2,8).toUpperCase();
      const split = splitDraftMode==='pct' ? splitDraft.map(x=>({ccId:x.ccId,pct:Number(x.pct)||0})) : null;
      if(!split){ toast('Ù„Ø§ ÙŠÙØ¯Ø¹Ù… Ø­ÙØ¸ Ù‚ÙˆØ§Ù„Ø¨ Ø¨Ø§Ù„Ù…Ø¨Ø§Ù„Øº â€” Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†ÙØ³ÙØ¨'); return; }
      state.presets.push({id,name,split}); saveState(); pushAudit('SAVE_PRESET', name); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨'); renderPresets();
    });
    $('#btnApplyPreset').addEventListener('click',openPresets);

    // ======= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =======
    const modalSettings=$('#modal-settings');
    function openSettings(){
      $('#enfExp').checked = state.settings.enforceCCFor.includes('expense');
      $('#enfRev').checked = state.settings.enforceCCFor.includes('revenue');
      $('#allowOverride').checked = state.settings.allowOverride;
      $('#hideInactiveCC').checked = state.settings.hideInactiveCC;
      modalSettings.showModal();
    }
    $('#btnSaveSettings').addEventListener('click',e=>{
      e.preventDefault();
      const enf=[]; if($('#enfExp').checked) enf.push('expense'); if($('#enfRev').checked) enf.push('revenue');
      state.settings.enforceCCFor=enf; state.settings.allowOverride=$('#allowOverride').checked; state.settings.hideInactiveCC=$('#hideInactiveCC').checked; saveState(); pushAudit('UPDATE_SETTINGS', JSON.stringify(state.settings)); toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'); modalSettings.close();
    });

    // ============== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§ÙƒØ² ==============
    function renderCenters(){
      const q=($('#globalSearch').value||'').trim();
      const rows = state.costCenters.filter(c=>!q || c.id.includes(q) || c.name.includes(q) || (c.group||'').includes(q));
      app.innerHTML = `
      <section class="card">
        <div class="toolbar">
          <label><input type="checkbox" id="toggleInactive" ${state.settings.hideInactiveCC?'checked':''}/> Ø¥Ø®ÙØ§Ø¡ ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø©</label>
        </div>
        <table>
          <thead><tr><th style="width:120px">Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th style="width:140px">Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th><th style="width:140px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
          <tbody>
            ${rows.filter(c=> state.settings.hideInactiveCC? c.active : true ).map(c=>`
              <tr>
                <td>${c.id}</td>
                <td>${c.name}</td>
                <td>${c.active?'<span class="badge blue">Ù†Ø´Ø·</span>':'<span class="badge">Ù…Ø®ÙÙŠ</span>'}</td>
                <td>${c.group||''}</td>
                <td>
                  <button class="btn secondary" data-act="edit" data-id="${c.id}">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button class="btn ghost" data-act="toggle" data-id="${c.id}">${c.active?'Ø¥Ø®ÙØ§Ø¡':'Ø¥Ø¸Ù‡Ø§Ø±'}</button>
                </td>
              </tr>`).join('')}
          </tbody>
        </table>
      </section>`;
      $('#toggleInactive').addEventListener('change',e=>{ state.settings.hideInactiveCC=e.target.checked; saveState(); renderCenters(); });
      $$('[data-act="toggle"]').forEach(b=>b.addEventListener('click',()=>{ const c=getCC(b.dataset.id); c.active=!c.active; saveState(); pushAudit('TOGGLE_CC', `${c.id} => ${c.active?'Ù†Ø´Ø·':'Ù…Ø®ÙÙŠ'}`); renderCenters(); }));
      $$('[data-act="edit"]').forEach(b=>b.addEventListener('click',()=>editCC(b.dataset.id)));
    }

    function addCC(){
      const id = prompt('ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙƒØ²ØŸ Ù…Ø«Ø§Ù„ CC-500'); if(!id) return;
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²ØŸ'); if(!name) return;
      state.costCenters.push({id,name,active:true,group:'Ø¹Ø§Ù…'}); saveState(); pushAudit('ADD_CC', id+" - "+name); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙƒØ² ØªÙƒÙ„ÙØ©'); if(activeTab!=='centers'){ activeTab='centers'; $$('.tab').forEach(t=>t.dataset.tab==='centers'&&t.click()); } else renderCenters();
    }
    function editCC(id){
      const c=getCC(id); const name=prompt('Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙƒØ²', c.name); if(!name) return; const group=prompt('Ø§Ù„ÙØ¦Ø©/Ø§Ù„Ù…Ø³ØªÙˆÙ‰', c.group||''); c.name=name; c.group=group; saveState(); pushAudit('EDIT_CC', id); toast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); renderCenters();
    }

    // ============== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ==============
    function renderReports(){
      // ØªØ¬Ù…ÙŠØ¹ Ù…Ø¨Ø³Ø· Ø­Ø³Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ© Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ù‚ÙŠÙˆØ¯
      const rows=[];
      for(const je of state.journalEntries){
        for(const ln of je.lines){
          const val=(Number(ln.debit)||0)-(Number(ln.credit)||0); // Ù…ÙˆØ¬Ø¨ Ù…ØµØ±ÙˆÙØŒ Ø³Ø§Ù„Ø¨ Ø¥ÙŠØ±Ø§Ø¯
          if(ln.ccAlloc && ln.ccAlloc.split && ln.ccAlloc.split.length){
            if(ln.ccAlloc.split[0].pct!=null){
              ln.ccAlloc.split.forEach(s=> rows.push({ date:je.date, acc:ln.accountId, memo:ln.desc||'', cc:s.ccId, amt: val*(s.pct/100) }));
            }else{
              const base=(Number(ln.debit)||0)+(Number(ln.credit)||0); // ÙŠÙˆØ²Ø¹ Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©
              const sign = (Number(ln.debit)||0) ? 1 : -1;
              ln.ccAlloc.split.forEach(s=> rows.push({ date:je.date, acc:ln.accountId, memo:ln.desc||'', cc:s.ccId, amt: sign*(Number(s.amt)||0) }));
            }
          }
        }
      }
      const byCC={}; rows.forEach(r=>{ byCC[r.cc]=(byCC[r.cc]||0)+r.amt; });
      const summary = Object.entries(byCC).map(([cc,amt])=>({cc, amt}));

      app.innerHTML = `
      <section class="grid cols-2">
        <div class="card">
          <h3 style="margin-top:0">Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</h3>
          ${summary.map(s=>`<div class="row" style="justify-content:space-between;border-bottom:1px dashed #e5e7eb;padding:6px 0">
            <div><b>${getCC(s.cc)?.name||s.cc}</b></div>
            <div>${fmt(s.amt)}</div>
          </div>`).join('')||'<div class="hint">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>'}
        </div>
        <div class="card">
          <div class="toolbar">
            <button class="btn ghost" id="btnExportCSV">ØªØµØ¯ÙŠØ± CSV</button>
            <button class="btn ghost" id="btnExportJSON">ØªØµØ¯ÙŠØ± JSON</button>
          </div>
          <table>
            <thead><tr><th style="width:120px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th style="width:140px">Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
            <tbody>
              ${rows.map(r=>`<tr><td>${r.date}</td><td>${r.acc}</td><td>${r.memo}</td><td>${getCC(r.cc)?.name||r.cc}</td><td>${fmt(r.amt)}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>
      </section>`;
      $('#btnExportCSV').addEventListener('click',()=>downloadText('report.csv', toCSV(rows)));
      $('#btnExportJSON').addEventListener('click',()=>downloadText('report.json', JSON.stringify(rows,null,2)));
    }

    function toCSV(arr){
      if(!arr.length) return '';
      const cols = Object.keys(arr[0]);
      const lines = [cols.join(',')].concat(arr.map(o=>cols.map(k=>JSON.stringify(o[k]??'')).join(',')));
      return lines.join('\n');
    }
    function downloadText(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù '+filename); }

    function doExport(){ downloadText('state.json', JSON.stringify(state,null,2)); }

    // ============== ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø³Ø¬Ù„ ==============
    function renderAudit(){
      app.innerHTML = `
        <section class="card">
          <table>
            <thead><tr><th style="width:160px">Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª</th><th style="width:220px">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„Ø­Ø¯Ø«</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead>
            <tbody>
              ${state.audit.map(a=>`<tr><td>${new Date(a.ts).toLocaleString('ar-EG')}</td><td>${a.user||'Local User'}</td><td>${a.action}</td><td>${a.details||''}</td></tr>`).join('')}
            </tbody>
          </table>
        </section>`;
    }

    // ============== Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø³Ø±ÙŠØ¹ ==============
    function addAccount(){
      const id=prompt('ÙƒÙˆØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ Ù…Ø«Ø§Ù„ 6300'); if(!id) return; const name=prompt('Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ'); if(!name) return; const type=prompt('Ø§Ù„Ù†ÙˆØ¹ØŸ expense / revenue / balance','expense');
      state.accounts.push({id,name,type,defaultCC:{mode:'none',split:[]}}); saveState(); pushAudit('ADD_ACCOUNT', id+" - "+name); toast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨'); if(activeTab!=='accounts'){ activeTab='accounts'; $$('.tab').forEach(t=>t.dataset.tab==='accounts'&&t.click()); } else renderAccounts();
    }

    // ============== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ==============
    render();
  </script>
</body>
</html>
