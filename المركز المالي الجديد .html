<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø²Ù…Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© â€“ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ</title>
  <style>
    :root{
      --ink:#111827; --muted:#6B7280; --line:#D1D5DB; --soft:#F3F4F6; --accent:#0F766E;
    }
    html,body{background:#fff;color:var(--ink);font:14px/1.8 "IBM Plex Sans Arabic","Segoe UI",Tahoma,Arial,sans-serif;margin:0}
    .container{max-width:950px;margin:18px auto;padding:16px}

    /* Header */
    .header{border-bottom:2px solid var(--line);padding-bottom:10px;margin-bottom:12px}
    .head-top{display:flex;align-items:center;gap:14px}
    .logo{width:110px;height:64px;border:1px dashed var(--line);display:flex;align-items:center;justify-content:center;color:var(--muted);border-radius:8px}
    .head-meta{flex:1}
    .company{font-size:20px;font-weight:700}
    .subtitle{font-size:13px;color:var(--muted)}
    .report-title{font-size:18px;font-weight:700;color:#000;margin-top:6px}
    .meta{display:flex;flex-wrap:wrap;gap:10px;color:var(--muted);font-size:12px;margin-top:6px}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin:8px 0 14px}
    .tab{border:1px solid var(--line);background:#fafafa;padding:6px 12px;border-radius:999px;cursor:pointer;font-size:13px}
    .tab.active{background:var(--accent);border-color:var(--accent);color:#fff}

    /* Card & table */
    .card{border:1px solid var(--line);border-radius:10px;overflow:hidden}
    .card h3{margin:0;padding:10px 12px;background:var(--soft);border-bottom:1px solid var(--line);font-size:14px}
    .section{padding:12px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:6px 6px;border-bottom:1px solid var(--line);font-size:13px}
    th{background:#F9FAFB;color:#374151;text-align:right}
    td.num{text-align:left;direction:ltr}

    /* Double underline for totals */
    .totline{border-bottom:2px solid #000}
    .totdouble{border-bottom:4px double #000}

    .footnote{font-size:12px;color:var(--muted);margin-top:12px}
    .sign{display:flex;justify-content:flex-start;margin-top:30px;color:#374151}
    .sign .line{width:220px;height:24px;border-bottom:1px solid #777}

    /* Controls */
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    .chip{border:1px solid var(--line);padding:6px 10px;border-radius:8px;background:#fafafa;font-size:13px}
    .chip input,.chip select{border:none;background:transparent;outline:none}
    .btn{background:#111827;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:13px}
    .btn.alt{background:#fff;color:var(--accent);border:1px solid var(--accent)}

    /* Print */
    @media print{
      @page{size:A4;margin:12mm}
      .tabs,.controls,.json{display:none!important}
      .container{padding:0}
    }

    /* JSON area */
    .json{margin-top:12px}
    textarea{width:100%;min-height:160px;border:1px solid var(--line);border-radius:8px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="head-top">
        <div class="logo">Ø´Ø¹Ø§Ø±</div>
        <div class="head-meta">
          <div class="company" id="company">Ø´Ø±ÙƒØ© Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©</div>
          <div class="subtitle">Ø§Ù„Ø£Ø­Ø³Ø§Ø¡ â€“ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
          <div class="report-title" id="docTitle">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙŠ 31 Ø¯ÙŠØ³Ù…Ø¨Ø± 2024Ù… (Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ)</div>
          <div class="meta">
            <div>Ù„Ù„ØªØ§Ø±ÙŠØ®: <span id="asof">31-12-2024</span></div>
            <div>Ø§Ù„Ø¹Ù…Ù„Ø©: <span id="currency">SAR</span></div>
            <div id="layoutTag">ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-view="bs">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
      <button class="tab" data-view="pl">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</button>
      <button class="btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn alt" id="btnReset">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
    </div>

    <!-- Controls -->
    <div class="controls">
      <label class="chip">Ø§Ù„Ø´Ø±ÙƒØ©: <input id="inpCompany" value="Ø´Ø±ÙƒØ© Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©"></label>
      <label class="chip">Ø§Ù„ØªØ§Ø±ÙŠØ®: <input id="inpDate" type="date" value="2024-12-31"></label>
      <label class="chip">Ø§Ù„Ø¹Ù…Ù„Ø©: <input id="inpCurr" value="SAR"></label>
      <label class="chip">Ù…Ø®ØµØµ Ø§Ù„Ø²ÙƒØ§Ø©: 
        <select id="zakatPlacement">
          <option value="balance" selected>Ø¶Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ (Ø§Ù„ØªØ²Ø§Ù…Ø§Øª)</option>
          <option value="income">Ø¶Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</option>
        </select>
      </label>
    </div>

    <!-- Balance Sheet -->
    <div id="view-bs" class="card">
      <h3>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
      <div class="section">
        <table id="tblBS">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¨Ù†Ø¯</th>
              <th class="num">2024/12/31</th>
              <th class="num">2023/12/31</th>
            </tr>
          </thead>
          <tbody id="bs-body"></tbody>
        </table>
        <div class="footnote">ØªØ¹ØªØ¨Ø± Ø§Ù„Ø¥ÙŠØ¶Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ø¬Ø²Ø¡Ù‹Ø§ Ù„Ø§ ÙŠØªØ¬Ø²Ø£ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©.</div>
        <div class="sign"><div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: &nbsp;</div><div class="line"></div></div>
      </div>
    </div>

    <!-- Income Statement -->
    <div id="view-pl" class="card" style="display:none">
      <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Ù…Ù„</h3>
      <div class="section">
        <table id="tblPL">
          <thead>
            <tr>
              <th>Ø§Ù„Ø¨Ù†Ø¯</th>
              <th class="num">2024</th>
              <th class="num">2023</th>
            </tr>
          </thead>
          <tbody id="pl-body"></tbody>
        </table>
        <div class="footnote">ØªØ¹ØªØ¨Ø± Ø§Ù„Ø¥ÙŠØ¶Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ø¬Ø²Ø¡Ù‹Ø§ Ù„Ø§ ÙŠØªØ¬Ø²Ø£ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ©.</div>
        <div class="sign"><div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: &nbsp;</div><div class="line"></div></div>
      </div>
    </div>

    <!-- JSON area -->
    <div class="json">
      <p class="subtitle">ğŸ”§ ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ JSON Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Ø£Ø¯Ù†Ø§Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø«Ø§Ù„). Ø«Ù… Ø¹Ø¯Ù‘Ù„ Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø­Ø³Ø¨ Ø­Ø§Ø¬ØªÙƒ.</p>
      <textarea id="jsonBox" dir="ltr"></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn alt" id="applyJson">ØªØ·Ø¨ÙŠÙ‚ JSON</button>
      </div>
    </div>
  </div>

  <script>
    // ------- Sample Data reflecting auditor style -------
    const sample = {
      company:"Ø´Ø±ÙƒØ© Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯Ø©",
      asOf:"2024-12-31",
      currency:"SAR",
      zakatPlacement:"balance", // balance | income
      balanceSheet:{
        currentAssets:[
          ["Ù†Ù‚Ø¯ Ø¨Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆÙ„Ø¯Ù‰ Ø§Ù„Ø¨Ù†ÙˆÙƒ", 339842, 223817],
          ["Ø¹Ù…Ù„Ø§Ø¡", 402315, 356213],
          ["Ù…Ø¯ÙŠÙ†ÙˆÙ† Ø£Ø·Ø±Ø§Ù Ø°Ø§Øª Ø¹Ù„Ø§Ù‚Ø©", 195870, 175650],
          ["Ù…Ø®Ø²ÙˆÙ†", 318461, 299432],
          ["Ø£Ø±ØµØ¯Ø© Ø£Ø®Ø±Ù‰", 72895, 65810]
        ],
        nonCurrentAssets:[
          ["Ù…Ù…ØªÙ„ÙƒØ§Øª ÙˆØ¢Ù„Ø§Øª ÙˆÙ…Ø¹Ø¯Ø§Øª ØµØ§ÙÙŠ", 1056650, 1012330]
        ],
        currentLiabilities:[
          ["Ù…ÙˆØ±Ø¯ÙˆÙ†", 525692, 507420],
          ["Ø°Ù…Ù… Ø¯Ø§Ø¦Ù†Ø© Ø£Ø®Ø±Ù‰", 172885, 162091],
          ["Ù‚Ø±ÙˆØ¶ Ù‚ØµÙŠØ±Ø© Ø§Ù„Ø£Ø¬Ù„", 91510, 90500]
        ],
        longTermLiabilities:[
          ["Ù‚Ø±ÙˆØ¶ Ø·ÙˆÙŠÙ„Ø© Ø§Ù„Ø£Ø¬Ù„", 327735, 315220]
        ],
        equity:[
          ["Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„", 900000, 900000],
          ["Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù†Ø¸Ø§Ù…ÙŠ", 120000, 120000],
          ["Ø£Ø±Ø¨Ø§Ø­ Ù…Ø¨Ù‚Ø§Ø©", 295733, 265338]
        ],
        zakatProvision:["Ù…Ø®ØµØµ Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø®Ù„", 50000, 47000]
      },
      incomeStatement:{
        rows:[
          ["Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª â€“ Ø¨Ø§Ù„ØµØ§ÙÙŠ", 9249413, 9655987],
          ["ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª", -8521501, -8051059],
          ["Ù…Ø¬Ù…Ù„ Ø§Ù„Ø¯Ø®Ù„", "calc"],
          ["Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø§Ø¹Ø¨Ø§Ø¡", -745073, -642941],
          ["Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ù…ÙˆÙ…ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ©", -425037, -315274],
          ["Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø£Ø¹Ø¨Ø§Ø¡", "sumPrev:3:5"],
          ["Ø¯Ø®Ù„ / Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", "calc"],
          ["Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…ØªÙØ±Ù‚Ø©", 175948, 181019],
          ["ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„Ø¶Ø±ÙŠØ¨Ø©", "calc"],
          ["Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ¶Ø±ÙŠØ¨Ø© Ø§Ù„Ø¯Ø®Ù„", -154485, -152000],
          ["ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø©", "calc"],
          ["Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ø¢Ø®Ø±", 0, 0],
          ["Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø³Ù†Ø©", "calc"]
        ]
      }
    };

    let state = JSON.parse(JSON.stringify(sample));

    function fmt(n){
      const sign = n<0?"(":"";
      const abs = Math.abs(+n||0);
      const txt = new Intl.NumberFormat('ar-EG',{maximumFractionDigits:0}).format(abs);
      return (n<0?`(${txt})`:txt);
    }

    function renderHeader(){
      document.getElementById('company').textContent = state.company;
      document.getElementById('asof').textContent = new Date(state.asOf).toLocaleDateString('ar-EG');
      document.getElementById('currency').textContent = state.currency;
      document.getElementById('docTitle').textContent =
        document.querySelector('.tab.active').dataset.view==='bs'
        ? `Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ ÙÙŠ ${new Date(state.asOf).toLocaleDateString('ar-EG')} (Ø¨Ø§Ù„${state.currency})`
        : `Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ÙÙŠ ${new Date(state.asOf).getFullYear()} (Ø¨Ø§Ù„${state.currency})`;
    }

    function addRow(tbody, label, cNow, cPrev, options={}){
      const tr = document.createElement('tr');
      if(options.header){ tr.innerHTML = `<th colspan="3">${label}</th>`; tbody.appendChild(tr); return; }
      tr.innerHTML = `<td>${label}</td><td class="num">${cNow!==''?fmt(cNow):''}</td><td class="num">${cPrev!==''?fmt(cPrev):''}</td>`;
      if(options.className){ tr.classList.add(options.className); }
      tbody.appendChild(tr);
    }

    function sumRows(arr){ return arr.reduce((a,b)=> a + (+b[1]||0), 0); }

    function renderBS(){
      const b = state.balanceSheet; const tb = document.getElementById('bs-body'); tb.innerHTML='';
      addRow(tb,'Ø£ØµÙˆÙ„', '', '', {header:true});
      addRow(tb,'Ø£ØµÙˆÙ„ Ù…ØªØ¯Ø§ÙˆÙ„Ø©', '', '', {header:true});
      b.currentAssets.forEach(r=> addRow(tb, r[0], r[1], r[2]));
      const totCA = sumRows(b.currentAssets); addRow(tb,'', '', '', {className:'totline'});
      addRow(tb,'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©', totCA, sumRows(b.currentAssets.map(x=>[x[0],x[2]])), {className:'totdouble'});

      addRow(tb,'Ù…Ù…ØªÙ„ÙƒØ§Øª ÙˆØ¢Ù„Ø§Øª ÙˆÙ…Ø¹Ø¯Ø§Øª â€“ ØµØ§ÙÙŠ', b.nonCurrentAssets[0][1], b.nonCurrentAssets[0][2]);
      const totalAssetsNow = totCA + (b.nonCurrentAssets[0][1]||0);
      const totalAssetsPrev = sumRows(b.currentAssets.map(x=>[x[0],x[2]])) + (b.nonCurrentAssets[0][2]||0);
      addRow(tb,'', '', '', {className:'totline'});
      addRow(tb,'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£ØµÙˆÙ„', totalAssetsNow, totalAssetsPrev, {className:'totdouble'});

      addRow(tb,'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', '', '', {header:true});
      addRow(tb,'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©', '', '', {header:true});
      b.currentLiabilities.forEach(r=> addRow(tb, r[0], r[1], r[2]));
      if(state.zakatPlacement==='balance' && b.zakatProvision){ addRow(tb, b.zakatProvision[0], b.zakatProvision[1], b.zakatProvision[2]); }
      const totCL = sumRows(b.currentLiabilities) + (state.zakatPlacement==='balance' ? (+b.zakatProvision?.[1]||0) : 0);
      const totCLprev = sumRows(b.currentLiabilities.map(x=>[x[0],x[2]])) + (state.zakatPlacement==='balance' ? (+b.zakatProvision?.[2]||0) : 0);
      addRow(tb,'', '', '', {className:'totline'});
      addRow(tb,'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¯Ø§ÙˆÙ„Ø©', totCL, totCLprev, {className:'totdouble'});

      addRow(tb,'Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', '', '', {header:true});
      b.equity.forEach(r=> addRow(tb, r[0], r[1], r[2]));
      const totEQ = sumRows(b.equity);
      const totEQprev = sumRows(b.equity.map(x=>[x[0],x[2]]));
      addRow(tb,'', '', '', {className:'totline'});
      addRow(tb,'Ù…Ø¬Ù…ÙˆØ¹ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', totEQ, totEQprev, {className:'totdouble'});

      const totLE = totCL + totEQ;
      const totLEprev = totCLprev + totEQprev;
      addRow(tb,'', '', '', {className:'totline'});
      addRow(tb,'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙˆØ­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©', totLE, totLEprev, {className:'totdouble'});
    }

    function computePL(rows){
      // helper to compute derived rows like "calc" or "sumPrev:a:b"
      const out = rows.map(r=> r.slice());
      function val(i){ const v = out[i][1]; return typeof v==='number'? v:0; }
      function valP(i){ const v = out[i][2]; return typeof v==='number'? v:0; }

      for(let i=0;i<out.length;i++){
        const [label, now, prev] = out[i];
        if(now==="calc"){ // simple running subtotal around common labels
          if(label.includes('Ù…Ø¬Ù…Ù„')){ // gross profit = revenues + cost (cost negative)
            let rev = 0, cost = 0, revP=0, costP=0;
            // assume row0 is revenue, row1 cost
            rev = out[0][1]; cost = out[1][1]; revP = out[0][2]; costP = out[1][2];
            out[i][1] = (rev||0) + (cost||0);
            out[i][2] = (revP||0) + (costP||0);
          } else if(label.includes('Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©')){
            // gross + other expenses (negative rows 3..5)
            const gp = out[2][1]; const gpP = out[2][2];
            let sumExp=0, sumExpP=0; for(let j=3;j<=5;j++){ sumExp += (out[j][1]||0); sumExpP += (out[j][2]||0); }
            out[i][1] = (gp||0) + sumExp; out[i][2] = (gpP||0) + sumExpP;
          } else if(label.includes('Ù‚Ø¨Ù„ Ø§Ù„Ø²ÙƒØ§Ø©')){
            const main = out[6][1]; const other = out[7][1];
            const mainP = out[6][2]; const otherP = out[7][2];
            out[i][1] = (main||0) + (other||0);
            out[i][2] = (mainP||0) + (otherP||0);
          } else if(label==='ØµØ§ÙÙŠ Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†Ø©'){
            // before zakat + zakat (negative)
            const b4 = out[8][1]; const zak = out[9][1];
            const b4p = out[8][2]; const zakp = out[9][2];
            out[i][1] = (b4||0) + (zak||0);
            out[i][2] = (b4p||0) + (zakp||0);
          } else if(label.includes('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø´Ø§Ù…Ù„')){
            const net = out[10][1]; const oci = out[11][1];
            const netP = out[10][2]; const ociP = out[11][2];
            out[i][1] = (net||0) + (oci||0);
            out[i][2] = (netP||0) + (ociP||0);
          }
        } else if(typeof now==='string' && now.startsWith('sumPrev:')){
          const [a,b] = now.split(':').slice(1).map(Number);
          let s=0, sp=0; for(let k=a;k<=b;k++){ s += (out[k][1]||0); sp += (out[k][2]||0); }
          out[i][1] = s; out[i][2] = sp;
        }
      }
      // if zakat is selected to go to balance sheet, set row 9 to 0
      if(state.zakatPlacement==='balance'){
        out[9][1] = 0; out[9][2] = 0; // remove from P&L if shown in BS
        // and recalc dependent rows
        out[10][1] = (out[8][1]||0) + (out[9][1]||0);
        out[10][2] = (out[8][2]||0) + (out[9][2]||0);
        out[12][1] = (out[10][1]||0) + (out[11][1]||0);
        out[12][2] = (out[10][2]||0) + (out[11][2]||0);
      }
      return out;
    }

    function renderPL(){
      const tb = document.getElementById('pl-body'); tb.innerHTML='';
      const rows = computePL(state.incomeStatement.rows);
      rows.forEach((r,idx)=>{
        const cls = (r[0].startsWith('Ù…Ø¬Ù…ÙˆØ¹') || r[0].startsWith('ØµØ§ÙÙŠ') || r[0].startsWith('Ø¥Ø¬Ù…Ø§Ù„ÙŠ')) ? 'totdouble' : (r[0].includes('Ù…Ø¬Ù…Ù„')||r[0].includes('Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©')) ? 'totline' : '';
        addRow(tb, r[0], r[1], r[2], {className:cls});
      });
    }

    function renderAll(){
      renderHeader();
      renderBS();
      renderPL();
      document.getElementById('jsonBox').value = JSON.stringify(state, null, 2);
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', e=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const v = e.currentTarget.dataset.view;
        document.getElementById('view-bs').style.display = v==='bs'? 'block':'none';
        document.getElementById('view-pl').style.display = v==='pl'? 'block':'none';
        renderHeader();
      })
    })

    // Controls
    document.getElementById('inpCompany').addEventListener('input', e=>{ state.company=e.target.value; renderAll(); })
    document.getElementById('inpDate').addEventListener('change', e=>{ state.asOf=e.target.value; renderAll(); })
    document.getElementById('inpCurr').addEventListener('input', e=>{ state.currency=e.target.value||'SAR'; renderAll(); })
    document.getElementById('zakatPlacement').addEventListener('change', e=>{ state.zakatPlacement=e.target.value; renderAll(); })

    document.getElementById('applyJson').addEventListener('click', ()=>{
      try{ const obj = JSON.parse(document.getElementById('jsonBox').value); state = obj; renderAll(); }
      catch(e){ alert('ØµÙŠØºØ© JSON ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); }
    })
    document.getElementById('btnReset').addEventListener('click', ()=>{ state = JSON.parse(JSON.stringify(sample)); renderAll(); })

    // Init
    renderAll();
  </script>
</body>
</html>
