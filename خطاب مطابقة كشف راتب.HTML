<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø®Ø·Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ â€” Ù†Ø³Ø®Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© v1.1</title>
  <meta name="description" content="ÙˆØ§Ø¬Ù‡Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØªÙ‚Ø§Ø±ÙŠØ± ÙˆØªØªØ¨Ù‘Ø¹." />
  <style>
    /* ==========================
       Reset & Base
    ========================== */
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --primary: #0ea5e9; /* sky-500 */
      --primary-600: #0284c7;
      --bg: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --ink-2: #334155; /* slate-700 */
      --muted: #f1f5f9; /* slate-100 */
      --muted-2:#e2e8f0; /* slate-200 */
      --border: #e2e8f0; /* slate-200 */
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --focus: #60a5fa;
      --card: #ffffff;
    }
    [data-theme="dark"] {
      --bg: #0b1220; /* deep navy */
      --ink: #e5e7eb;
      --ink-2: #cbd5e1;
      --muted: #0f172a;
      --muted-2:#1f2937;
      --border: #1f2937;
      --card: #0e1628;
    }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--ink); font: 400 15px/1.65 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", Tahoma, sans-serif; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    button, input, select, label, textarea { font: inherit; }
    .container { max-width: 1320px; margin-inline: auto; padding: 0 16px; }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px); white-space: nowrap; }

    /* ==========================
       Header
    ========================== */
    header.site-header { position: sticky; top: 0; z-index: 60; background: var(--bg); border-bottom: 1px solid var(--border); backdrop-filter: blur(6px); }
    .header-inner { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 12px 0; }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo { inline-size: 36px; block-size: 36px; border-radius: 10px; background: radial-gradient(120% 120% at 10% 10%, var(--primary), var(--primary-600)); display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.3px; box-shadow: 0 6px 18px rgba(2,132,199,.25); }
    nav ul { margin: 0; padding: 0; list-style: none; display: flex; gap: 6px; }
    nav a, nav button { display: inline-flex; align-items: center; padding: 8px 10px; border-radius: 10px; border: 1px solid transparent; background: transparent; color: var(--ink); }
    nav a:is(:hover, :focus-visible), nav button:is(:hover, :focus-visible) { background: var(--muted); outline: none; }

    /* ==========================
       Layout
    ========================== */
    main { display: grid; grid-template-columns: 330px 1fr; gap: 16px; padding: 16px 0 0; }
    @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }

    aside.card, section.card { position: relative; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: 0 2px 10px rgba(2,6,23,.04); }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .subtle { color: var(--ink-2); font-size: 13px; }

    .field { display: grid; gap: 6px; margin: 10px 0; }
    .row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

    .btn { appearance: none; border: 1px solid var(--muted-2); background: #fff; color: var(--ink); padding: 8px 12px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: .15s ease; }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 6px 16px rgba(14,165,233,.25); }
    .btn.ghost { background: transparent; }
    .btn:is(:hover) { transform: translateY(-1px); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:is(:focus-visible) { outline: 2px solid var(--focus); outline-offset: 2px; }

    section.results { padding: 0; overflow: hidden; }
    .toolbar { display:flex; gap:8px; align-items:center; padding: 12px; border-bottom: 1px solid var(--border); background: linear-gradient(0deg, var(--bg), #fff); position: sticky; top: 56px; z-index: 5; }
    .toolbar .grow { flex: 1; }
    .input { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: #fff; padding: 8px 10px; border-radius: 10px; }
    .input input { border: 0; outline: none; background: transparent; min-inline-size: 160px; }
    .select, .input, textarea { border-radius: 10px; }
    .select { border: 1px solid var(--border); background:#fff; padding: 8px 10px; }
    .checkbox { display:inline-flex; gap:8px; align-items:center; }

    /* Table */
    .table-wrap { overflow:auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th { position: sticky; top: calc(56px + 48px); background: var(--muted); z-index: 4; text-align: start; font-weight: 700; padding: 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tbody tr.selectable:hover { background: #f8fafc; }
    tbody tr.selected { background: #eef6ff; outline: 2px solid #dbeafe; }

    .status-pill { display:inline-flex; align-items:center; gap:6px; padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid var(--border); }
    .status-sent { background:#ecfdf5; border-color:#bbf7d0; }
    .status-pending { background:#fff7ed; border-color:#fed7aa; }
    .status-rejected { background:#fef2f2; border-color:#fecaca; }
    .status-confirmed { background:#eff6ff; border-color:#bfdbfe; }
    .status-matched { background:#ecfdf5; border-color:#bbf7d0; }
    .status-mismatch { background:#fef2f2; border-color:#fecaca; }
    .status-review { background:#fff7ed; border-color:#fed7aa; }

    .badge { font-size: 11px; padding: 2px 6px; border:1px solid var(--muted-2); border-radius: 999px; }

    .details { grid-column: 1 / -1; background: #fcfdff; border-inline-start: 4px solid var(--primary); display: none; }
    .details.open { display: table-row; animation: fade .2s ease-in; }
    @keyframes fade { from { opacity: 0 } to { opacity: 1 } }

    .empty { padding: 32px; text-align: center; color: var(--ink-2); }

    footer { margin: 16px 0 24px; color: var(--ink-2); font-size: 13px; display:flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; }

    /* ==========================
       Modals & Overlays
    ========================== */
    dialog.modal { border: 0; border-radius: 16px; padding: 0; width: min(100% - 24px, 1000px); }
    .modal header { padding: 12px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content: space-between; }
    .modal .content { padding: 16px; max-block-size: 70vh; overflow: auto; background: var(--bg); }
    .modal footer { padding: 12px 16px; border-top: 1px solid var(--border); display:flex; gap: 8px; justify-content: end; }
    dialog::backdrop { background: rgba(0,0,0,.35); }

    .settings-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .template-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Toasts */
    .toasts { position: fixed; inset-inline-start: 16px; inset-block-end: 16px; display: grid; gap: 10px; z-index: 100; }
    .toast { background: #fff; color: var(--ink); border: 1px solid var(--border); border-inline-start: 4px solid var(--primary); padding: 10px 12px; border-radius: 12px; display:flex; align-items: start; gap: 10px; min-width: 280px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .toast.success { border-inline-start-color: var(--success); }
    .toast.warn { border-inline-start-color: var(--warn); }
    .toast.danger { border-inline-start-color: var(--danger); }
    .toast button { margin-inline-start: auto; }

    /* Spinner */
    .spinner { position: fixed; inset: 0; display: none; place-items: center; background: rgba(255,255,255,.6); z-index: 90; }
    .spinner .ring { inline-size: 56px; block-size: 56px; border: 6px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(-360deg); } }

    /* ==========================
       Print Styles (letters only)
    ========================== */
    @media print {
      body { background: #fff; }
      header.site-header, aside.card, .toolbar, .table-wrap, footer, .toasts, .spinner, #rulesCard { display: none !important; }
      .print-letters { display: block !important; }
      .letter { page-break-after: always; break-after: page; }
      .letter:last-child { page-break-after: auto; break-after: auto; }
    }

    /* Letter (Preview HTML) */
    .letter { color: #111827; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .letter header { display:flex; align-items:center; justify-content: space-between; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 12px; }
    .letter .brand { gap: 10px; }
    .letter h3 { margin: 0; font-size: 18px; }
    .info-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 14px; font-size: 14px; margin: 10px 0 6px; }
    .reply-slip { margin-top: 12px; border-top: 2px dashed #cbd5e1; padding-top: 10px; }
    .qr { inline-size: 72px; block-size: 72px; background: repeating-linear-gradient(45deg, #000 0 4px, #fff 4px 8px); border-radius: 6px; }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="brand" aria-label="Ø§Ù„Ù…Ø¤Ø³Ø³Ø©">
        <div class="logo" aria-hidden="true">SL</div>
        <div>
          <div style="font-weight:800">Smart Life â€” Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
          <div class="subtle">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ â€” Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ‡ÙŠØ¦Ø©</div>
        </div>
      </div>
      <nav aria-label="Ø±ÙˆØ§Ø¨Ø· Ø±Ø¦ÙŠØ³ÙŠØ©">
        <ul>
          <li><a href="#" aria-current="page">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li><a href="#" id="openRulesBtn" title="Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©">Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</a></li>
          <li><a href="#" id="openTemplateBtn" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨">Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨</a></li>
          <li><button class="btn ghost" id="toggleTheme" aria-pressed="false" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">ğŸŒ™</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <main id="main" role="main">
      <!-- Sidebar / Filters -->
      <aside class="card" aria-label="ÙÙ„Ø§ØªØ± ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
        <h2>Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
        <div class="subtle">ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø·Ø±Ø§Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ù….</div>
        <div class="field row" aria-label="Ø§Ù„ÙØªØ±Ø©">
          <div class="field">
            <label for="fromDate">Ù…Ù†</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="field">
            <label for="toDate">Ø¥Ù„Ù‰</label>
            <input id="toDate" type="date" />
          </div>
        </div>

        <div class="field" role="group" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø·Ø±Ù">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ø±Ù</label>
          <div class="row">
            <label class="checkbox"><input type="radio" name="ptype" value="all" checked /> Ø§Ù„ÙƒÙ„</label>
            <label class="checkbox"><input type="radio" name="ptype" value="customer" /> Ø¹Ù…ÙŠÙ„</label>
            <label class="checkbox"><input type="radio" name="ptype" value="vendor" /> Ù…ÙˆØ±Ø¯</label>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="branchSelect">Ø§Ù„ÙØ±Ø¹</label>
            <select id="branchSelect" class="select"></select>
          </div>
          <div class="field">
            <label for="currencySelect">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
            <select id="currencySelect" class="select"></select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="minBalance">Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±ØµÙŠØ¯</label>
            <input id="minBalance" type="number" inputmode="decimal" placeholder="0" />
          </div>
          <div class="field">
            <label for="confirmType">Ù†ÙˆØ¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label>
            <select id="confirmType" class="select">
              <option value="positive">Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</option>
              <option value="negative">Ø³Ù„Ø¨ÙŠ</option>
              <option value="any">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label class="checkbox"><input id="includeUnapplied" type="checkbox" /> ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø­Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ø¨Ù‘Ù‚Ø©</label>
        </div>

        <div class="actions">
          <button class="btn primary" id="applyFilters">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          <button class="btn" id="resetFilters">ØªØµÙÙŠØ±</button>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)"/>
        <div class="field">
          <label>Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</label>
          <label class="checkbox"><input id="autoSave" type="checkbox" checked /> Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­</label>
        </div>
      </aside>

      <!-- Results / Grid -->
      <section class="results card" aria-live="polite" aria-busy="false">
        <div class="toolbar" role="region" aria-label="Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª">
          <div class="input grow" aria-label="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹">
            ğŸ”
            <input id="q" type="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ø·Ø±Ù" />
          </div>
          <select id="sortBy" class="select" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
            <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
            <option value="code">Ø§Ù„ÙƒÙˆØ¯</option>
            <option value="balance">Ø§Ù„Ø±ØµÙŠØ¯</option>
          </select>
          <label class="checkbox" title="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"><input id="selectAll" type="checkbox" /> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
          <button class="btn" id="btnCalc">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
          <button class="btn" id="btnGenerate">ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø§Ø¨Ø§Øª</button>
          <button class="btn" id="btnEmail">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
          <button class="btn" id="btnZip">ØªÙ†Ø²ÙŠÙ„ ZIP</button>
          <button class="btn" id="btnPDF">PDF Ù…Ø¯Ù…Ø¬</button>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table aria-describedby="tableCaption">
            <caption id="tableCaption" class="visually-hidden">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø·Ø±Ø§Ù</caption>
            <thead>
              <tr>
                <th style="width:36px"></th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø±Ù</th>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                <th>Ø¹Ù…Ø± Ø§Ù„Ø¯ÙŠÙ†</th>
                <th>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø§Ø¨</th>
                <th style="width:48px">ØªÙØ§ØµÙŠÙ„</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="emptyState" class="empty" hidden>Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø«.</div>
        </div>
      </section>
    </main>

    <section id="rulesCard" class="card" aria-label="Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©">
      <h2>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ù…Ù„Ø®Øµ)</h2>
      <div class="subtle">ØªÙØ·Ø¨Ù‘ÙÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ù† "Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©".</div>
      <ul id="rulesSummary" style="margin:8px 0 0 0; padding-inline-start: 18px; line-height:1.8"></ul>
    </section>

    <footer>
      <div>Ù†Ø³Ø®Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: v1.1 â€” (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·)</div>
      <div id="genTime">ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯: â€”</div>
      <div><a href="#" target="_blank" rel="noopener">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></div>
    </footer>

    <!-- Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ÙŠ -->
    <section aria-label="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" class="card">
      <h3 style="margin-top:0">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ÙŠ</h3>
      <ol id="auditLog" start="1" style="margin:0; padding-inline-start: 22px;"></ol>
      <p class="subtle" style="margin-top:8px">* ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„Ø¥Ø®ÙØ§Ø¡.</p>
    </section>
  </div>

  <!-- Modals -->
  <dialog id="previewModal" class="modal" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨">
    <header>
      <strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨</strong>
      <button class="btn" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="content">
      <div id="previewArea"></div>
    </div>
    <footer>
      <button class="btn" id="printLetter">Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="downloadLetter">ØªÙ†Ø²ÙŠÙ„ HTML</button>
      <button class="btn primary" data-close>ØªÙ…</button>
    </footer>
  </dialog>

  <dialog id="templateModal" class="modal" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨">
    <header>
      <strong>Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©</strong>
      <button class="btn" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="content">
      <div class="template-grid">
        <label class="field">
          <span>Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø¥ÙŠØ¬Ø§Ø¨ÙŠ)</span>
          <textarea id="tplPositive" rows="6" placeholder="Ù†Øµ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ù…Ø¹ Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø«Ù„ {party}, {balance}, {code}, {branch}"></textarea>
        </label>
        <label class="field">
          <span>Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø³Ù„Ø¨ÙŠ)</span>
          <textarea id="tplNegative" rows="6" placeholder="Ù†Øµ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ù„Ø¨ÙŠ Ù…Ø¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª"></textarea>
        </label>
        <div class="field">
          <label class="checkbox"><input id="showOrg" type="checkbox" checked /> Ø¥Ø¸Ù‡Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <label class="checkbox"><input id="showReply" type="checkbox" checked /> Ø¥Ø¸Ù‡Ø§Ø± Ù‚ØµØ§ØµØ© Ø§Ù„Ø±Ø¯</label>
          <label class="checkbox"><input id="showMoves" type="checkbox" checked /> Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª</label>
          <label class="checkbox"><input id="showQR" type="checkbox" /> Ø¥Ø¸Ù‡Ø§Ø± QR</label>
          <small class="subtle">Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ: {party}, {code}, {branch}, {currency}, {balance}, {today}</small>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn" id="saveTemplate">Ø­ÙØ¸</button>
      <button class="btn" id="resetTemplate">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      <button class="btn primary" data-close>ØªÙ…</button>
    </footer>
  </dialog>

  <dialog id="rulesModal" class="modal" aria-label="Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©">
    <header>
      <strong>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</strong>
      <button class="btn" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="content">
      <div class="settings-grid">
        <div class="card" style="border:1px dashed var(--border)">
          <h3 style="margin-top:0">Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
          <div class="field">
            <label for="tolAmount">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠ (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø©)</label>
            <input id="tolAmount" type="number" inputmode="decimal" placeholder="0" />
            <small class="subtle">Ù…Ø«Ø§Ù„: 5.00 â€” ÙŠØ¹ØªØ¨Ø± Ø§Ù„ÙØ±Ù‚ Ø­ØªÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº Ù…ÙØ·Ø§Ø¨ÙÙ‚Ù‹Ø§.</small>
          </div>
          <div class="field">
            <label for="tolPercent">Ù‡Ø§Ù…Ø´ Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„Ù†Ø³Ø¨ÙŠ (%)</label>
            <input id="tolPercent" type="number" inputmode="decimal" placeholder="0" />
            <small class="subtle">Ù…Ø«Ø§Ù„: 1% Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ â€” ÙŠÙØ³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©.</small>
          </div>
          <div class="field">
            <label class="checkbox"><input id="requireZeroUnapplied" type="checkbox" /> Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØµØ­ÙŠØ­Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© = ØµÙØ±</label>
          </div>
          <div class="field">
            <label class="checkbox"><input id="autoDisputeNegative" type="checkbox" /> ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ "Ù…Ø¹ØªØ±Ø¶" Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± ØªØ£ÙƒÙŠØ¯ Ø³Ù„Ø¨ÙŠ</label>
          </div>
        </div>

        <div class="card" style="border:1px dashed var(--border)">
          <h3 style="margin-top:0">Ø³Ù„ÙˆÙƒ Ø§Ù„Ø­Ø§Ù„Ø©</h3>
          <div class="field">
            <label for="defaultStatus">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
            <select id="defaultStatus" class="select">
              <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
              <option value="matched">Ù…Ø·Ø§Ø¨Ù‚</option>
              <option value="mismatch">ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚</option>
            </select>
          </div>
          <div class="field">
            <label class="checkbox"><input id="allowManualOverride" type="checkbox" checked /> Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ø¹ Ø³Ø¨Ø¨</label>
          </div>
          <div class="field">
            <label for="noteTemplate">Ù‚Ø§Ù„Ø¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</label>
            <textarea id="noteTemplate" rows="4" placeholder="Ù…Ø«Ø§Ù„: ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø§Ù…Ø´ Ø³Ù…Ø§Ø­ÙŠØ© {tolAmount} ÙˆØ§Ù„ÙØ±Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ {diff}"></textarea>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn" id="saveRules">Ø­ÙØ¸</button>
      <button class="btn primary" data-close>ØªÙ…</button>
    </footer>
  </dialog>

  <!-- Overlays -->
  <div class="spinner" id="spinner" aria-live="polite" aria-busy="false"><div class="ring" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"></div></div>
  <div class="toasts" id="toasts" aria-live="polite"></div>

  <!-- Print container for merged PDF (HTML) -->
  <div id="printContainer" class="print-letters" hidden></div>

  <script>
    /* ============================================================
       Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Dummy Data)
    ============================================================ */
    const branches = [{id:"R", name:"Ø§Ù„Ø±ÙŠØ§Ø¶"},{id:"K", name:"Ø§Ù„Ø®Ø¨Ø±"}];
    const currencies = [{code:"SAR", name:"Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ"},{code:"USD", name:"Ø¯ÙˆÙ„Ø§Ø±"}];
    const parties = [
      {id:1, type:"customer", name:"Ù…Ø¤Ø³Ø³Ø© Ø¨Ù‡Ø§Ø¡ Ø¹Ø³ÙŠØ±", code:"C-001", branch:"R", currency:"SAR", balance: 18250.75, aging:"30-60", lastLetter:{date:"2025-03-01", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:2, type:"customer", name:"Ø´Ø±ÙƒØ© Ù†Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„", code:"C-002", branch:"K", currency:"SAR", balance: 0, aging:"0-30", lastLetter:null},
      {id:3, type:"vendor", name:"Ø£ØµØ§Ù„Ø© Ø§Ù„Ø¬Ù†ÙˆØ¨", code:"V-019", branch:"R", currency:"SAR", balance: 5400, aging:">90", lastLetter:{date:"2025-02-10", type:"negative", status:"Ù…Ø¹ØªØ±Ø¶"}},
      {id:4, type:"customer", name:"Ø´Ø±ÙƒØ© Ø±ÙˆÙ‘Ø§Ø¯ Ø§Ù„Ù†Ø¸Ù…", code:"C-014", branch:"K", currency:"SAR", balance: 1220.10, aging:"0-30", lastLetter:{date:"2025-01-15", type:"positive", status:"Ù…Ø¤ÙƒØ¯"}},
      {id:5, type:"vendor", name:"ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø³Ø­Ø§Ø¨", code:"V-022", branch:"R", currency:"USD", balance: 310.00, aging:"30-60", lastLetter:{date:"2025-02-21", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:6, type:"customer", name:"Ù…ØªØ§Ø¬Ø± Ø§Ù„ÙˆÙØ±Ø©", code:"C-099", branch:"R", currency:"SAR", balance: 9800.00, aging:"60-90", lastLetter:{date:"2025-04-01", type:"positive", status:"Ù…Ø¹Ù„Ù‘Ù‚"}},
      {id:7, type:"vendor", name:"Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø­Ø¯ÙŠØ«", code:"V-120", branch:"K", currency:"SAR", balance: 50.75, aging:"0-30", lastLetter:null},
      {id:8, type:"customer", name:"Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ÙŠØ±Ø©", code:"C-201", branch:"K", currency:"SAR", balance: 25000.00, aging:">90", lastLetter:{date:"2025-03-25", type:"negative", status:"Ù…Ø¹ØªØ±Ø¶"}},
      {id:9, type:"customer", name:"Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø´ÙØ§Ø¡", code:"C-341", branch:"R", currency:"SAR", balance: 150.00, aging:"0-30", lastLetter:{date:"2024-12-29", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:10, type:"vendor", name:"Ù…Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„", code:"V-211", branch:"K", currency:"USD", balance: 0, aging:"0-30", lastLetter:null},
      {id:11, type:"customer", name:"Ø³Ù†Ø§ Ø§Ù„Ù…Ø¬Ø±Ø©", code:"C-412", branch:"R", currency:"SAR", balance: 610.90, aging:"30-60", lastLetter:null},
      {id:12, type:"customer", name:"Ø§Ù„Ù…Ø§Ø³ Ø§Ù„Ø°Ù‡Ø¨ÙŠ", code:"C-555", branch:"K", currency:"SAR", balance: 120000.45, aging:">90", lastLetter:{date:"2025-05-11", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:13, type:"vendor", name:"Ø£Ø·ÙŠØ§Ø¨ Ø§Ù„Ù‚ØµÙŠÙ…", code:"V-310", branch:"R", currency:"SAR", balance: 70.00, aging:"0-30", lastLetter:{date:"2025-03-03", type:"negative", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:14, type:"customer", name:"Ø³ÙÙŠØ± Ø§Ù„Ø¨Ù†Ø§Ø¡", code:"C-777", branch:"R", currency:"SAR", balance: 4321.00, aging:"60-90", lastLetter:{date:"2025-02-05", type:"positive", status:"Ù…Ø¹Ù„Ù‘Ù‚"}},
      {id:15, type:"vendor", name:"Ø£Ù†Ø¸Ù…Ø© Ø±Ø´ÙŠÙ‚Ø©", code:"V-404", branch:"K", currency:"SAR", balance: 889.90, aging:"30-60", lastLetter:null},
    ];

    const openItems = {
      1: [{doc:"INV-101", date:"2025-01-10", due:"2025-02-10", amount: 7250, unapplied: 0}],
      2: [{doc:"INV-220", date:"2025-03-05", due:"2025-04-05", amount: 4200, unapplied: 300}],
      3: [{doc:"BILL-778", date:"2024-12-20", due:"2025-01-20", amount: 5400, unapplied: 0}],
      4: [{doc:"INV-330", date:"2025-02-02", due:"2025-03-02", amount: 1220.1, unapplied: 0}],
      6: [{doc:"INV-991", date:"2025-04-10", due:"2025-05-10", amount: 9800, unapplied: 0}],
      8: [{doc:"INV-880", date:"2025-01-11", due:"2025-02-11", amount: 25000, unapplied: 0}],
      12:[{doc:"INV-1001", date:"2025-05-01", due:"2025-06-01", amount: 120000.45, unapplied: 0}],
      14:[{doc:"INV-712", date:"2025-01-22", due:"2025-02-22", amount: 4321, unapplied: 0}],
    };

    /* ============================================================
       Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ + LocalStorage
    ============================================================ */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const state = {
      filters: {
        fromDate: '', toDate: '',
        ptype: 'all', branch: 'all', currency: 'all',
        minBalance: 0, confirmType: 'positive', includeUnapplied: false,
        q: '', sortBy: 'name'
      },
      template: {
        positive: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø³Ø¬Ù„Ø§ØªÙ†Ø§. Ø§Ù„Ø·Ø±Ù: {party} ({code}) â€” Ø§Ù„ÙØ±Ø¹: {branch} â€” Ø§Ù„Ø±ØµÙŠØ¯: {balance}. Ù†Ø±Ø¬Ùˆ ØªØ£ÙƒÙŠØ¯ÙƒÙ… Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ {today}.',
        negative: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ Ù„Ù„Ø·Ø±Ù: {party} ({code}). Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ø¯ÙŠÙ†Ø§: {balance}. Ù†Ø£Ù…Ù„ Ø§Ù„ØªØ²ÙˆÙŠØ¯ Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ {today}.',
        showOrg: true, showReply: true, showMoves: true, showQR: false
      },
      rules: {
        tolAmount: 5.00,
        tolPercent: 1.0,
        requireZeroUnapplied: false,
        autoDisputeNegative: true,
        defaultStatus: 'pending',
        allowManualOverride: true,
        noteTemplate: 'ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù‡Ø§Ù…Ø´ Ø³Ù…Ø§Ø­ÙŠØ© {tolAmount} (Ùˆ/Ø£Ùˆ {tolPercent}%) â€” Ø§Ù„ÙØ§Ø±Ù‚ Ø§Ù„ÙØ¹Ù„ÙŠ: {diff}.'
      },
      selected: new Set(),
      generatedMap: new Map(), // id -> HTML string
      partyStatus: new Map(), // id -> { result, status, note }
      user: { name: 'Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ' }
    };

    const STORAGE_KEY = 'match_letters_pro_v11';
    const saveAll = () => {
      if (!$('#autoSave').checked) return;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };
    const loadAll = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const obj = JSON.parse(raw);
        Object.assign(state.filters, obj.filters || {});
        Object.assign(state.template, obj.template || {});
        Object.assign(state.rules, obj.rules || {});
      } catch {}
    };

    /* ============================================================
       Helpers
    ============================================================ */
    function toast(msg, type='success', timeout=3000) {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div>${msg}</div><button class="btn ghost" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>`;
      const wrap = $('#toasts');
      wrap.appendChild(t);
      const close = () => t.remove();
      t.querySelector('button').addEventListener('click', close);
      if (timeout) setTimeout(close, timeout);
    }
    function setBusy(busy) {
      const sp = $('#spinner');
      sp.style.display = busy ? 'grid' : 'none';
      sp.setAttribute('aria-busy', String(busy));
    }
    function formatCurrency(amount, code) {
      return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: code || 'SAR', maximumFractionDigits: 2 }).format(amount);
    }
    function audit(action, detail='') {
      const li = document.createElement('li');
      const ts = new Date().toLocaleString('ar-SA');
      li.textContent = `[${ts}] ${state.user.name} â€” ${action}${detail ? ' â€” ' + detail : ''}`;
      $('#auditLog').prepend(li);
    }
    function summarizeRules(){
      const r = state.rules;
      const ul = $('#rulesSummary');
      ul.innerHTML = `
        <li>Ù‡Ø§Ù…Ø´ Ø³Ù…Ø§Ø­ÙŠØ© Ù…Ø§Ù„ÙŠ: <strong>${r.tolAmount}</strong> + Ù‡Ø§Ù…Ø´ Ù†Ø³Ø¨ÙŠ: <strong>${r.tolPercent}%</strong></li>
        <li>${r.requireZeroUnapplied ? 'ÙŠØ´ØªØ±Ø· Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø­Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© = 0' : 'Ù„Ø§ ÙŠØ´ØªØ±Ø· ØµÙØ± Ø­Ø±ÙƒØ§Øª ØºÙŠØ± Ù…Ø·Ø¨Ù‚Ø©'}</li>
        <li>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: <span class="badge">${mapStatusLabel(r.defaultStatus)}</span></li>
        <li>${r.allowManualOverride ? 'Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ø­Ø§Ù„Ø©' : 'Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ'}</li>`;
    }

    function mapResultLabel(res){
      return res === 'matched' ? 'Ù…Ø·Ø§Ø¨Ù‚' : res === 'mismatch' ? 'ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
    }
    function mapStatusLabel(st){
      return st === 'matched' ? 'Ù…Ø¤ÙƒØ¯/Ù…Ø·Ø§Ø¨Ù‚' : st === 'mismatch' ? 'Ù…Ø¹ØªØ±Ø¶/ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
    }

    /* ============================================================
       Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Logic)
    ============================================================ */
    function computeMatchForParty(p){
      const r = state.rules;
      const items = openItems[p.id] || [];
      const unappliedSum = items.reduce((s,it)=> s + (Number(it.unapplied)||0), 0);
      const balance = Number(p.balance)||0;
      const tolAbs = Number(r.tolAmount)||0;
      const tolPct = Number(r.tolPercent)||0;
      const tolFromPct = balance * (tolPct/100);
      const tol = Math.max(tolAbs, tolFromPct);

      // ØªØ¹Ø±ÙŠÙ ÙØ±Ù‚ Ù…Ø¨Ø³Ù‘Ø·: Ø¥Ø°Ø§ Ø§Ù„Ø±ØµÙŠØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡Ø§Ù…Ø´ => Ù…Ø·Ø§Ø¨Ù‚
      const diff = Math.abs(balance - 0); // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ø±ØµÙŠØ¯ Ø·Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§

      let result = 'pending';
      if (r.requireZeroUnapplied && unappliedSum !== 0) {
        result = 'mismatch';
      } else {
        result = (diff <= tol) ? 'matched' : 'mismatch';
      }

      // Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
      let status = state.rules.defaultStatus;
      if (result === 'matched') status = 'matched';
      if (result === 'mismatch') status = 'mismatch';

      // Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
      const note = (state.rules.noteTemplate||'')
        .replaceAll('{tolAmount}', tolAbs)
        .replaceAll('{tolPercent}', tolPct)
        .replaceAll('{diff}', diff.toFixed(2));

      return { result, status, note, diff, unappliedSum, tol };
    }

    function recalcAllMatches(){
      parties.forEach(p => {
        const calc = computeMatchForParty(p);
        state.partyStatus.set(p.id, calc);
      });
      renderTable();
      toast('ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙˆÙÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©', 'success');
      audit('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©');
    }

    /* ============================================================
       Render: Filters + Options
    ============================================================ */
    function initOptions() {
      // Branches
      const bsel = $('#branchSelect');
      bsel.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      // Currencies
      const csel = $('#currencySelect');
      const distinct = [...new Set(currencies.map(c=>c.code))];
      csel.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + distinct.map(c=>`<option value="${c}">${c}</option>`).join('');

      // Restore saved
      $('#fromDate').value = state.filters.fromDate || '';
      $('#toDate').value = state.filters.toDate || '';
      $$('input[name="ptype"]').forEach(r=> r.checked = (r.value === state.filters.ptype));
      bsel.value = state.filters.branch;
      csel.value = state.filters.currency;
      $('#minBalance').value = state.filters.minBalance;
      $('#confirmType').value = state.filters.confirmType;
      $('#includeUnapplied').checked = state.filters.includeUnapplied;
      $('#q').value = state.filters.q;
      $('#sortBy').value = state.filters.sortBy;

      // Template modal restore
      $('#tplPositive').value = state.template.positive;
      $('#tplNegative').value = state.template.negative;
      $('#showOrg').checked = state.template.showOrg;
      $('#showReply').checked = state.template.showReply;
      $('#showMoves').checked = state.template.showMoves;
      $('#showQR').checked = state.template.showQR;

      // Rules restore
      $('#tolAmount').value = state.rules.tolAmount;
      $('#tolPercent').value = state.rules.tolPercent;
      $('#requireZeroUnapplied').checked = state.rules.requireZeroUnapplied;
      $('#autoDisputeNegative').checked = state.rules.autoDisputeNegative;
      $('#defaultStatus').value = state.rules.defaultStatus;
      $('#allowManualOverride').checked = state.rules.allowManualOverride;
      $('#noteTemplate').value = state.rules.noteTemplate;

      summarizeRules();
    }

    /* ============================================================
       Filter + Sort + Search
    ============================================================ */
    function applyFilters() {
      state.filters.fromDate = $('#fromDate').value;
      state.filters.toDate = $('#toDate').value;
      state.filters.ptype = $('input[name="ptype"]:checked').value;
      state.filters.branch = $('#branchSelect').value;
      state.filters.currency = $('#currencySelect').value;
      state.filters.minBalance = Number($('#minBalance').value || 0);
      state.filters.confirmType = $('#confirmType').value;
      state.filters.includeUnapplied = $('#includeUnapplied').checked;
      state.filters.q = $('#q').value.trim();
      state.filters.sortBy = $('#sortBy').value;
      saveAll();
      renderTable();
    }

    function filteredParties() {
      let rows = parties.slice();
      const f = state.filters;

      if (f.ptype !== 'all') rows = rows.filter(p => p.type === f.ptype);
      if (f.branch !== 'all') rows = rows.filter(p => p.branch === f.branch);
      if (f.currency !== 'all') rows = rows.filter(p => p.currency === f.currency);
      if (f.minBalance > 0) rows = rows.filter(p => (p.balance || 0) >= f.minBalance);
      if (f.q) {
        const q = f.q.toLowerCase();
        rows = rows.filter(p => p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q));
      }

      switch (f.sortBy) {
        case 'name': rows.sort((a,b)=> a.name.localeCompare(b.name, 'ar')); break;
        case 'code': rows.sort((a,b)=> a.code.localeCompare(b.code, 'en')); break;
        case 'balance': rows.sort((a,b)=> (b.balance||0) - (a.balance||0)); break;
      }
      return rows;
    }

    function renderTable() {
      const rows = filteredParties();
      const tb = $('#tbody'); tb.innerHTML = '';
      $('#emptyState').hidden = rows.length !== 0;
      const fmtBranch = id => (branches.find(b=>b.id===id)?.name || id);

      rows.forEach(p => {
        // Ø§Ø­Ø³Ø¨/Ø§Ù‚ØªØ±Ø­ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (!state.partyStatus.has(p.id)) {
          state.partyStatus.set(p.id, computeMatchForParty(p));
        }
        const st = state.partyStatus.get(p.id);

        const tr = document.createElement('tr');
        tr.className = 'selectable';
        tr.dataset.id = String(p.id);
        if (state.selected.has(p.id)) tr.classList.add('selected');
        tr.innerHTML = `
          <td><input type="checkbox" aria-label="ØªØ­Ø¯ÙŠØ¯" data-check data-id="${p.id}" ${state.selected.has(p.id)?'checked':''}></td>
          <td>${p.name}</td>
          <td>${p.code}</td>
          <td>${fmtBranch(p.branch)}</td>
          <td>${p.currency}</td>
          <td>${formatCurrency(p.balance, p.currency)}</td>
          <td>${p.aging}</td>
          <td>${renderMatchCell(st)}</td>
          <td>${renderLetterStatus(p)}</td>
          <td><button class="btn" data-details="${p.id}" title="ØªÙØ§ØµÙŠÙ„">â¤µï¸</button></td>
        `;
        tb.appendChild(tr);

        const dtr = document.createElement('tr');
        dtr.className = 'details';
        dtr.id = `details-${p.id}`;
        dtr.innerHTML = `<td colspan="10">${renderDetails(p, st)}</td>`;
        tb.appendChild(dtr);
      });

      $('#genTime').textContent = 'ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯: ' + new Date().toLocaleString('ar-SA');
    }

    function renderMatchCell(st){
      const cls = st.result === 'matched' ? 'status-matched' : st.result === 'mismatch' ? 'status-mismatch' : 'status-review';
      return `<span class="status-pill ${cls}">${mapResultLabel(st.result)}</span><br/><small class="subtle">ÙØ±Ù‚: ${st.diff?.toFixed(2)||'â€”'} | ØºÙŠØ± Ù…Ø·Ø¨Ù‚: ${st.unappliedSum||0}</small>`;
    }

    function renderLetterStatus(p) {
      const last = p.lastLetter;
      if (!last) return `<span class="status-pill status-pending">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>`;
      const map = { 'Ø£ÙØ±Ø³Ù„':'status-sent', 'Ù…Ø¹Ù„Ù‘Ù‚':'status-pending', 'Ù…Ø¹ØªØ±Ø¶':'status-rejected', 'Ù…Ø¤ÙƒØ¯':'status-confirmed' };
      const cls = map[last.status] || 'status-pending';
      return `<span class="status-pill ${cls}">${last.status}</span>`;
    }

    function renderDetails(p, st) {
      const items = openItems[p.id] || [];
      const itemsHtml = items.length
        ? `<table style="width:100%; border-collapse: collapse" aria-label="ÙÙˆØ§ØªÙŠØ± Ù…ÙØªÙˆØ­Ø©"><thead><tr>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ù…Ø³ØªØ­Ù‚</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">ØºÙŠØ± Ù…Ø·Ø¨Ù‚</th>
          </tr></thead><tbody>
          ${items.map(it=>`<tr>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.doc}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.date}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.due}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${formatCurrency(it.amount, parties.find(x=>x.id===p.id)?.currency)}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${formatCurrency(it.unapplied, parties.find(x=>x.id===p.id)?.currency)}</td>
          </tr>`).join('')}
          </tbody></table>`
        : `<div style="color:var(--ink-2)">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±/Ø­Ø±ÙƒØ§Øª Ù…ÙØªÙˆØ­Ø©.</div>`;

      const lastHtml = p.lastLetter
        ? `<ul style="margin:6px 0 0 0; padding-inline-start: 18px;">
            <li>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${p.lastLetter.date}</li>
            <li>Ø§Ù„Ù†ÙˆØ¹: ${p.lastLetter.type === 'negative' ? 'Ø³Ù„Ø¨ÙŠ' : 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ'}</li>
            <li>Ø§Ù„Ø­Ø§Ù„Ø©: ${p.lastLetter.status}</li>
            <li><a href="#" onclick="event.preventDefault()">Ø±Ø§Ø¨Ø· PDF (ÙˆÙ‡Ù…ÙŠ)</a></li>
          </ul>`
        : `<div style="color:var(--ink-2)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚.</div>`;

      const note = (state.partyStatus.get(p.id)?.note)||'';

      // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶
      const controlHtml = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px">
          <label>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:
            <select data-result-for="${p.id}" class="select" ${state.rules.allowManualOverride?'' : 'disabled'}>
              <option value="matched" ${st.result==='matched'?'selected':''}>Ù…Ø·Ø§Ø¨Ù‚</option>
              <option value="mismatch" ${st.result==='mismatch'?'selected':''}>ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚</option>
              <option value="pending" ${st.result==='pending'?'selected':''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            </select>
          </label>
          <label>Ø§Ù„Ø­Ø§Ù„Ø©:
            <select data-status-for="${p.id}" class="select" ${state.rules.allowManualOverride?'' : 'disabled'}>
              <option value="matched" ${st.status==='matched'?'selected':''}>Ù…Ø¤ÙƒØ¯/Ù…Ø·Ø§Ø¨Ù‚</option>
              <option value="mismatch" ${st.status==='mismatch'?'selected':''}>Ù…Ø¹ØªØ±Ø¶</option>
              <option value="pending" ${st.status==='pending'?'selected':''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
            </select>
          </label>
          <button class="btn" data-apply-status="${p.id}">Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©</button>
        </div>
        <div class="field" style="margin-top:6px">
          <label for="note-${p.id}">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</label>
          <textarea id="note-${p.id}" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø®Ù„Ø§ØµØ© Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©/Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù">${note}</textarea>
        </div>`;

      return `
        <div style="display:grid; grid-template-columns: 1.1fr .9fr; gap: 12px;">
          <div>
            <strong>Ø¢Ø®Ø± ÙÙˆØ§ØªÙŠØ±/Ø­Ø±ÙƒØ§Øª Ù…ÙØªÙˆØ­Ø©</strong>
            ${itemsHtml}
          </div>
          <div>
            <strong>Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</strong>
            <div style="margin-top:4px">${controlHtml}</div>
            <div style="margin-top:10px"><strong>Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</strong>${lastHtml}</div>
          </div>
        </div>
      `;
    }

    /* ============================================================
       Selection + Actions
    ============================================================ */
    function toggleRowSelection(id, checked) {
      if (checked) state.selected.add(id); else state.selected.delete(id);
      saveAll();
      const row = $$(`tbody tr.selectable`).find(r => Number(r.dataset.id) === id);
      if (row) row.classList.toggle('selected', checked);
    }

    function selectAllToggle(checked) {
      const ids = filteredParties().map(p=>p.id);
      ids.forEach(id => state.selected.add(id));
      if (!checked) ids.forEach(id => state.selected.delete(id));
      renderTable();
      $('#selectAll').checked = checked;
    }

    /* ============================================================
       Letter Templating
    ============================================================ */
    function renderTemplate(txt, p){
      const today = new Date().toLocaleDateString('ar-SA');
      return txt
        .replaceAll('{party}', p.name)
        .replaceAll('{code}', p.code)
        .replaceAll('{branch}', branches.find(b=>b.id===p.branch)?.name || p.branch)
        .replaceAll('{currency}', p.currency)
        .replaceAll('{balance}', formatCurrency(p.balance, p.currency))
        .replaceAll('{today}', today);
    }

    function buildLetterHTML(p) {
      const t = state.template;
      const orgBlock = t.showOrg ? `
        <div>
          <div style="font-weight:700">Smart Life ERP</div>
          <div>Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ: 123456789</div>
          <div>Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ: 310123456789003</div>
          <div>Ø§Ù„Ø±ÙŠØ§Ø¶ â€” Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
        </div>` : '';

      const baseTxt = (state.filters.confirmType==='negative')? t.negative : t.positive;
      const txt = renderTemplate(baseTxt, p);

      const moves = (openItems[p.id]||[]);
      const movesHtml = state.template.showMoves && moves.length ? `
        <div style="margin-top:10px">
          <strong>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø©:</strong>
          <table style="width:100%; border-collapse: collapse; margin-top:6px">
            <thead>
              <tr>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ù…Ø³ØªØ­Ù‚</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">ØºÙŠØ± Ù…Ø·Ø¨Ù‚</th>
              </tr>
            </thead>
            <tbody>
              ${moves.map(m=>`<tr>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.doc}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.date}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.due}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${formatCurrency(m.amount, p.currency)}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${formatCurrency(m.unapplied, p.currency)}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>` : '';

      const reply = state.template.showReply ? `
        <div class="reply-slip">
          <strong>Ù‚ØµØ§ØµØ© Ø§Ù„Ø±Ø¯</strong>
          <div class="info-grid">
            <div>Ø§Ù„Ø·Ø±Ù: ${p.name} (${p.code})</div>
            <div>Ø§Ù„ÙØ±Ø¹: ${branches.find(b=>b.id===p.branch)?.name}</div>
            <div>Ø§Ù„Ø¹Ù…Ù„Ø©: ${p.currency}</div>
            <div>Ø§Ù„Ø±ØµÙŠØ¯: ${formatCurrency(p.balance, p.currency)}</div>
          </div>
          <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items:center;">
            <div>
              <div>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹: __________________</div>
              <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ø®ØªÙ…: ______________</div>
              <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ____ / ____ / ______</div>
            </div>
            ${state.template.showQR ? `<div class="qr" title="QR" aria-label="QR"></div>` : ''}
          </div>
        </div>` : '';

      return `
        <article class="letter" data-party-id="${p.id}">
          <header>
            <div class="brand"><div class="logo" aria-hidden="true">SL</div><h3>Ø®Ø·Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯</h3></div>
            ${orgBlock}
          </header>
          <div class="info-grid">
            <div>Ø§Ù„Ø·Ø±Ù: <strong>${p.name}</strong> (${p.code})</div>
            <div>Ø§Ù„Ù†ÙˆØ¹: ${p.type === 'customer' ? 'Ø¹Ù…ÙŠÙ„' : 'Ù…ÙˆØ±Ø¯'}</div>
            <div>Ø§Ù„ÙØ±Ø¹: ${branches.find(b=>b.id===p.branch)?.name}</div>
            <div>Ø§Ù„Ø¹Ù…Ù„Ø©: ${p.currency}</div>
            <div>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${formatCurrency(p.balance, p.currency)}</div>
            <div>Ø¹Ù…Ø± Ø§Ù„Ø¯ÙŠÙ†: ${p.aging}</div>
          </div>
          <p style="margin-top:8px">${txt}</p>
          <p style="color:#475569; font-size: 14px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· (ÙˆÙ‡Ù…ÙŠ): <a href="#">https://confirm.example/${p.id}</a></p>
          ${movesHtml}
          ${reply}
        </article>
      `;
    }

    /* ============================================================
       Actions: Generate / Preview / Email / ZIP / PDF merged
    ============================================================ */
    function requireSelection() {
      if (state.selected.size === 0) { toast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warn'); return false; }
      return true;
    }

    async function generateLetters() {
      if (!requireSelection()) return;
      setBusy(true);
      await new Promise(r=>setTimeout(r, 300)); // fake small delay
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const html = buildLetterHTML(p);
        state.generatedMap.set(id, html);
      }
      setBusy(false);
      toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'success');
      audit('ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø§Ø¨Ø§Øª', `Ø¹Ø¯Ø¯: ${state.selected.size}`);

      // Ø§ÙØªØ­ Ø£ÙˆÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø©
      const first = state.selected.values().next().value;
      if (first) showPreview(first);
    }

    function showPreview(id) {
      const html = state.generatedMap.get(id);
      if (!html) { toast('Ù„ÙŠØ³ Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø§ÙŠÙ†Ø© â€” Ù‚Ù… Ø¨Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø£ÙˆÙ„Ù‹Ø§', 'warn'); return; }
      $('#previewArea').innerHTML = html;
      $('#previewModal').showModal();
    }

    function downloadAsHTMLBlob(filename, html) {
      const blob = new Blob([`<!doctype html><html lang=\"ar\" dir=\"rtl\"><meta charset=\"utf-8\"><title>${filename}</title><body>${html}</body></html>`], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename + '.html';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function downloadZIP() {
      if (!requireSelection()) return;
      if (state.generatedMap.size === 0) { toast('Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ù‹Ø§', 'warn'); return; }
      let count = 0;
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const html = state.generatedMap.get(id);
        if (html) { downloadAsHTMLBlob(`${p.code}-${p.name}-letter`, html); count++; }
      }
      toast(`ØªÙ… ØªØ¬Ù‡ÙŠØ² ${count} Ù…Ù„ÙÙ‹Ø§ Ù„Ù„ØªÙ†Ø²ÙŠÙ„ (HTML)`, 'success');
      audit('ØªÙ†Ø²ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯', `Ø¹Ø¯Ø¯: ${count}`);
    }

    async function sendEmailFake() {
      if (!requireSelection()) return;
      setBusy(true);
      await new Promise(r=>setTimeout(r, 800)); // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ£Ø®ÙŠØ±
      setBusy(false);
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const kind = (state.filters.confirmType==='negative')? 'negative' : 'positive';
        const status = kind==='negative' && state.rules.autoDisputeNegative ? 'Ù…Ø¹ØªØ±Ø¶' : 'Ø£ÙØ±Ø³Ù„';
        p.lastLetter = { date: new Date().toISOString().slice(0,10), type: kind, status };
      }
      renderTable();
      toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù…Ø­Ø§ÙƒØ§Ø©)', 'success');
      audit('Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯', `Ø¹Ø¯Ø¯: ${state.selected.size}`);
    }

    function mergedPDFPreview() {
      if (!requireSelection()) return;
      if (state.generatedMap.size === 0) { toast('Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ù‹Ø§', 'warn'); return; }
      const wrap = $('#printContainer');
      wrap.innerHTML = '';
      for (const id of state.selected) {
        const html = state.generatedMap.get(id);
        if (html) {
          const div = document.createElement('div');
          div.innerHTML = html;
          wrap.appendChild(div.firstElementChild); // article.letter
        }
      }
      wrap.hidden = false;
      toast('Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© â€” Ø³ÙŠÙÙØµÙ„ ÙƒÙ„ Ø®Ø·Ø§Ø¨ ÙÙŠ ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø©', 'success');
      setTimeout(()=>window.print(), 50);
      audit('Ù…Ø¹Ø§ÙŠÙ†Ø© PDF Ù…Ø¯Ù…Ø¬ (Ø·Ø¨Ø§Ø¹Ø© HTML)', `Ø¹Ø¯Ø¯: ${state.selected.size}`);
    }

    /* ============================================================
       Events Wiring
    ============================================================ */
    function wireEvents() {
      $('#applyFilters').addEventListener('click', applyFilters);
      $('#resetFilters').addEventListener('click', () => {
        Object.assign(state.filters, { fromDate:'', toDate:'', ptype:'all', branch:'all', currency:'all', minBalance:0, confirmType:'positive', includeUnapplied:false, q:'', sortBy:'name' });
        saveAll(); initOptions(); renderTable();
      });

      $('#q').addEventListener('input', () => { state.filters.q = $('#q').value; renderTable(); });
      $('#sortBy').addEventListener('change', () => { state.filters.sortBy = $('#sortBy').value; saveAll(); renderTable(); });
      $('#selectAll').addEventListener('change', e => selectAllToggle(e.target.checked));

      $('#tbody').addEventListener('change', e => {
        if (e.target.matches('[data-check]')) {
          const id = Number(e.target.dataset.id);
          toggleRowSelection(id, e.target.checked);
        }
      });

      $('#tbody').addEventListener('click', e => {
        const btn = e.target.closest('[data-details]');
        if (btn) {
          const id = btn.getAttribute('data-details');
          const row = document.getElementById('details-' + id);
          row.classList.toggle('open');
        }

        // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
        const applyBtn = e.target.closest('[data-apply-status]');
        if (applyBtn) {
          const id = Number(applyBtn.getAttribute('data-apply-status'));
          const resSel = document.querySelector(`[data-result-for="${id}"]`);
          const stSel = document.querySelector(`[data-status-for="${id}"]`);
          const note = document.getElementById(`note-${id}`)?.value || '';
          const prev = state.partyStatus.get(id) || {};
          state.partyStatus.set(id, { ...prev, result: resSel.value, status: stSel.value, note });
          renderTable();
          toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'success');
          audit('ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø·Ø±Ù', `ID: ${id}`);
        }
      });

      $('#btnGenerate').addEventListener('click', generateLetters);
      $('#btnEmail').addEventListener('click', sendEmailFake);
      $('#btnZip').addEventListener('click', downloadZIP);
      $('#btnPDF').addEventListener('click', mergedPDFPreview);
      $('#btnCalc').addEventListener('click', recalcAllMatches);

      // Preview modal actions
      $('#printLetter').addEventListener('click', () => window.print());
      $('#downloadLetter').addEventListener('click', () => {
        const article = $('#previewArea .letter');
        if (!article) return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†Ø´Ø·Ø©', 'warn');
        const id = Number(article.getAttribute('data-party-id'));
        const p = parties.find(x=>x.id===id);
        downloadAsHTMLBlob(`${p.code}-${p.name}-letter`, article.outerHTML);
      });

      // open/close modals
      $('#openTemplateBtn').addEventListener('click', () => $('#templateModal').showModal());
      $('#openRulesBtn').addEventListener('click', () => $('#rulesModal').showModal());
      $$('dialog [data-close]').forEach(b => b.addEventListener('click', e => e.target.closest('dialog').close()));

      // save template
      $('#saveTemplate').addEventListener('click', () => {
        state.template.positive = $('#tplPositive').value.trim() || state.template.positive;
        state.template.negative = $('#tplNegative').value.trim() || state.template.negative;
        state.template.showOrg = $('#showOrg').checked;
        state.template.showReply = $('#showReply').checked;
        state.template.showMoves = $('#showMoves').checked;
        state.template.showQR = $('#showQR').checked;
        saveAll();
        toast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨', 'success');
        audit('Ø­ÙØ¸ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨');
      });
      $('#resetTemplate').addEventListener('click', () => {
        state.template = {
          positive: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ø³Ø¬Ù„Ø§ØªÙ†Ø§. Ø§Ù„Ø·Ø±Ù: {party} ({code}) â€” Ø§Ù„ÙØ±Ø¹: {branch} â€” Ø§Ù„Ø±ØµÙŠØ¯: {balance}. Ù†Ø±Ø¬Ùˆ ØªØ£ÙƒÙŠØ¯ÙƒÙ… Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ {today}.',
          negative: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨ÙˆØ¬ÙˆØ¯ Ø§Ø®ØªÙ„Ø§Ù ÙÙŠ Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ Ù„Ù„Ø·Ø±Ù: {party} ({code}). Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø± Ù„Ø¯ÙŠÙ†Ø§: {balance}. Ù†Ø£Ù…Ù„ Ø§Ù„ØªØ²ÙˆÙŠØ¯ Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡ {today}.',
          showOrg: true, showReply: true, showMoves: true, showQR: false
        };
        initOptions(); saveAll();
        toast('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', 'success');
        audit('Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
      });

      // save rules
      $('#saveRules').addEventListener('click', () => {
        state.rules.tolAmount = Number($('#tolAmount').value||0);
        state.rules.tolPercent = Number($('#tolPercent').value||0);
        state.rules.requireZeroUnapplied = $('#requireZeroUnapplied').checked;
        state.rules.autoDisputeNegative = $('#autoDisputeNegative').checked;
        state.rules.defaultStatus = $('#defaultStatus').value;
        state.rules.allowManualOverride = $('#allowManualOverride').checked;
        state.rules.noteTemplate = $('#noteTemplate').value.trim() || state.rules.noteTemplate;
        saveAll(); summarizeRules();
        toast('ØªÙ… Ø­ÙØ¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©', 'success');
        audit('Ø­ÙØ¸ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©');
      });

      // theme toggle
      $('#toggleTheme').addEventListener('click', (e) => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        e.currentTarget.setAttribute('aria-pressed', String(!isDark));
      });

      // row click selects checkbox (keyboard friendly)
      $('#tbody').addEventListener('click', e => {
        const tr = e.target.closest('tr.selectable');
        if (tr && !e.target.closest('input,button,a,select,textarea')) {
          const id = Number(tr.dataset.id);
          const cb = tr.querySelector('[data-check]');
          cb.checked = !cb.checked; cb.dispatchEvent(new Event('change', {bubbles:true}));
        }
      });

      // keyboard navigation hint: focus first input
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); $('#q').focus(); }
      });
    }

    /* ============================================================
       Init
    ============================================================ */
    function init() {
      loadAll();
      initOptions();
      recalcAllMatches(); // ÙŠØ­Ø³Ø¨ ÙˆÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      wireEvents();
      audit('Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµÙØ­Ø©');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
