<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø®Ø·Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ â€” ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©</title>
  <meta name="description" content="ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯ (Ø¹Ù…ÙŠÙ„/Ù…ÙˆØ±Ø¯) â€” ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© HTML/CSS/JS ÙÙ‚Ø·" />
  <style>
    /* ==========================
       Reset & Base
    ========================== */
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --primary: #1877F2; /* Ø£Ø²Ø±Ù‚ ÙˆØ§Ø¶Ø­ Ù…Ø«Ù„ ÙÙŠØ³Ø¨ÙˆÙƒ/ØªÙˆÙŠØªØ± Ù‚Ø¯ÙŠÙ… */
      --primary-600: #145fcc;
      --bg: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --ink-2: #334155; /* slate-700 */
      --muted: #f1f5f9; /* slate-100 */
      --border: #e2e8f0; /* slate-200 */
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --focus: #60a5fa;
    }
    [data-theme="dark"] {
      --bg: #0b1220;
      --ink: #e5e7eb;
      --ink-2: #cbd5e1;
      --muted: #0f172a;
      --border: #1f2937;
    }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--ink); font: 400 15px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", "Tahoma", sans-serif; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    button, input, select, label { font: inherit; }
    .container { max-width: 1280px; margin-inline: auto; padding: 0 16px; }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }

    /* ==========================
       Header
    ========================== */
    header.site-header { position: sticky; top: 0; z-index: 50; background: var(--bg); border-bottom: 1px solid var(--border); }
    .header-inner { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 10px 0; }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo { inline-size: 36px; block-size: 36px; border-radius: 8px; background: var(--primary); display:grid; place-items:center; color:#fff; font-weight:700; }
    nav ul { margin: 0; padding: 0; list-style: none; display: flex; gap: 12px; }
    nav a { display: inline-flex; align-items: center; padding: 8px 10px; border-radius: 8px; }
    nav a:is(:hover, :focus-visible) { background: var(--muted); outline: none; }

    /* ==========================
       Layout
    ========================== */
    main { display: grid; grid-template-columns: 320px 1fr; gap: 16px; padding: 16px 0 0; }
    @media (max-width: 960px) { main { grid-template-columns: 1fr; } }

    aside.filters { position: relative; background: var(--bg); border: 1px solid var(--border); border-radius: 14px; padding: 14px; }
    .filters h2 { margin: 0 0 10px; font-size: 16px; }
    .field { display: grid; gap: 6px; margin: 10px 0; }
    .row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

    .btn { appearance: none; border: 1px solid var(--border); background: #fff; color: var(--ink); padding: 8px 12px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; }
    .btn.ghost { background: transparent; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:is(:focus-visible) { outline: 2px solid var(--focus); outline-offset: 2px; }

    section.results { position: relative; background: var(--bg); border: 1px solid var(--border); border-radius: 14px; padding: 0; overflow: hidden; }

    .toolbar { display:flex; gap:8px; align-items:center; padding: 12px; border-bottom: 1px solid var(--border); background: linear-gradient(0deg, var(--bg), #fff); position: sticky; top: 56px; z-index: 5; }
    .toolbar .grow { flex: 1; }
    .input { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: #fff; padding: 8px 10px; border-radius: 10px; }
    .input input { border: 0; outline: none; background: transparent; min-inline-size: 140px; }
    .select { border: 1px solid var(--border); background:#fff; padding: 8px 10px; border-radius: 10px; }
    .checkbox { display:inline-flex; gap:8px; align-items:center; }

    /* Table */
    .table-wrap { overflow:auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th { position: sticky; top: calc(56px + 48px); background: var(--muted); z-index: 4; text-align: start; font-weight: 600; padding: 10px; border-bottom: 1px solid var(--border); }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tbody tr.selectable:hover { background: #f8fafc; }
    tbody tr.selected { background: #eef6ff; outline: 2px solid #dbeafe; }

    .status-pill { display:inline-flex; align-items:center; gap:6px; padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid var(--border); }
    .status-sent { background:#ecfdf5; border-color:#bbf7d0; }
    .status-pending { background:#fff7ed; border-color:#fed7aa; }
    .status-rejected { background:#fef2f2; border-color:#fecaca; }
    .status-confirmed { background:#eff6ff; border-color:#bfdbfe; }

    .details { grid-column: 1 / -1; background: #fcfdff; border-inline-start: 4px solid var(--primary); display: none; }
    .details.open { display: table-row; animation: fade .2s ease-in; }
    @keyframes fade { from { opacity: 0 } to { opacity: 1 } }

    .empty { padding: 32px; text-align: center; color: var(--ink-2); }

    /* Footer */
    footer { margin: 16px 0 24px; color: var(--ink-2); font-size: 13px; display:flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; }

    /* ==========================
       Modals & Overlays
    ========================== */
    dialog.modal { border: 0; border-radius: 16px; padding: 0; width: min(100% - 24px, 960px); }
    .modal header { padding: 12px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content: space-between; }
    .modal .content { padding: 16px; max-block-size: 70vh; overflow: auto; background: var(--bg); }
    .modal footer { padding: 12px 16px; border-top: 1px solid var(--border); display:flex; gap: 8px; justify-content: end; }
    dialog::backdrop { background: rgba(0,0,0,.35); }

    .template-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Toasts */
    .toasts { position: fixed; inset-inline-start: 16px; inset-block-end: 16px; display: grid; gap: 10px; z-index: 100; }
    .toast { background: #fff; color: var(--ink); border: 1px solid var(--border); border-inline-start: 4px solid var(--primary); padding: 10px 12px; border-radius: 12px; display:flex; align-items: start; gap: 10px; min-width: 260px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .toast.success { border-inline-start-color: var(--success); }
    .toast.warn { border-inline-start-color: var(--warn); }
    .toast.danger { border-inline-start-color: var(--danger); }
    .toast button { margin-inline-start: auto; }

    /* Spinner */
    .spinner { position: fixed; inset: 0; display: none; place-items: center; background: rgba(255,255,255,.6); z-index: 90; }
    .spinner .ring { inline-size: 56px; block-size: 56px; border: 6px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(-360deg); } }

    /* ==========================
       Print Styles (letters only)
    ========================== */
    @media print {
      body { background: #fff; }
      header.site-header, aside.filters, .toolbar, .table-wrap, footer, .toasts, .spinner { display: none !important; }
      .print-letters { display: block !important; }
      .letter { page-break-after: always; break-after: page; }
      .letter:last-child { page-break-after: auto; break-after: auto; }
    }

    /* Letter (Preview HTML) */
    .letter { color: #111827; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .letter header { display:flex; align-items:center; justify-content: space-between; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 12px; }
    .letter .brand { gap: 10px; }
    .letter h3 { margin: 0; font-size: 18px; }
    .info-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 14px; font-size: 14px; margin: 10px 0 6px; }
    .reply-slip { margin-top: 12px; border-top: 2px dashed #cbd5e1; padding-top: 10px; }
    .qr { inline-size: 72px; block-size: 72px; background: repeating-linear-gradient(45deg, #000 0 4px, #fff 4px 8px); border-radius: 6px; }

  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="brand" aria-label="Ø§Ù„Ù…Ø¤Ø³Ø³Ø©">
        <div class="logo" aria-hidden="true">SL</div>
        <div>
          <div style="font-weight:700">Smart Life â€” Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</div>
          <div style="font-size:12px;color:var(--ink-2)">Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯</div>
        </div>
      </div>
      <nav aria-label="Ø±ÙˆØ§Ø¨Ø· Ø±Ø¦ÙŠØ³ÙŠØ©">
        <ul>
          <li><a href="#" aria-current="page">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
          <li><a href="#">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
          <li><a href="#" id="openTemplateBtn" title="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a></li>
          <li><button class="btn ghost" id="toggleTheme" aria-pressed="false" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†">ğŸŒ™</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <main id="main" role="main">
      <!-- Sidebar / Filters -->
      <aside class="filters" aria-label="ÙÙ„Ø§ØªØ± ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
        <h2>Ø§Ù„ÙÙ„Ø§ØªØ±</h2>
        <div class="field row" aria-label="Ø§Ù„ÙØªØ±Ø©">
          <div class="field">
            <label for="fromDate">Ù…Ù†</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="field">
            <label for="toDate">Ø¥Ù„Ù‰</label>
            <input id="toDate" type="date" />
          </div>
        </div>

        <div class="field" role="group" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø·Ø±Ù">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ø±Ù</label>
          <div class="row">
            <label class="checkbox"><input type="radio" name="ptype" value="all" checked /> Ø§Ù„ÙƒÙ„</label>
            <label class="checkbox"><input type="radio" name="ptype" value="customer" /> Ø¹Ù…ÙŠÙ„</label>
            <label class="checkbox"><input type="radio" name="ptype" value="vendor" /> Ù…ÙˆØ±Ø¯</label>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="branchSelect">Ø§Ù„ÙØ±Ø¹</label>
            <select id="branchSelect" class="select"></select>
          </div>
          <div class="field">
            <label for="currencySelect">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
            <select id="currencySelect" class="select"></select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="minBalance">Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø±ØµÙŠØ¯</label>
            <input id="minBalance" type="number" inputmode="decimal" placeholder="0" />
          </div>
          <div class="field">
            <label for="confirmType">Ù†ÙˆØ¹ Ø§Ù„ØªØ£ÙƒÙŠØ¯</label>
            <select id="confirmType" class="select">
              <option value="any">Ø£ÙŠÙ‘Ù‹Ø§ ÙƒØ§Ù†</option>
              <option value="positive">Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</option>
              <option value="negative">Ø³Ù„Ø¨ÙŠ</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label class="checkbox"><input id="includeUnapplied" type="checkbox" /> ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø­Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ø¨Ù‘Ù‚Ø©</label>
        </div>

        <div class="actions">
          <button class="btn primary" id="applyFilters">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          <button class="btn" id="resetFilters">ØªØµÙÙŠØ±</button>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)"/>
        <div class="field">
          <label>Ø­ÙØ¸ Ø§Ù„ÙÙ„Ø§ØªØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</label>
          <label class="checkbox"><input id="autoSave" type="checkbox" checked /> ØªÙØ¹ÙŠÙ„</label>
        </div>
      </aside>

      <!-- Results / Grid -->
      <section class="results" aria-live="polite" aria-busy="false">
        <div class="toolbar" role="region" aria-label="Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª">
          <div class="input grow" aria-label="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹">
            ğŸ”
            <input id="q" type="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„Ø·Ø±Ù" />
          </div>
          <select id="sortBy" class="select" aria-label="ÙØ±Ø² Ø­Ø³Ø¨">
            <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
            <option value="code">Ø§Ù„ÙƒÙˆØ¯</option>
            <option value="balance">Ø§Ù„Ø±ØµÙŠØ¯</option>
          </select>
          <label class="checkbox" title="ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"><input id="selectAll" type="checkbox" /> ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
          <button class="btn" id="btnGenerate">ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø§Ø¨Ø§Øª</button>
          <button class="btn" id="btnEmail">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</button>
          <button class="btn" id="btnZip">ØªÙ†Ø²ÙŠÙ„ ZIP</button>
          <button class="btn" id="btnPDF">PDF Ù…Ø¯Ù…Ø¬</button>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table aria-describedby="tableCaption">
            <caption id="tableCaption" class="visually-hidden">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø·Ø±Ø§Ù</caption>
            <thead>
              <tr>
                <th style="width:36px"></th>
                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø±Ù</th>
                <th>Ø§Ù„ÙƒÙˆØ¯</th>
                <th>Ø§Ù„ÙØ±Ø¹</th>
                <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                <th>Ø¹Ù…Ø± Ø§Ù„Ø¯ÙŠÙ†</th>
                <th>Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø®Ø·Ø§Ø¨</th>
                <th style="width:48px">ØªÙØ§ØµÙŠÙ„</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="emptyState" class="empty" hidden>Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© â€” Ø¹Ø¯Ù‘Ù„ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø§Ù„Ø¨Ø­Ø«.</div>
        </div>
      </section>
    </main>

    <footer>
      <div>Ù†Ø³Ø®Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: v1.0 â€” (ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø·)</div>
      <div id="genTime">ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯: â€”</div>
      <div><a href="#" target="_blank" rel="noopener">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></div>
    </footer>

    <!-- Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ÙŠ ÙˆÙ‡Ù…ÙŠ -->
    <section aria-label="Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª" style="border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:24px;">
      <h3 style="margin-top:0">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ÙŠ (ÙˆÙ‡Ù…ÙŠ)</h3>
      <ol id="auditLog" start="1" style="margin:0; padding-inline-start: 22px;"></ol>
      <p style="color:var(--ink-2); font-size:13px; margin-top:8px">* Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§: Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</p>
    </section>
  </div>

  <!-- Modals -->
  <dialog id="previewModal" class="modal" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨">
    <header>
      <strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨</strong>
      <button class="btn" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="content">
      <div id="previewArea"></div>
    </div>
    <footer>
      <button class="btn" id="printLetter">Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="downloadLetter">ØªÙ†Ø²ÙŠÙ„ PDF (HTML Blob)</button>
      <button class="btn primary" data-close>ØªÙ…</button>
    </footer>
  </dialog>

  <dialog id="templateModal" class="modal" aria-label="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨">
    <header>
      <strong>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨</strong>
      <button class="btn" data-close>Ø¥ØºÙ„Ø§Ù‚</button>
    </header>
    <div class="content">
      <div class="template-grid">
        <label class="field">
          <span>Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø¥ÙŠØ¬Ø§Ø¨ÙŠ)</span>
          <textarea id="tplPositive" rows="6" placeholder="Ù†Øµ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ"></textarea>
        </label>
        <label class="field">
          <span>Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø³Ù„Ø¨ÙŠ)</span>
          <textarea id="tplNegative" rows="6" placeholder="Ù†Øµ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ù„Ø¨ÙŠ"></textarea>
        </label>
        <div class="field">
          <label class="checkbox"><input id="showOrg" type="checkbox" checked /> Ø¥Ø¸Ù‡Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
          <label class="checkbox"><input id="showReply" type="checkbox" checked /> Ø¥Ø¸Ù‡Ø§Ø± Ù‚ØµØ§ØµØ© Ø§Ù„Ø±Ø¯</label>
          <label class="checkbox"><input id="showMoves" type="checkbox" checked /> Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª</label>
          <label class="checkbox"><input id="showQR" type="checkbox" /> Ø¥Ø¸Ù‡Ø§Ø± QR</label>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn" id="saveTemplate">Ø­ÙØ¸</button>
      <button class="btn" id="resetTemplate">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
      <button class="btn primary" data-close>ØªÙ…</button>
    </footer>
  </dialog>

  <!-- Overlays -->
  <div class="spinner" id="spinner" aria-live="polite" aria-busy="false"><div class="ring" role="status" aria-label="Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"></div></div>
  <div class="toasts" id="toasts" aria-live="polite"></div>

  <!-- Print container for merged PDF (HTML) -->
  <div id="printContainer" class="print-letters" hidden></div>

  <script>
    /* ============================================================
       Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Dummy Data)
    ============================================================ */
    const branches = [{id:"R", name:"Ø§Ù„Ø±ÙŠØ§Ø¶"},{id:"K", name:"Ø§Ù„Ø®Ø¨Ø±"}];
    const currencies = [{code:"SAR", name:"Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ"},{code:"USD", name:"Ø¯ÙˆÙ„Ø§Ø±"}];
    const parties = [
      {id:1, type:"customer", name:"Ù…Ø¤Ø³Ø³Ø© Ø¨Ù‡Ø§Ø¡ Ø¹Ø³ÙŠØ±", code:"C-001", branch:"R", currency:"SAR", balance: 18250.75, aging:"30-60", lastLetter:{date:"2025-03-01", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:2, type:"customer", name:"Ø´Ø±ÙƒØ© Ù†Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„", code:"C-002", branch:"K", currency:"SAR", balance: 0, aging:"0-30", lastLetter:null},
      {id:3, type:"vendor", name:"Ø£ØµØ§Ù„Ø© Ø§Ù„Ø¬Ù†ÙˆØ¨", code:"V-019", branch:"R", currency:"SAR", balance: 5400, aging:">90", lastLetter:{date:"2025-02-10", type:"negative", status:"Ù…Ø¹ØªØ±Ø¶"}},
      {id:4, type:"customer", name:"Ø´Ø±ÙƒØ© Ø±ÙˆÙ‘Ø§Ø¯ Ø§Ù„Ù†Ø¸Ù…", code:"C-014", branch:"K", currency:"SAR", balance: 1220.10, aging:"0-30", lastLetter:{date:"2025-01-15", type:"positive", status:"Ù…Ø¤ÙƒØ¯"}},
      {id:5, type:"vendor", name:"ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø³Ø­Ø§Ø¨", code:"V-022", branch:"R", currency:"USD", balance: 310.00, aging:"30-60", lastLetter:{date:"2025-02-21", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:6, type:"customer", name:"Ù…ØªØ§Ø¬Ø± Ø§Ù„ÙˆÙØ±Ø©", code:"C-099", branch:"R", currency:"SAR", balance: 9800.00, aging:"60-90", lastLetter:{date:"2025-04-01", type:"positive", status:"Ù…Ø¹Ù„Ù‘Ù‚"}},
      {id:7, type:"vendor", name:"Ø§Ù„Ø±ÙƒÙ† Ø§Ù„Ø­Ø¯ÙŠØ«", code:"V-120", branch:"K", currency:"SAR", balance: 50.75, aging:"0-30", lastLetter:null},
      {id:8, type:"customer", name:"Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…ÙŠØ±Ø©", code:"C-201", branch:"K", currency:"SAR", balance: 25000.00, aging:">90", lastLetter:{date:"2025-03-25", type:"negative", status:"Ù…Ø¹ØªØ±Ø¶"}},
      {id:9, type:"customer", name:"Ø¯ÙˆØ§Ø¡ Ø§Ù„Ø´ÙØ§Ø¡", code:"C-341", branch:"R", currency:"SAR", balance: 150.00, aging:"0-30", lastLetter:{date:"2024-12-29", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:10, type:"vendor", name:"Ù…Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø´Ù…Ø§Ù„", code:"V-211", branch:"K", currency:"USD", balance: 0, aging:"0-30", lastLetter:null},
      {id:11, type:"customer", name:"Ø³Ù†Ø§ Ø§Ù„Ù…Ø¬Ø±Ø©", code:"C-412", branch:"R", currency:"SAR", balance: 610.90, aging:"30-60", lastLetter:null},
      {id:12, type:"customer", name:"Ø§Ù„Ù…Ø§Ø³ Ø§Ù„Ø°Ù‡Ø¨ÙŠ", code:"C-555", branch:"K", currency:"SAR", balance: 120000.45, aging:">90", lastLetter:{date:"2025-05-11", type:"positive", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:13, type:"vendor", name:"Ø£Ø·ÙŠØ§Ø¨ Ø§Ù„Ù‚ØµÙŠÙ…", code:"V-310", branch:"R", currency:"SAR", balance: 70.00, aging:"0-30", lastLetter:{date:"2025-03-03", type:"negative", status:"Ø£ÙØ±Ø³Ù„"}},
      {id:14, type:"customer", name:"Ø³ÙÙŠØ± Ø§Ù„Ø¨Ù†Ø§Ø¡", code:"C-777", branch:"R", currency:"SAR", balance: 4321.00, aging:"60-90", lastLetter:{date:"2025-02-05", type:"positive", status:"Ù…Ø¹Ù„Ù‘Ù‚"}},
      {id:15, type:"vendor", name:"Ø£Ù†Ø¸Ù…Ø© Ø±Ø´ÙŠÙ‚Ø©", code:"V-404", branch:"K", currency:"SAR", balance: 889.90, aging:"30-60", lastLetter:null},
    ];

    const openItems = {
      1: [{doc:"INV-101", date:"2025-01-10", due:"2025-02-10", amount: 7250, unapplied: 0}],
      2: [{doc:"INV-220", date:"2025-03-05", due:"2025-04-05", amount: 4200, unapplied: 300}],
      3: [{doc:"BILL-778", date:"2024-12-20", due:"2025-01-20", amount: 5400, unapplied: 0}],
      4: [{doc:"INV-330", date:"2025-02-02", due:"2025-03-02", amount: 1220.1, unapplied: 0}],
      6: [{doc:"INV-991", date:"2025-04-10", due:"2025-05-10", amount: 9800, unapplied: 0}],
      8: [{doc:"INV-880", date:"2025-01-11", due:"2025-02-11", amount: 25000, unapplied: 0}],
      12:[{doc:"INV-1001", date:"2025-05-01", due:"2025-06-01", amount: 120000.45, unapplied: 0}],
      14:[{doc:"INV-712", date:"2025-01-22", due:"2025-02-22", amount: 4321, unapplied: 0}],
    };

    /* ============================================================
       Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ + LocalStorage
    ============================================================ */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const state = {
      filters: {
        fromDate: '', toDate: '',
        ptype: 'all', branch: 'all', currency: 'all',
        minBalance: 0, confirmType: 'any', includeUnapplied: false,
        q: '', sortBy: 'name'
      },
      template: {
        positive: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¯ÙŠÙ†Ø§ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ Ø£Ø¯Ù†Ø§Ù‡. Ù†Ø±Ø¬Ùˆ ØªØ£ÙƒÙŠØ¯ÙƒÙ… Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.' ,
        negative: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ ÙŠØ¸Ù‡Ø± Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ØŒ ÙˆÙ†Ø±Ø¬Ùˆ Ù…Ù†ÙƒÙ… Ø¥ÙØ§Ø¯ØªÙ†Ø§ Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø¤ÙŠØ¯Ø© Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù….' ,
        showOrg: true, showReply: true, showMoves: true, showQR: false
      },
      selected: new Set(),
      generatedMap: new Map(), // id -> HTML string
      user: { name: 'Ù…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ' }
    };

    const STORAGE_KEY = 'match_letters_state_v1';
    const saveAll = () => {
      if (!$('#autoSave').checked) return;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };
    const loadAll = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const obj = JSON.parse(raw);
        Object.assign(state.filters, obj.filters || {});
        Object.assign(state.template, obj.template || {});
      } catch {}
    };

    /* ============================================================
       UI Helpers
    ============================================================ */
    function toast(msg, type='success', timeout=3000) {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div>${msg}</div><button class="btn ghost" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>`;
      const wrap = $('#toasts');
      wrap.appendChild(t);
      const close = () => t.remove();
      t.querySelector('button').addEventListener('click', close);
      if (timeout) setTimeout(close, timeout);
    }
    function setBusy(busy) {
      const sp = $('#spinner');
      sp.style.display = busy ? 'grid' : 'none';
      sp.setAttribute('aria-busy', String(busy));
    }
    function formatCurrency(amount, code) {
      return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: code || 'SAR', maximumFractionDigits: 2 }).format(amount);
    }

    function audit(action, detail='') {
      const li = document.createElement('li');
      const ts = new Date().toLocaleString('ar-SA');
      li.textContent = `[${ts}] ${state.user.name} â€” ${action}${detail ? ' â€” ' + detail : ''}`;
      $('#auditLog').prepend(li);
    }

    /* ============================================================
       Render: Filters + Options
    ============================================================ */
    function initOptions() {
      // Branches
      const bsel = $('#branchSelect');
      bsel.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      // Currencies
      const csel = $('#currencySelect');
      const distinct = [...new Set(currencies.map(c=>c.code))];
      csel.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + distinct.map(c=>`<option value="${c}">${c}</option>`).join('');

      // Restore saved
      $('#fromDate').value = state.filters.fromDate || '';
      $('#toDate').value = state.filters.toDate || '';
      $$('input[name="ptype"]').forEach(r=> r.checked = (r.value === state.filters.ptype));
      bsel.value = state.filters.branch;
      csel.value = state.filters.currency;
      $('#minBalance').value = state.filters.minBalance;
      $('#confirmType').value = state.filters.confirmType;
      $('#includeUnapplied').checked = state.filters.includeUnapplied;
      $('#q').value = state.filters.q;
      $('#sortBy').value = state.filters.sortBy;

      // Template modal restore
      $('#tplPositive').value = state.template.positive;
      $('#tplNegative').value = state.template.negative;
      $('#showOrg').checked = state.template.showOrg;
      $('#showReply').checked = state.template.showReply;
      $('#showMoves').checked = state.template.showMoves;
      $('#showQR').checked = state.template.showQR;
    }

    /* ============================================================
       Filter + Sort + Search
    ============================================================ */
    function applyFilters() {
      // collect UI values
      state.filters.fromDate = $('#fromDate').value;
      state.filters.toDate = $('#toDate').value;
      state.filters.ptype = $('input[name="ptype"]:checked').value;
      state.filters.branch = $('#branchSelect').value;
      state.filters.currency = $('#currencySelect').value;
      state.filters.minBalance = Number($('#minBalance').value || 0);
      state.filters.confirmType = $('#confirmType').value;
      state.filters.includeUnapplied = $('#includeUnapplied').checked;
      state.filters.q = $('#q').value.trim();
      state.filters.sortBy = $('#sortBy').value;
      saveAll();
      renderTable();
    }

    function filteredParties() {
      let rows = parties.slice();
      const f = state.filters;

      if (f.ptype !== 'all') rows = rows.filter(p => p.type === f.ptype);
      if (f.branch !== 'all') rows = rows.filter(p => p.branch === f.branch);
      if (f.currency !== 'all') rows = rows.filter(p => p.currency === f.currency);
      if (f.minBalance > 0) rows = rows.filter(p => (p.balance || 0) >= f.minBalance);

      if (f.confirmType !== 'any') {
        rows = rows.filter(p => (p.lastLetter && p.lastLetter.type === f.confirmType) || !p.lastLetter);
      }

      if (f.q) {
        const q = f.q.toLowerCase();
        rows = rows.filter(p => p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q));
      }

      // (Ø§Ù„ÙØªØ±Ø© + Ø§Ù„Ø­Ø±ÙƒØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©) â€” ØªÙØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ø¹Ø±Ø¶/ØªØ¹Ù„ÙŠÙ‚ ÙÙŠ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨.
      // ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø· Ø§Ù„ÙØªØ±Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§.

      switch (f.sortBy) {
        case 'name': rows.sort((a,b)=> a.name.localeCompare(b.name, 'ar')); break;
        case 'code': rows.sort((a,b)=> a.code.localeCompare(b.code, 'en')); break;
        case 'balance': rows.sort((a,b)=> (b.balance||0) - (a.balance||0)); break;
      }
      return rows;
    }

    function renderTable() {
      const rows = filteredParties();
      const tb = $('#tbody'); tb.innerHTML = '';
      $('#emptyState').hidden = rows.length !== 0;
      const fmtBranch = id => (branches.find(b=>b.id===id)?.name || id);

      rows.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'selectable';
        tr.dataset.id = String(p.id);
        if (state.selected.has(p.id)) tr.classList.add('selected');
        tr.innerHTML = `
          <td><input type="checkbox" aria-label="ØªØ­Ø¯ÙŠØ¯" data-check data-id="${p.id}" ${state.selected.has(p.id)?'checked':''}></td>
          <td>${p.name}</td>
          <td>${p.code}</td>
          <td>${fmtBranch(p.branch)}</td>
          <td>${p.currency}</td>
          <td>${formatCurrency(p.balance, p.currency)}</td>
          <td>${p.aging}</td>
          <td>${renderStatus(p.lastLetter)}</td>
          <td><button class="btn" data-details="${p.id}" title="ØªÙØ§ØµÙŠÙ„">â¤µï¸</button></td>
        `;
        tb.appendChild(tr);

        const dtr = document.createElement('tr');
        dtr.className = 'details';
        dtr.id = `details-${p.id}`;
        dtr.innerHTML = `<td colspan="9">${renderDetails(p)}</td>`;
        tb.appendChild(dtr);
      });

      $('#genTime').textContent = 'ÙˆÙ‚Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯: ' + new Date().toLocaleString('ar-SA');
    }

    function renderStatus(last) {
      if (!last) return `<span class="status-pill status-pending">Ù…Ø¹Ù„Ù‘Ù‚</span>`;
      const map = { 'Ø£ÙØ±Ø³Ù„':'status-sent', 'Ù…Ø¹Ù„Ù‘Ù‚':'status-pending', 'Ù…Ø¹ØªØ±Ø¶':'status-rejected', 'Ù…Ø¤ÙƒØ¯':'status-confirmed' };
      const cls = map[last.status] || 'status-pending';
      return `<span class="status-pill ${cls}">${last.status}</span>`;
    }

    function renderDetails(p) {
      const items = openItems[p.id] || [];
      const itemsHtml = items.length
        ? `<table style="width:100%; border-collapse: collapse" aria-label="ÙÙˆØ§ØªÙŠØ± Ù…ÙØªÙˆØ­Ø©"><thead><tr>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ù…Ø³ØªØ­Ù‚</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">ØºÙŠØ± Ù…Ø·Ø¨Ù‚</th>
          </tr></thead><tbody>
          ${items.map(it=>`<tr>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.doc}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.date}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.due}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${formatCurrency(it.amount, parties.find(x=>x.id===p.id)?.currency)}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${formatCurrency(it.unapplied, parties.find(x=>x.id===p.id)?.currency)}</td>
          </tr>`).join('')}
          </tbody></table>`
        : `<div style="color:var(--ink-2)">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±/Ø­Ø±ÙƒØ§Øª Ù…ÙØªÙˆØ­Ø©.</div>`;

      const lastHtml = p.lastLetter
        ? `<ul style="margin:6px 0 0 0; padding-inline-start: 18px;">
            <li>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${p.lastLetter.date}</li>
            <li>Ø§Ù„Ù†ÙˆØ¹: ${p.lastLetter.type === 'positive' ? 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ' : 'Ø³Ù„Ø¨ÙŠ'}</li>
            <li>Ø§Ù„Ø­Ø§Ù„Ø©: ${p.lastLetter.status}</li>
            <li><a href="#" onclick="event.preventDefault()">Ø±Ø§Ø¨Ø· PDF (ÙˆÙ‡Ù…ÙŠ)</a></li>
          </ul>`
        : `<div style="color:var(--ink-2)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø®Ø·Ø§Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚.</div>`;

      return `
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <strong>Ø¢Ø®Ø± ÙÙˆØ§ØªÙŠØ± Ù…ÙØªÙˆØ­Ø©</strong>
            ${itemsHtml}
          </div>
          <div>
            <strong>Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</strong>
            ${lastHtml}
          </div>
        </div>
      `;
    }

    /* ============================================================
       Selection + Actions
    ============================================================ */
    function toggleRowSelection(id, checked) {
      if (checked) state.selected.add(id); else state.selected.delete(id);
      saveAll();
      const row = $$(`tbody tr.selectable`).find(r => Number(r.dataset.id) === id);
      if (row) row.classList.toggle('selected', checked);
    }

    function selectAllToggle(checked) {
      const ids = filteredParties().map(p=>p.id);
      ids.forEach(id => state.selected.add(id));
      if (!checked) ids.forEach(id => state.selected.delete(id));
      renderTable();
      $('#selectAll').checked = checked;
    }

    /* ============================================================
       Letter Templating
    ============================================================ */
    function buildLetterHTML(p) {
      const t = state.template;
      const orgBlock = t.showOrg ? `
        <div>
          <div style="font-weight:700">Smart Life ERP</div>
          <div>Ø³Ø¬Ù„ ØªØ¬Ø§Ø±ÙŠ: 123456789</div>
          <div>Ø±Ù‚Ù… Ø¶Ø±ÙŠØ¨ÙŠ: 310123456789003</div>
          <div>Ø§Ù„Ø±ÙŠØ§Ø¶ â€” Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
        </div>` : '';
      const txt = (t => t === 'negative' ? state.template.negative : state.template.positive)(
        (state.filters.confirmType==='negative')? 'negative' : 'positive'
      );

      const moves = (openItems[p.id]||[]);
      const movesHtml = state.template.showMoves && moves.length ? `
        <div style="margin-top:10px">
          <strong>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø©:</strong>
          <table style="width:100%; border-collapse: collapse; margin-top:6px">
            <thead>
              <tr>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ù…Ø³ØªØ­Ù‚</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">ØºÙŠØ± Ù…Ø·Ø¨Ù‚</th>
              </tr>
            </thead>
            <tbody>
              ${moves.map(m=>`<tr>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.doc}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.date}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.due}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${formatCurrency(m.amount, p.currency)}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${formatCurrency(m.unapplied, p.currency)}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>` : '';

      const reply = state.template.showReply ? `
        <div class="reply-slip">
          <strong>Ù‚ØµØ§ØµØ© Ø§Ù„Ø±Ø¯</strong>
          <div class="info-grid">
            <div>Ø§Ù„Ø·Ø±Ù: ${p.name} (${p.code})</div>
            <div>Ø§Ù„ÙØ±Ø¹: ${branches.find(b=>b.id===p.branch)?.name}</div>
            <div>Ø§Ù„Ø¹Ù…Ù„Ø©: ${p.currency}</div>
            <div>Ø§Ù„Ø±ØµÙŠØ¯: ${formatCurrency(p.balance, p.currency)}</div>
          </div>
          <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items:center;">
            <div>
              <div>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹: __________________</div>
              <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ§Ù„Ø®ØªÙ…: ______________</div>
              <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: ____ / ____ / ______</div>
            </div>
            ${state.template.showQR ? `<div class="qr" title="QR" aria-label="QR"></div>` : ''}
          </div>
        </div>` : '';

      return `
        <article class="letter" data-party-id="${p.id}">
          <header>
            <div class="brand"><div class="logo" aria-hidden="true">SL</div><h3>Ø®Ø·Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø±ØµÙŠØ¯</h3></div>
            ${orgBlock}
          </header>
          <div class="info-grid">
            <div>Ø§Ù„Ø·Ø±Ù: <strong>${p.name}</strong> (${p.code})</div>
            <div>Ø§Ù„Ù†ÙˆØ¹: ${p.type === 'customer' ? 'Ø¹Ù…ÙŠÙ„' : 'Ù…ÙˆØ±Ø¯'}</div>
            <div>Ø§Ù„ÙØ±Ø¹: ${branches.find(b=>b.id===p.branch)?.name}</div>
            <div>Ø§Ù„Ø¹Ù…Ù„Ø©: ${p.currency}</div>
            <div>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${formatCurrency(p.balance, p.currency)}</div>
            <div>Ø¹Ù…Ø± Ø§Ù„Ø¯ÙŠÙ†: ${p.aging}</div>
          </div>
          <p style="margin-top:8px">${txt}</p>
          <p style="color:#475569; font-size: 14px;">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· (ÙˆÙ‡Ù…ÙŠ): <a href="#">https://confirm.example/${p.id}</a></p>
          ${movesHtml}
          ${reply}
        </article>
      `;
    }

    /* ============================================================
       Actions: Generate / Preview / Email / ZIP / PDF merged
    ============================================================ */
    function requireSelection() {
      if (state.selected.size === 0) { toast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warn'); return false; }
      return true;
    }

    async function generateLetters() {
      if (!requireSelection()) return;
      setBusy(true);
      await new Promise(r=>setTimeout(r, 300)); // fake small delay
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const html = buildLetterHTML(p);
        state.generatedMap.set(id, html);
      }
      setBusy(false);
      toast('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'success');
      audit('ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø§Ø¨Ø§Øª', `Ø¹Ø¯Ø¯: ${state.selected.size}`);

      // Ø§ÙØªØ­ Ø£ÙˆÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø©
      const first = state.selected.values().next().value;
      if (first) showPreview(first);
    }

    function showPreview(id) {
      const html = state.generatedMap.get(id);
      if (!html) { toast('Ù„ÙŠØ³ Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø§ÙŠÙ†Ø© â€” Ù‚Ù… Ø¨Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø£ÙˆÙ„Ù‹Ø§', 'warn'); return; }
      $('#previewArea').innerHTML = html;
      $('#previewModal').showModal();
    }

    function downloadAsHTMLBlob(filename, html) {
      const blob = new Blob([`<!doctype html><html lang=\"ar\" dir=\"rtl\"><meta charset=\"utf-8\"><title>${filename}</title><body>${html}</body></html>`], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename + '.html';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function downloadZIP() {
      if (!requireSelection()) return;
      if (state.generatedMap.size === 0) { toast('Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ù‹Ø§', 'warn'); return; }

      // Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª: ØªÙ†Ø²ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯ ÙƒÙ€ HTML Blobs
      // TODO: Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© JSZipØŒ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP ÙˆØ§Ø­Ø¯ ÙŠØ¬Ù…Ø¹ ÙƒÙ„ HTML/PDF.
      let count = 0;
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const html = state.generatedMap.get(id);
        if (html) { downloadAsHTMLBlob(`${p.code}-${p.name}-letter`, html); count++; }
      }
      toast(`ØªÙ… ØªØ¬Ù‡ÙŠØ² ${count} Ù…Ù„ÙÙ‹Ø§ Ù„Ù„ØªÙ†Ø²ÙŠÙ„ (HTML)`, 'success');
      audit('ØªÙ†Ø²ÙŠÙ„ Ù…ØªØ¹Ø¯Ø¯', `Ø¹Ø¯Ø¯: ${count}`);
    }

    async function sendEmailFake() {
      if (!requireSelection()) return;
      setBusy(true);
      await new Promise(r=>setTimeout(r, 1000)); // ØªØ£Ø®ÙŠØ± ÙˆÙ‡Ù…ÙŠ
      setBusy(false);
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø®Ø·Ø§Ø¨
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        p.lastLetter = { date: new Date().toISOString().slice(0,10), type: state.filters.confirmType==='negative'?'negative':'positive', status:'Ø£ÙØ±Ø³Ù„' };
      }
      renderTable();
      toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù…Ø­Ø§ÙƒØ§Ø©)', 'success');
      audit('Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯', `Ø¹Ø¯Ø¯: ${state.selected.size}`);
    }

    function mergedPDFPreview() {
      if (!requireSelection()) return;
      if (state.generatedMap.size === 0) { toast('Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø£ÙˆÙ„Ù‹Ø§', 'warn'); return; }
      const wrap = $('#printContainer');
      wrap.innerHTML = '';
      for (const id of state.selected) {
        const html = state.generatedMap.get(id);
        if (html) {
          const div = document.createElement('div');
          div.innerHTML = html;
          wrap.appendChild(div.firstElementChild); // article.letter
        }
      }
      wrap.hidden = false;
      toast('Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© â€” Ø³ÙŠÙÙØµÙ„ ÙƒÙ„ Ø®Ø·Ø§Ø¨ ÙÙŠ ØµÙØ­Ø© Ù…Ø³ØªÙ‚Ù„Ø©', 'success');
      setTimeout(()=>window.print(), 50);
      audit('Ù…Ø¹Ø§ÙŠÙ†Ø© PDF Ù…Ø¯Ù…Ø¬ (Ø·Ø¨Ø§Ø¹Ø© HTML)', `Ø¹Ø¯Ø¯: ${state.selected.size}`);
    }

    /* ============================================================
       Events Wiring
    ============================================================ */
    function wireEvents() {
      $('#applyFilters').addEventListener('click', applyFilters);
      $('#resetFilters').addEventListener('click', () => {
        Object.assign(state.filters, { fromDate:'', toDate:'', ptype:'all', branch:'all', currency:'all', minBalance:0, confirmType:'any', includeUnapplied:false, q:'', sortBy:'name' });
        saveAll(); initOptions(); renderTable();
      });

      $('#q').addEventListener('input', () => { state.filters.q = $('#q').value; renderTable(); });
      $('#sortBy').addEventListener('change', () => { state.filters.sortBy = $('#sortBy').value; saveAll(); renderTable(); });
      $('#selectAll').addEventListener('change', e => selectAllToggle(e.target.checked));

      $('#tbody').addEventListener('change', e => {
        if (e.target.matches('[data-check]')) {
          const id = Number(e.target.dataset.id);
          toggleRowSelection(id, e.target.checked);
        }
      });

      $('#tbody').addEventListener('click', e => {
        const btn = e.target.closest('[data-details]');
        if (btn) {
          const id = btn.getAttribute('data-details');
          const row = document.getElementById('details-' + id);
          row.classList.toggle('open');
        }
      });

      $('#btnGenerate').addEventListener('click', generateLetters);
      $('#btnEmail').addEventListener('click', sendEmailFake);
      $('#btnZip').addEventListener('click', downloadZIP);
      $('#btnPDF').addEventListener('click', mergedPDFPreview);

      // Preview modal actions
      $('#printLetter').addEventListener('click', () => window.print());
      $('#downloadLetter').addEventListener('click', () => {
        const article = $('#previewArea .letter');
        if (!article) return toast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†Ø´Ø·Ø©', 'warn');
        const id = Number(article.getAttribute('data-party-id'));
        const p = parties.find(x=>x.id===id);
        downloadAsHTMLBlob(`${p.code}-${p.name}-letter`, article.outerHTML);
      });

      // open/close modals
      $('#openTemplateBtn').addEventListener('click', () => $('#templateModal').showModal());
      $$('dialog [data-close]').forEach(b => b.addEventListener('click', e => e.target.closest('dialog').close()));

      // save template
      $('#saveTemplate').addEventListener('click', () => {
        state.template.positive = $('#tplPositive').value.trim() || state.template.positive;
        state.template.negative = $('#tplNegative').value.trim() || state.template.negative;
        state.template.showOrg = $('#showOrg').checked;
        state.template.showReply = $('#showReply').checked;
        state.template.showMoves = $('#showMoves').checked;
        state.template.showQR = $('#showQR').checked;
        saveAll();
        toast('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù„Ø¨', 'success');
      });
      $('#resetTemplate').addEventListener('click', () => {
        state.template = {
          positive: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¯ÙŠÙ†Ø§ ÙƒÙ…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶Ø­ Ø£Ø¯Ù†Ø§Ù‡. Ù†Ø±Ø¬Ùˆ ØªØ£ÙƒÙŠØ¯ÙƒÙ… Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.',
          negative: 'Ù†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø±ØµÙŠØ¯ Ø­Ø³Ø§Ø¨ÙƒÙ… Ù„Ø¯ÙŠÙ†Ø§ ÙŠØ¸Ù‡Ø± Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ØŒ ÙˆÙ†Ø±Ø¬Ùˆ Ù…Ù†ÙƒÙ… Ø¥ÙØ§Ø¯ØªÙ†Ø§ Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø¤ÙŠØ¯Ø© Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù….',
          showOrg: true, showReply: true, showMoves: true, showQR: false
        };
        initOptions(); saveAll();
        toast('ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ', 'success');
      });

      // theme toggle
      $('#toggleTheme').addEventListener('click', (e) => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        e.currentTarget.setAttribute('aria-pressed', String(!isDark));
      });

      // row click selects checkbox (keyboard friendly)
      $('#tbody').addEventListener('click', e => {
        const tr = e.target.closest('tr.selectable');
        if (tr && !e.target.closest('input,button,a')) {
          const id = Number(tr.dataset.id);
          const cb = tr.querySelector('[data-check]');
          cb.checked = !cb.checked; cb.dispatchEvent(new Event('change', {bubbles:true}));
        }
      });

      // keyboard navigation hint: focus first input
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); $('#q').focus(); }
      });
    }

    /* ============================================================
       Init
    ============================================================ */
    function init() {
      loadAll();
      initOptions();
      renderTable();
      wireEvents();
      audit('Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµÙØ­Ø©');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
