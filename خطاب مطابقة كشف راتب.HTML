<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>خطاب مطابقة الرصيد — نسخة احترافية v1.1</title>
  <meta name="description" content="واجهة احترافية لإدارة وإرسال خطابات مطابقة الرصيد مع قواعد مطابقة قابلة للتهيئة وتقارير وتتبّع." />
  <style>
    /* ==========================
       Reset & Base
    ========================== */
    *, *::before, *::after { box-sizing: border-box; }
    :root {
      --primary: #0ea5e9; /* sky-500 */
      --primary-600: #0284c7;
      --bg: #ffffff;
      --ink: #0f172a; /* slate-900 */
      --ink-2: #334155; /* slate-700 */
      --muted: #f1f5f9; /* slate-100 */
      --muted-2:#e2e8f0; /* slate-200 */
      --border: #e2e8f0; /* slate-200 */
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --focus: #60a5fa;
      --card: #ffffff;
    }
    [data-theme="dark"] {
      --bg: #0b1220; /* deep navy */
      --ink: #e5e7eb;
      --ink-2: #cbd5e1;
      --muted: #0f172a;
      --muted-2:#1f2937;
      --border: #1f2937;
      --card: #0e1628;
    }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--ink); font: 400 15px/1.65 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Kufi Arabic", Tahoma, sans-serif; }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }
    button, input, select, label, textarea { font: inherit; }
    .container { max-width: 1320px; margin-inline: auto; padding: 0 16px; }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px); white-space: nowrap; }

    /* ==========================
       Header
    ========================== */
    header.site-header { position: sticky; top: 0; z-index: 60; background: var(--bg); border-bottom: 1px solid var(--border); backdrop-filter: blur(6px); }
    .header-inner { display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 12px 0; }
    .brand { display:flex; align-items:center; gap:10px; }
    .logo { inline-size: 36px; block-size: 36px; border-radius: 10px; background: radial-gradient(120% 120% at 10% 10%, var(--primary), var(--primary-600)); display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.3px; box-shadow: 0 6px 18px rgba(2,132,199,.25); }
    nav ul { margin: 0; padding: 0; list-style: none; display: flex; gap: 6px; }
    nav a, nav button { display: inline-flex; align-items: center; padding: 8px 10px; border-radius: 10px; border: 1px solid transparent; background: transparent; color: var(--ink); }
    nav a:is(:hover, :focus-visible), nav button:is(:hover, :focus-visible) { background: var(--muted); outline: none; }

    /* ==========================
       Layout
    ========================== */
    main { display: grid; grid-template-columns: 330px 1fr; gap: 16px; padding: 16px 0 0; }
    @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }

    aside.card, section.card { position: relative; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; box-shadow: 0 2px 10px rgba(2,6,23,.04); }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .subtle { color: var(--ink-2); font-size: 13px; }

    .field { display: grid; gap: 6px; margin: 10px 0; }
    .row { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }

    .btn { appearance: none; border: 1px solid var(--muted-2); background: #fff; color: var(--ink); padding: 8px 12px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: .15s ease; }
    .btn.primary { background: var(--primary); border-color: var(--primary); color: #fff; box-shadow: 0 6px 16px rgba(14,165,233,.25); }
    .btn.ghost { background: transparent; }
    .btn:is(:hover) { transform: translateY(-1px); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:is(:focus-visible) { outline: 2px solid var(--focus); outline-offset: 2px; }

    section.results { padding: 0; overflow: hidden; }
    .toolbar { display:flex; gap:8px; align-items:center; padding: 12px; border-bottom: 1px solid var(--border); background: linear-gradient(0deg, var(--bg), #fff); position: sticky; top: 56px; z-index: 5; }
    .toolbar .grow { flex: 1; }
    .input { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--border); background: #fff; padding: 8px 10px; border-radius: 10px; }
    .input input { border: 0; outline: none; background: transparent; min-inline-size: 160px; }
    .select, .input, textarea { border-radius: 10px; }
    .select { border: 1px solid var(--border); background:#fff; padding: 8px 10px; }
    .checkbox { display:inline-flex; gap:8px; align-items:center; }

    /* Table */
    .table-wrap { overflow:auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th { position: sticky; top: calc(56px + 48px); background: var(--muted); z-index: 4; text-align: start; font-weight: 700; padding: 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
    tbody tr.selectable:hover { background: #f8fafc; }
    tbody tr.selected { background: #eef6ff; outline: 2px solid #dbeafe; }

    .status-pill { display:inline-flex; align-items:center; gap:6px; padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid var(--border); }
    .status-sent { background:#ecfdf5; border-color:#bbf7d0; }
    .status-pending { background:#fff7ed; border-color:#fed7aa; }
    .status-rejected { background:#fef2f2; border-color:#fecaca; }
    .status-confirmed { background:#eff6ff; border-color:#bfdbfe; }
    .status-matched { background:#ecfdf5; border-color:#bbf7d0; }
    .status-mismatch { background:#fef2f2; border-color:#fecaca; }
    .status-review { background:#fff7ed; border-color:#fed7aa; }

    .badge { font-size: 11px; padding: 2px 6px; border:1px solid var(--muted-2); border-radius: 999px; }

    .details { grid-column: 1 / -1; background: #fcfdff; border-inline-start: 4px solid var(--primary); display: none; }
    .details.open { display: table-row; animation: fade .2s ease-in; }
    @keyframes fade { from { opacity: 0 } to { opacity: 1 } }

    .empty { padding: 32px; text-align: center; color: var(--ink-2); }

    footer { margin: 16px 0 24px; color: var(--ink-2); font-size: 13px; display:flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; }

    /* ==========================
       Modals & Overlays
    ========================== */
    dialog.modal { border: 0; border-radius: 16px; padding: 0; width: min(100% - 24px, 1000px); }
    .modal header { padding: 12px 16px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content: space-between; }
    .modal .content { padding: 16px; max-block-size: 70vh; overflow: auto; background: var(--bg); }
    .modal footer { padding: 12px 16px; border-top: 1px solid var(--border); display:flex; gap: 8px; justify-content: end; }
    dialog::backdrop { background: rgba(0,0,0,.35); }

    .settings-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .template-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    /* Toasts */
    .toasts { position: fixed; inset-inline-start: 16px; inset-block-end: 16px; display: grid; gap: 10px; z-index: 100; }
    .toast { background: #fff; color: var(--ink); border: 1px solid var(--border); border-inline-start: 4px solid var(--primary); padding: 10px 12px; border-radius: 12px; display:flex; align-items: start; gap: 10px; min-width: 280px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .toast.success { border-inline-start-color: var(--success); }
    .toast.warn { border-inline-start-color: var(--warn); }
    .toast.danger { border-inline-start-color: var(--danger); }
    .toast button { margin-inline-start: auto; }

    /* Spinner */
    .spinner { position: fixed; inset: 0; display: none; place-items: center; background: rgba(255,255,255,.6); z-index: 90; }
    .spinner .ring { inline-size: 56px; block-size: 56px; border: 6px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(-360deg); } }

    /* ==========================
       Print Styles (letters only)
    ========================== */
    @media print {
      body { background: #fff; }
      header.site-header, aside.card, .toolbar, .table-wrap, footer, .toasts, .spinner, #rulesCard { display: none !important; }
      .print-letters { display: block !important; }
      .letter { page-break-after: always; break-after: page; }
      .letter:last-child { page-break-after: auto; break-after: auto; }
    }

    /* Letter (Preview HTML) */
    .letter { color: #111827; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .letter header { display:flex; align-items:center; justify-content: space-between; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 12px; }
    .letter .brand { gap: 10px; }
    .letter h3 { margin: 0; font-size: 18px; }
    .info-grid { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 14px; font-size: 14px; margin: 10px 0 6px; }
    .reply-slip { margin-top: 12px; border-top: 2px dashed #cbd5e1; padding-top: 10px; }
    .qr { inline-size: 72px; block-size: 72px; background: repeating-linear-gradient(45deg, #000 0 4px, #fff 4px 8px); border-radius: 6px; }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="container header-inner">
      <div class="brand" aria-label="المؤسسة">
        <div class="logo" aria-hidden="true">SL</div>
        <div>
          <div style="font-weight:800">Smart Life — المطابقة</div>
          <div class="subtle">إدارة وإرسال خطابات مطابقة الرصيد — قواعد مطابقة قابلة للتهيئة</div>
        </div>
      </div>
      <nav aria-label="روابط رئيسية">
        <ul>
          <li><a href="#" aria-current="page">الرئيسية</a></li>
          <li><a href="#" id="openRulesBtn" title="قواعد المطابقة">قواعد المطابقة</a></li>
          <li><a href="#" id="openTemplateBtn" title="إعدادات القالب">القوالب</a></li>
          <li><button class="btn ghost" id="toggleTheme" aria-pressed="false" title="تبديل الوضع الداكن">🌙</button></li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container">
    <main id="main" role="main">
      <!-- Sidebar / Filters -->
      <aside class="card" aria-label="فلاتر وإعدادات">
        <h2>الفلاتر</h2>
        <div class="subtle">فلترة الأطراف المراد إرسال خطابات مطابقة لهم.</div>
        <div class="field row" aria-label="الفترة">
          <div class="field">
            <label for="fromDate">من</label>
            <input id="fromDate" type="date" />
          </div>
          <div class="field">
            <label for="toDate">إلى</label>
            <input id="toDate" type="date" />
          </div>
        </div>

        <div class="field" role="group" aria-label="نوع الطرف">
          <label>نوع الطرف</label>
          <div class="row">
            <label class="checkbox"><input type="radio" name="ptype" value="all" checked /> الكل</label>
            <label class="checkbox"><input type="radio" name="ptype" value="customer" /> عميل</label>
            <label class="checkbox"><input type="radio" name="ptype" value="vendor" /> مورد</label>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="branchSelect">الفرع</label>
            <select id="branchSelect" class="select"></select>
          </div>
          <div class="field">
            <label for="currencySelect">العملة</label>
            <select id="currencySelect" class="select"></select>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="minBalance">حد أدنى للرصيد</label>
            <input id="minBalance" type="number" inputmode="decimal" placeholder="0" />
          </div>
          <div class="field">
            <label for="confirmType">نوع التأكيد الافتراضي</label>
            <select id="confirmType" class="select">
              <option value="positive">إيجابي</option>
              <option value="negative">سلبي</option>
              <option value="any">غير محدد</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label class="checkbox"><input id="includeUnapplied" type="checkbox" /> تضمين الحركات غير المطبّقة</label>
        </div>

        <div class="actions">
          <button class="btn primary" id="applyFilters">تطبيق الفلاتر</button>
          <button class="btn" id="resetFilters">تصفير</button>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid var(--border)"/>
        <div class="field">
          <label>حفظ الإعدادات</label>
          <label class="checkbox"><input id="autoSave" type="checkbox" checked /> حفظ تلقائي في هذا المتصفح</label>
        </div>
      </aside>

      <!-- Results / Grid -->
      <section class="results card" aria-live="polite" aria-busy="false">
        <div class="toolbar" role="region" aria-label="شريط أدوات">
          <div class="input grow" aria-label="بحث سريع">
            🔎
            <input id="q" type="search" placeholder="بحث باسم/رقم الطرف" />
          </div>
          <select id="sortBy" class="select" aria-label="فرز حسب">
            <option value="name">الاسم</option>
            <option value="code">الكود</option>
            <option value="balance">الرصيد</option>
          </select>
          <label class="checkbox" title="تحديد الكل"><input id="selectAll" type="checkbox" /> تحديد الكل</label>
          <button class="btn" id="btnCalc">إعادة احتساب المطابقة</button>
          <button class="btn" id="btnGenerate">توليد خطابات</button>
          <button class="btn" id="btnEmail">إرسال بالبريد</button>
          <button class="btn" id="btnZip">تنزيل ZIP</button>
          <button class="btn" id="btnPDF">PDF مدمج</button>
        </div>

        <div class="table-wrap" id="tableWrap">
          <table aria-describedby="tableCaption">
            <caption id="tableCaption" class="visually-hidden">جدول الأطراف</caption>
            <thead>
              <tr>
                <th style="width:36px"></th>
                <th>اسم الطرف</th>
                <th>الكود</th>
                <th>الفرع</th>
                <th>العملة</th>
                <th>الرصيد</th>
                <th>عمر الدين</th>
                <th>نتيجة المطابقة</th>
                <th>حالة الخطاب</th>
                <th style="width:48px">تفاصيل</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
          <div id="emptyState" class="empty" hidden>لا نتائج مطابقة — عدّل الفلاتر أو البحث.</div>
        </div>
      </section>
    </main>

    <section id="rulesCard" class="card" aria-label="قواعد المطابقة">
      <h2>قواعد المطابقة (ملخص)</h2>
      <div class="subtle">تُطبَّق القواعد التالية لاقتراح نتيجة المطابقة تلقائيًا. يمكن تعديلها من "قواعد المطابقة".</div>
      <ul id="rulesSummary" style="margin:8px 0 0 0; padding-inline-start: 18px; line-height:1.8"></ul>
    </section>

    <footer>
      <div>نسخة الواجهة: v1.1 — (واجهة فقط)</div>
      <div id="genTime">وقت التوليد: —</div>
      <div><a href="#" target="_blank" rel="noopener">سياسة الخصوصية</a></div>
    </footer>

    <!-- سجل تدقيقي -->
    <section aria-label="سجل العمليات" class="card">
      <h3 style="margin-top:0">السجل التدقيقي</h3>
      <ol id="auditLog" start="1" style="margin:0; padding-inline-start: 22px;"></ol>
      <p class="subtle" style="margin-top:8px">* يمكن ربطه لاحقًا بصلاحيات العرض/الإخفاء.</p>
    </section>
  </div>

  <!-- Modals -->
  <dialog id="previewModal" class="modal" aria-label="معاينة الخطاب">
    <header>
      <strong>معاينة الخطاب</strong>
      <button class="btn" data-close>إغلاق</button>
    </header>
    <div class="content">
      <div id="previewArea"></div>
    </div>
    <footer>
      <button class="btn" id="printLetter">طباعة</button>
      <button class="btn" id="downloadLetter">تنزيل HTML</button>
      <button class="btn primary" data-close>تم</button>
    </footer>
  </dialog>

  <dialog id="templateModal" class="modal" aria-label="إعدادات القالب">
    <header>
      <strong>القوالب والنصوص الديناميكية</strong>
      <button class="btn" data-close>إغلاق</button>
    </header>
    <div class="content">
      <div class="template-grid">
        <label class="field">
          <span>نص الخطاب (إيجابي)</span>
          <textarea id="tplPositive" rows="6" placeholder="نص التأكيد الإيجابي مع متغيرات مثل {party}, {balance}, {code}, {branch}"></textarea>
        </label>
        <label class="field">
          <span>نص الخطاب (سلبي)</span>
          <textarea id="tplNegative" rows="6" placeholder="نص التأكيد السلبي مع المتغيرات"></textarea>
        </label>
        <div class="field">
          <label class="checkbox"><input id="showOrg" type="checkbox" checked /> إظهار بيانات المؤسسة</label>
          <label class="checkbox"><input id="showReply" type="checkbox" checked /> إظهار قصاصة الرد</label>
          <label class="checkbox"><input id="showMoves" type="checkbox" checked /> إظهار ملخص الحركات</label>
          <label class="checkbox"><input id="showQR" type="checkbox" /> إظهار QR</label>
          <small class="subtle">المتغيرات المدعومة داخل النص: {party}, {code}, {branch}, {currency}, {balance}, {today}</small>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn" id="saveTemplate">حفظ</button>
      <button class="btn" id="resetTemplate">استعادة الافتراضي</button>
      <button class="btn primary" data-close>تم</button>
    </footer>
  </dialog>

  <dialog id="rulesModal" class="modal" aria-label="قواعد المطابقة">
    <header>
      <strong>قواعد المطابقة</strong>
      <button class="btn" data-close>إغلاق</button>
    </header>
    <div class="content">
      <div class="settings-grid">
        <div class="card" style="border:1px dashed var(--border)">
          <h3 style="margin-top:0">القواعد العامة</h3>
          <div class="field">
            <label for="tolAmount">هامش السماحية المالي (بالعملة)</label>
            <input id="tolAmount" type="number" inputmode="decimal" placeholder="0" />
            <small class="subtle">مثال: 5.00 — يعتبر الفرق حتى هذا المبلغ مُطابِقًا.</small>
          </div>
          <div class="field">
            <label for="tolPercent">هامش السماحية النسبي (%)</label>
            <input id="tolPercent" type="number" inputmode="decimal" placeholder="0" />
            <small class="subtle">مثال: 1% من الرصيد — يُستخدم إذا كان أكبر من السماحية المالية.</small>
          </div>
          <div class="field">
            <label class="checkbox"><input id="requireZeroUnapplied" type="checkbox" /> اعتبر المطابقة صحيحة فقط إذا كانت الحركات غير المطبقة = صفر</label>
          </div>
          <div class="field">
            <label class="checkbox"><input id="autoDisputeNegative" type="checkbox" /> تعليم الحالة تلقائيًا "معترض" عند اختيار تأكيد سلبي</label>
          </div>
        </div>

        <div class="card" style="border:1px dashed var(--border)">
          <h3 style="margin-top:0">سلوك الحالة</h3>
          <div class="field">
            <label for="defaultStatus">الحالة الافتراضية</label>
            <select id="defaultStatus" class="select">
              <option value="pending">قيد المراجعة</option>
              <option value="matched">مطابق</option>
              <option value="mismatch">غير مطابق</option>
            </select>
          </div>
          <div class="field">
            <label class="checkbox"><input id="allowManualOverride" type="checkbox" checked /> السماح بتعديل الحالة يدويًا مع سبب</label>
          </div>
          <div class="field">
            <label for="noteTemplate">قالب ملاحظة المطابقة</label>
            <textarea id="noteTemplate" rows="4" placeholder="مثال: تم احتساب المطابقة بناءً على هامش سماحية {tolAmount} والفرق الفعلي {diff}"></textarea>
          </div>
        </div>
      </div>
    </div>
    <footer>
      <button class="btn" id="saveRules">حفظ</button>
      <button class="btn primary" data-close>تم</button>
    </footer>
  </dialog>

  <!-- Overlays -->
  <div class="spinner" id="spinner" aria-live="polite" aria-busy="false"><div class="ring" role="status" aria-label="جارٍ المعالجة"></div></div>
  <div class="toasts" id="toasts" aria-live="polite"></div>

  <!-- Print container for merged PDF (HTML) -->
  <div id="printContainer" class="print-letters" hidden></div>

  <script>
    /* ============================================================
       بيانات تجريبية (Dummy Data)
    ============================================================ */
    const branches = [{id:"R", name:"الرياض"},{id:"K", name:"الخبر"}];
    const currencies = [{code:"SAR", name:"ريال سعودي"},{code:"USD", name:"دولار"}];
    const parties = [
      {id:1, type:"customer", name:"مؤسسة بهاء عسير", code:"C-001", branch:"R", currency:"SAR", balance: 18250.75, aging:"30-60", lastLetter:{date:"2025-03-01", type:"positive", status:"أُرسل"}},
      {id:2, type:"customer", name:"شركة نماء الشامل", code:"C-002", branch:"K", currency:"SAR", balance: 0, aging:"0-30", lastLetter:null},
      {id:3, type:"vendor", name:"أصالة الجنوب", code:"V-019", branch:"R", currency:"SAR", balance: 5400, aging:">90", lastLetter:{date:"2025-02-10", type:"negative", status:"معترض"}},
      {id:4, type:"customer", name:"شركة روّاد النظم", code:"C-014", branch:"K", currency:"SAR", balance: 1220.10, aging:"0-30", lastLetter:{date:"2025-01-15", type:"positive", status:"مؤكد"}},
      {id:5, type:"vendor", name:"تقنية السحاب", code:"V-022", branch:"R", currency:"USD", balance: 310.00, aging:"30-60", lastLetter:{date:"2025-02-21", type:"positive", status:"أُرسل"}},
      {id:6, type:"customer", name:"متاجر الوفرة", code:"C-099", branch:"R", currency:"SAR", balance: 9800.00, aging:"60-90", lastLetter:{date:"2025-04-01", type:"positive", status:"معلّق"}},
      {id:7, type:"vendor", name:"الركن الحديث", code:"V-120", branch:"K", currency:"SAR", balance: 50.75, aging:"0-30", lastLetter:null},
      {id:8, type:"customer", name:"حلول الميرة", code:"C-201", branch:"K", currency:"SAR", balance: 25000.00, aging:">90", lastLetter:{date:"2025-03-25", type:"negative", status:"معترض"}},
      {id:9, type:"customer", name:"دواء الشفاء", code:"C-341", branch:"R", currency:"SAR", balance: 150.00, aging:"0-30", lastLetter:{date:"2024-12-29", type:"positive", status:"أُرسل"}},
      {id:10, type:"vendor", name:"مرابع الشمال", code:"V-211", branch:"K", currency:"USD", balance: 0, aging:"0-30", lastLetter:null},
      {id:11, type:"customer", name:"سنا المجرة", code:"C-412", branch:"R", currency:"SAR", balance: 610.90, aging:"30-60", lastLetter:null},
      {id:12, type:"customer", name:"الماس الذهبي", code:"C-555", branch:"K", currency:"SAR", balance: 120000.45, aging:">90", lastLetter:{date:"2025-05-11", type:"positive", status:"أُرسل"}},
      {id:13, type:"vendor", name:"أطياب القصيم", code:"V-310", branch:"R", currency:"SAR", balance: 70.00, aging:"0-30", lastLetter:{date:"2025-03-03", type:"negative", status:"أُرسل"}},
      {id:14, type:"customer", name:"سفير البناء", code:"C-777", branch:"R", currency:"SAR", balance: 4321.00, aging:"60-90", lastLetter:{date:"2025-02-05", type:"positive", status:"معلّق"}},
      {id:15, type:"vendor", name:"أنظمة رشيقة", code:"V-404", branch:"K", currency:"SAR", balance: 889.90, aging:"30-60", lastLetter:null},
    ];

    const openItems = {
      1: [{doc:"INV-101", date:"2025-01-10", due:"2025-02-10", amount: 7250, unapplied: 0}],
      2: [{doc:"INV-220", date:"2025-03-05", due:"2025-04-05", amount: 4200, unapplied: 300}],
      3: [{doc:"BILL-778", date:"2024-12-20", due:"2025-01-20", amount: 5400, unapplied: 0}],
      4: [{doc:"INV-330", date:"2025-02-02", due:"2025-03-02", amount: 1220.1, unapplied: 0}],
      6: [{doc:"INV-991", date:"2025-04-10", due:"2025-05-10", amount: 9800, unapplied: 0}],
      8: [{doc:"INV-880", date:"2025-01-11", due:"2025-02-11", amount: 25000, unapplied: 0}],
      12:[{doc:"INV-1001", date:"2025-05-01", due:"2025-06-01", amount: 120000.45, unapplied: 0}],
      14:[{doc:"INV-712", date:"2025-01-22", due:"2025-02-22", amount: 4321, unapplied: 0}],
    };

    /* ============================================================
       حالة التطبيق + LocalStorage
    ============================================================ */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const state = {
      filters: {
        fromDate: '', toDate: '',
        ptype: 'all', branch: 'all', currency: 'all',
        minBalance: 0, confirmType: 'positive', includeUnapplied: false,
        q: '', sortBy: 'name'
      },
      template: {
        positive: 'نفيدكم بأن رصيد حسابكم لدينا مطابق لسجلاتنا. الطرف: {party} ({code}) — الفرع: {branch} — الرصيد: {balance}. نرجو تأكيدكم الإيجابي خلال 7 أيام من تاريخه {today}.',
        negative: 'نفيدكم بوجود اختلاف في رصيد حسابكم لدينا للطرف: {party} ({code}). الرصيد الظاهر لدينا: {balance}. نأمل التزويد بالملاحظات والمستندات خلال 7 أيام من تاريخه {today}.',
        showOrg: true, showReply: true, showMoves: true, showQR: false
      },
      rules: {
        tolAmount: 5.00,
        tolPercent: 1.0,
        requireZeroUnapplied: false,
        autoDisputeNegative: true,
        defaultStatus: 'pending',
        allowManualOverride: true,
        noteTemplate: 'تم احتساب المطابقة بهامش سماحية {tolAmount} (و/أو {tolPercent}%) — الفارق الفعلي: {diff}.'
      },
      selected: new Set(),
      generatedMap: new Map(), // id -> HTML string
      partyStatus: new Map(), // id -> { result, status, note }
      user: { name: 'مستخدم افتراضي' }
    };

    const STORAGE_KEY = 'match_letters_pro_v11';
    const saveAll = () => {
      if (!$('#autoSave').checked) return;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    };
    const loadAll = () => {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const obj = JSON.parse(raw);
        Object.assign(state.filters, obj.filters || {});
        Object.assign(state.template, obj.template || {});
        Object.assign(state.rules, obj.rules || {});
      } catch {}
    };

    /* ============================================================
       Helpers
    ============================================================ */
    function toast(msg, type='success', timeout=3000) {
      const t = document.createElement('div');
      t.className = `toast ${type}`;
      t.innerHTML = `<div>${msg}</div><button class="btn ghost" aria-label="إغلاق">✕</button>`;
      const wrap = $('#toasts');
      wrap.appendChild(t);
      const close = () => t.remove();
      t.querySelector('button').addEventListener('click', close);
      if (timeout) setTimeout(close, timeout);
    }
    function setBusy(busy) {
      const sp = $('#spinner');
      sp.style.display = busy ? 'grid' : 'none';
      sp.setAttribute('aria-busy', String(busy));
    }
    function formatCurrency(amount, code) {
      return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: code || 'SAR', maximumFractionDigits: 2 }).format(amount);
    }
    function audit(action, detail='') {
      const li = document.createElement('li');
      const ts = new Date().toLocaleString('ar-SA');
      li.textContent = `[${ts}] ${state.user.name} — ${action}${detail ? ' — ' + detail : ''}`;
      $('#auditLog').prepend(li);
    }
    function summarizeRules(){
      const r = state.rules;
      const ul = $('#rulesSummary');
      ul.innerHTML = `
        <li>هامش سماحية مالي: <strong>${r.tolAmount}</strong> + هامش نسبي: <strong>${r.tolPercent}%</strong></li>
        <li>${r.requireZeroUnapplied ? 'يشترط أن تكون الحركات غير المطبقة = 0' : 'لا يشترط صفر حركات غير مطبقة'}</li>
        <li>الحالة الافتراضية: <span class="badge">${mapStatusLabel(r.defaultStatus)}</span></li>
        <li>${r.allowManualOverride ? 'السماح بالتعديل اليدوي للحالة' : 'منع التعديل اليدوي'}</li>`;
    }

    function mapResultLabel(res){
      return res === 'matched' ? 'مطابق' : res === 'mismatch' ? 'غير مطابق' : 'قيد المراجعة';
    }
    function mapStatusLabel(st){
      return st === 'matched' ? 'مؤكد/مطابق' : st === 'mismatch' ? 'معترض/غير مطابق' : 'قيد المراجعة';
    }

    /* ============================================================
       قواعد المطابقة (Logic)
    ============================================================ */
    function computeMatchForParty(p){
      const r = state.rules;
      const items = openItems[p.id] || [];
      const unappliedSum = items.reduce((s,it)=> s + (Number(it.unapplied)||0), 0);
      const balance = Number(p.balance)||0;
      const tolAbs = Number(r.tolAmount)||0;
      const tolPct = Number(r.tolPercent)||0;
      const tolFromPct = balance * (tolPct/100);
      const tol = Math.max(tolAbs, tolFromPct);

      // تعريف فرق مبسّط: إذا الرصيد داخل الهامش => مطابق
      const diff = Math.abs(balance - 0); // يمكن استبداله بمقارنة مقابل رصيد طرف خارجي لاحقًا

      let result = 'pending';
      if (r.requireZeroUnapplied && unappliedSum !== 0) {
        result = 'mismatch';
      } else {
        result = (diff <= tol) ? 'matched' : 'mismatch';
      }

      // حالة الخطاب المقترحة
      let status = state.rules.defaultStatus;
      if (result === 'matched') status = 'matched';
      if (result === 'mismatch') status = 'mismatch';

      // ملاحظة تلقائية
      const note = (state.rules.noteTemplate||'')
        .replaceAll('{tolAmount}', tolAbs)
        .replaceAll('{tolPercent}', tolPct)
        .replaceAll('{diff}', diff.toFixed(2));

      return { result, status, note, diff, unappliedSum, tol };
    }

    function recalcAllMatches(){
      parties.forEach(p => {
        const calc = computeMatchForParty(p);
        state.partyStatus.set(p.id, calc);
      });
      renderTable();
      toast('تم احتساب المطابقة وفق القواعد الحالية', 'success');
      audit('إعادة احتساب المطابقة');
    }

    /* ============================================================
       Render: Filters + Options
    ============================================================ */
    function initOptions() {
      // Branches
      const bsel = $('#branchSelect');
      bsel.innerHTML = `<option value="all">الكل</option>` + branches.map(b=>`<option value="${b.id}">${b.name}</option>`).join('');
      // Currencies
      const csel = $('#currencySelect');
      const distinct = [...new Set(currencies.map(c=>c.code))];
      csel.innerHTML = `<option value="all">الكل</option>` + distinct.map(c=>`<option value="${c}">${c}</option>`).join('');

      // Restore saved
      $('#fromDate').value = state.filters.fromDate || '';
      $('#toDate').value = state.filters.toDate || '';
      $$('input[name="ptype"]').forEach(r=> r.checked = (r.value === state.filters.ptype));
      bsel.value = state.filters.branch;
      csel.value = state.filters.currency;
      $('#minBalance').value = state.filters.minBalance;
      $('#confirmType').value = state.filters.confirmType;
      $('#includeUnapplied').checked = state.filters.includeUnapplied;
      $('#q').value = state.filters.q;
      $('#sortBy').value = state.filters.sortBy;

      // Template modal restore
      $('#tplPositive').value = state.template.positive;
      $('#tplNegative').value = state.template.negative;
      $('#showOrg').checked = state.template.showOrg;
      $('#showReply').checked = state.template.showReply;
      $('#showMoves').checked = state.template.showMoves;
      $('#showQR').checked = state.template.showQR;

      // Rules restore
      $('#tolAmount').value = state.rules.tolAmount;
      $('#tolPercent').value = state.rules.tolPercent;
      $('#requireZeroUnapplied').checked = state.rules.requireZeroUnapplied;
      $('#autoDisputeNegative').checked = state.rules.autoDisputeNegative;
      $('#defaultStatus').value = state.rules.defaultStatus;
      $('#allowManualOverride').checked = state.rules.allowManualOverride;
      $('#noteTemplate').value = state.rules.noteTemplate;

      summarizeRules();
    }

    /* ============================================================
       Filter + Sort + Search
    ============================================================ */
    function applyFilters() {
      state.filters.fromDate = $('#fromDate').value;
      state.filters.toDate = $('#toDate').value;
      state.filters.ptype = $('input[name="ptype"]:checked').value;
      state.filters.branch = $('#branchSelect').value;
      state.filters.currency = $('#currencySelect').value;
      state.filters.minBalance = Number($('#minBalance').value || 0);
      state.filters.confirmType = $('#confirmType').value;
      state.filters.includeUnapplied = $('#includeUnapplied').checked;
      state.filters.q = $('#q').value.trim();
      state.filters.sortBy = $('#sortBy').value;
      saveAll();
      renderTable();
    }

    function filteredParties() {
      let rows = parties.slice();
      const f = state.filters;

      if (f.ptype !== 'all') rows = rows.filter(p => p.type === f.ptype);
      if (f.branch !== 'all') rows = rows.filter(p => p.branch === f.branch);
      if (f.currency !== 'all') rows = rows.filter(p => p.currency === f.currency);
      if (f.minBalance > 0) rows = rows.filter(p => (p.balance || 0) >= f.minBalance);
      if (f.q) {
        const q = f.q.toLowerCase();
        rows = rows.filter(p => p.name.toLowerCase().includes(q) || p.code.toLowerCase().includes(q));
      }

      switch (f.sortBy) {
        case 'name': rows.sort((a,b)=> a.name.localeCompare(b.name, 'ar')); break;
        case 'code': rows.sort((a,b)=> a.code.localeCompare(b.code, 'en')); break;
        case 'balance': rows.sort((a,b)=> (b.balance||0) - (a.balance||0)); break;
      }
      return rows;
    }

    function renderTable() {
      const rows = filteredParties();
      const tb = $('#tbody'); tb.innerHTML = '';
      $('#emptyState').hidden = rows.length !== 0;
      const fmtBranch = id => (branches.find(b=>b.id===id)?.name || id);

      rows.forEach(p => {
        // احسب/اقترح نتيجة المطابقة إذا لم تكن موجودة
        if (!state.partyStatus.has(p.id)) {
          state.partyStatus.set(p.id, computeMatchForParty(p));
        }
        const st = state.partyStatus.get(p.id);

        const tr = document.createElement('tr');
        tr.className = 'selectable';
        tr.dataset.id = String(p.id);
        if (state.selected.has(p.id)) tr.classList.add('selected');
        tr.innerHTML = `
          <td><input type="checkbox" aria-label="تحديد" data-check data-id="${p.id}" ${state.selected.has(p.id)?'checked':''}></td>
          <td>${p.name}</td>
          <td>${p.code}</td>
          <td>${fmtBranch(p.branch)}</td>
          <td>${p.currency}</td>
          <td>${formatCurrency(p.balance, p.currency)}</td>
          <td>${p.aging}</td>
          <td>${renderMatchCell(st)}</td>
          <td>${renderLetterStatus(p)}</td>
          <td><button class="btn" data-details="${p.id}" title="تفاصيل">⤵︎</button></td>
        `;
        tb.appendChild(tr);

        const dtr = document.createElement('tr');
        dtr.className = 'details';
        dtr.id = `details-${p.id}`;
        dtr.innerHTML = `<td colspan="10">${renderDetails(p, st)}</td>`;
        tb.appendChild(dtr);
      });

      $('#genTime').textContent = 'وقت التوليد: ' + new Date().toLocaleString('ar-SA');
    }

    function renderMatchCell(st){
      const cls = st.result === 'matched' ? 'status-matched' : st.result === 'mismatch' ? 'status-mismatch' : 'status-review';
      return `<span class="status-pill ${cls}">${mapResultLabel(st.result)}</span><br/><small class="subtle">فرق: ${st.diff?.toFixed(2)||'—'} | غير مطبق: ${st.unappliedSum||0}</small>`;
    }

    function renderLetterStatus(p) {
      const last = p.lastLetter;
      if (!last) return `<span class="status-pill status-pending">لا يوجد</span>`;
      const map = { 'أُرسل':'status-sent', 'معلّق':'status-pending', 'معترض':'status-rejected', 'مؤكد':'status-confirmed' };
      const cls = map[last.status] || 'status-pending';
      return `<span class="status-pill ${cls}">${last.status}</span>`;
    }

    function renderDetails(p, st) {
      const items = openItems[p.id] || [];
      const itemsHtml = items.length
        ? `<table style="width:100%; border-collapse: collapse" aria-label="فواتير مفتوحة"><thead><tr>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">المستند</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">التاريخ</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">مستحق</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">المبلغ</th>
            <th style="text-align:start; padding:6px; border-bottom:1px solid var(--border)">غير مطبق</th>
          </tr></thead><tbody>
          ${items.map(it=>`<tr>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.doc}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.date}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${it.due}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${formatCurrency(it.amount, parties.find(x=>x.id===p.id)?.currency)}</td>
            <td style="padding:6px; border-bottom:1px solid var(--border)">${formatCurrency(it.unapplied, parties.find(x=>x.id===p.id)?.currency)}</td>
          </tr>`).join('')}
          </tbody></table>`
        : `<div style="color:var(--ink-2)">لا توجد فواتير/حركات مفتوحة.</div>`;

      const lastHtml = p.lastLetter
        ? `<ul style="margin:6px 0 0 0; padding-inline-start: 18px;">
            <li>التاريخ: ${p.lastLetter.date}</li>
            <li>النوع: ${p.lastLetter.type === 'negative' ? 'سلبي' : 'إيجابي'}</li>
            <li>الحالة: ${p.lastLetter.status}</li>
            <li><a href="#" onclick="event.preventDefault()">رابط PDF (وهمي)</a></li>
          </ul>`
        : `<div style="color:var(--ink-2)">لا يوجد سجل خطابات سابق.</div>`;

      const note = (state.partyStatus.get(p.id)?.note)||'';

      // أدوات التحكم بالحالة/الاعتراض
      const controlHtml = `
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px">
          <label>نتيجة المطابقة:
            <select data-result-for="${p.id}" class="select" ${state.rules.allowManualOverride?'' : 'disabled'}>
              <option value="matched" ${st.result==='matched'?'selected':''}>مطابق</option>
              <option value="mismatch" ${st.result==='mismatch'?'selected':''}>غير مطابق</option>
              <option value="pending" ${st.result==='pending'?'selected':''}>قيد المراجعة</option>
            </select>
          </label>
          <label>الحالة:
            <select data-status-for="${p.id}" class="select" ${state.rules.allowManualOverride?'' : 'disabled'}>
              <option value="matched" ${st.status==='matched'?'selected':''}>مؤكد/مطابق</option>
              <option value="mismatch" ${st.status==='mismatch'?'selected':''}>معترض</option>
              <option value="pending" ${st.status==='pending'?'selected':''}>قيد المراجعة</option>
            </select>
          </label>
          <button class="btn" data-apply-status="${p.id}">حفظ الحالة</button>
        </div>
        <div class="field" style="margin-top:6px">
          <label for="note-${p.id}">ملاحظات المطابقة</label>
          <textarea id="note-${p.id}" rows="3" placeholder="اكتب خلاصة سبب المطابقة/الاختلاف">${note}</textarea>
        </div>`;

      return `
        <div style="display:grid; grid-template-columns: 1.1fr .9fr; gap: 12px;">
          <div>
            <strong>آخر فواتير/حركات مفتوحة</strong>
            ${itemsHtml}
          </div>
          <div>
            <strong>الحالة والملاحظات</strong>
            <div style="margin-top:4px">${controlHtml}</div>
            <div style="margin-top:10px"><strong>سجل الخطابات السابقة</strong>${lastHtml}</div>
          </div>
        </div>
      `;
    }

    /* ============================================================
       Selection + Actions
    ============================================================ */
    function toggleRowSelection(id, checked) {
      if (checked) state.selected.add(id); else state.selected.delete(id);
      saveAll();
      const row = $$(`tbody tr.selectable`).find(r => Number(r.dataset.id) === id);
      if (row) row.classList.toggle('selected', checked);
    }

    function selectAllToggle(checked) {
      const ids = filteredParties().map(p=>p.id);
      ids.forEach(id => state.selected.add(id));
      if (!checked) ids.forEach(id => state.selected.delete(id));
      renderTable();
      $('#selectAll').checked = checked;
    }

    /* ============================================================
       Letter Templating
    ============================================================ */
    function renderTemplate(txt, p){
      const today = new Date().toLocaleDateString('ar-SA');
      return txt
        .replaceAll('{party}', p.name)
        .replaceAll('{code}', p.code)
        .replaceAll('{branch}', branches.find(b=>b.id===p.branch)?.name || p.branch)
        .replaceAll('{currency}', p.currency)
        .replaceAll('{balance}', formatCurrency(p.balance, p.currency))
        .replaceAll('{today}', today);
    }

    function buildLetterHTML(p) {
      const t = state.template;
      const orgBlock = t.showOrg ? `
        <div>
          <div style="font-weight:700">Smart Life ERP</div>
          <div>سجل تجاري: 123456789</div>
          <div>رقم ضريبي: 310123456789003</div>
          <div>الرياض — المملكة العربية السعودية</div>
        </div>` : '';

      const baseTxt = (state.filters.confirmType==='negative')? t.negative : t.positive;
      const txt = renderTemplate(baseTxt, p);

      const moves = (openItems[p.id]||[]);
      const movesHtml = state.template.showMoves && moves.length ? `
        <div style="margin-top:10px">
          <strong>ملخص الحركات ضمن الفترة:</strong>
          <table style="width:100%; border-collapse: collapse; margin-top:6px">
            <thead>
              <tr>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">المستند</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">التاريخ</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">مستحق</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">المبلغ</th>
                <th style="text-align:start; padding:6px; border-bottom:1px solid #e5e7eb">غير مطبق</th>
              </tr>
            </thead>
            <tbody>
              ${moves.map(m=>`<tr>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.doc}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.date}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${m.due}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${formatCurrency(m.amount, p.currency)}</td>
                <td style="padding:6px; border-bottom:1px solid #e5e7eb">${formatCurrency(m.unapplied, p.currency)}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>` : '';

      const reply = state.template.showReply ? `
        <div class="reply-slip">
          <strong>قصاصة الرد</strong>
          <div class="info-grid">
            <div>الطرف: ${p.name} (${p.code})</div>
            <div>الفرع: ${branches.find(b=>b.id===p.branch)?.name}</div>
            <div>العملة: ${p.currency}</div>
            <div>الرصيد: ${formatCurrency(p.balance, p.currency)}</div>
          </div>
          <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items:center;">
            <div>
              <div>اسم الموقّع: __________________</div>
              <div>التوقيع والختم: ______________</div>
              <div>التاريخ: ____ / ____ / ______</div>
            </div>
            ${state.template.showQR ? `<div class="qr" title="QR" aria-label="QR"></div>` : ''}
          </div>
        </div>` : '';

      return `
        <article class="letter" data-party-id="${p.id}">
          <header>
            <div class="brand"><div class="logo" aria-hidden="true">SL</div><h3>خطاب مطابقة الرصيد</h3></div>
            ${orgBlock}
          </header>
          <div class="info-grid">
            <div>الطرف: <strong>${p.name}</strong> (${p.code})</div>
            <div>النوع: ${p.type === 'customer' ? 'عميل' : 'مورد'}</div>
            <div>الفرع: ${branches.find(b=>b.id===p.branch)?.name}</div>
            <div>العملة: ${p.currency}</div>
            <div>الرصيد الحالي: ${formatCurrency(p.balance, p.currency)}</div>
            <div>عمر الدين: ${p.aging}</div>
          </div>
          <p style="margin-top:8px">${txt}</p>
          <p style="color:#475569; font-size: 14px;">يرجى الرد عبر هذا الرابط (وهمي): <a href="#">https://confirm.example/${p.id}</a></p>
          ${movesHtml}
          ${reply}
        </article>
      `;
    }

    /* ============================================================
       Actions: Generate / Preview / Email / ZIP / PDF merged
    ============================================================ */
    function requireSelection() {
      if (state.selected.size === 0) { toast('يرجى اختيار صف واحد على الأقل', 'warn'); return false; }
      return true;
    }

    async function generateLetters() {
      if (!requireSelection()) return;
      setBusy(true);
      await new Promise(r=>setTimeout(r, 300)); // fake small delay
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const html = buildLetterHTML(p);
        state.generatedMap.set(id, html);
      }
      setBusy(false);
      toast('تم توليد الخطابات المحددة', 'success');
      audit('توليد خطابات', `عدد: ${state.selected.size}`);

      // افتح أول معاينة
      const first = state.selected.values().next().value;
      if (first) showPreview(first);
    }

    function showPreview(id) {
      const html = state.generatedMap.get(id);
      if (!html) { toast('ليس هناك معاينة — قم بالتوليد أولًا', 'warn'); return; }
      $('#previewArea').innerHTML = html;
      $('#previewModal').showModal();
    }

    function downloadAsHTMLBlob(filename, html) {
      const blob = new Blob([`<!doctype html><html lang=\"ar\" dir=\"rtl\"><meta charset=\"utf-8\"><title>${filename}</title><body>${html}</body></html>`], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename + '.html';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    async function downloadZIP() {
      if (!requireSelection()) return;
      if (state.generatedMap.size === 0) { toast('قم بتوليد الخطابات أولًا', 'warn'); return; }
      let count = 0;
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const html = state.generatedMap.get(id);
        if (html) { downloadAsHTMLBlob(`${p.code}-${p.name}-letter`, html); count++; }
      }
      toast(`تم تجهيز ${count} ملفًا للتنزيل (HTML)`, 'success');
      audit('تنزيل متعدد', `عدد: ${count}`);
    }

    async function sendEmailFake() {
      if (!requireSelection()) return;
      setBusy(true);
      await new Promise(r=>setTimeout(r, 800)); // محاكاة تأخير
      setBusy(false);
      for (const id of state.selected) {
        const p = parties.find(x=>x.id===id);
        const kind = (state.filters.confirmType==='negative')? 'negative' : 'positive';
        const status = kind==='negative' && state.rules.autoDisputeNegative ? 'معترض' : 'أُرسل';
        p.lastLetter = { date: new Date().toISOString().slice(0,10), type: kind, status };
      }
      renderTable();
      toast('تم إرسال الخطابات بالبريد (محاكاة)', 'success');
      audit('إرسال بالبريد', `عدد: ${state.selected.size}`);
    }

    function mergedPDFPreview() {
      if (!requireSelection()) return;
      if (state.generatedMap.size === 0) { toast('قم بتوليد الخطابات أولًا', 'warn'); return; }
      const wrap = $('#printContainer');
      wrap.innerHTML = '';
      for (const id of state.selected) {
        const html = state.generatedMap.get(id);
        if (html) {
          const div = document.createElement('div');
          div.innerHTML = html;
          wrap.appendChild(div.firstElementChild); // article.letter
        }
      }
      wrap.hidden = false;
      toast('جاهز للطباعة — سيُفصل كل خطاب في صفحة مستقلة', 'success');
      setTimeout(()=>window.print(), 50);
      audit('معاينة PDF مدمج (طباعة HTML)', `عدد: ${state.selected.size}`);
    }

    /* ============================================================
       Events Wiring
    ============================================================ */
    function wireEvents() {
      $('#applyFilters').addEventListener('click', applyFilters);
      $('#resetFilters').addEventListener('click', () => {
        Object.assign(state.filters, { fromDate:'', toDate:'', ptype:'all', branch:'all', currency:'all', minBalance:0, confirmType:'positive', includeUnapplied:false, q:'', sortBy:'name' });
        saveAll(); initOptions(); renderTable();
      });

      $('#q').addEventListener('input', () => { state.filters.q = $('#q').value; renderTable(); });
      $('#sortBy').addEventListener('change', () => { state.filters.sortBy = $('#sortBy').value; saveAll(); renderTable(); });
      $('#selectAll').addEventListener('change', e => selectAllToggle(e.target.checked));

      $('#tbody').addEventListener('change', e => {
        if (e.target.matches('[data-check]')) {
          const id = Number(e.target.dataset.id);
          toggleRowSelection(id, e.target.checked);
        }
      });

      $('#tbody').addEventListener('click', e => {
        const btn = e.target.closest('[data-details]');
        if (btn) {
          const id = btn.getAttribute('data-details');
          const row = document.getElementById('details-' + id);
          row.classList.toggle('open');
        }

        // حفظ الحالة والملاحظة
        const applyBtn = e.target.closest('[data-apply-status]');
        if (applyBtn) {
          const id = Number(applyBtn.getAttribute('data-apply-status'));
          const resSel = document.querySelector(`[data-result-for="${id}"]`);
          const stSel = document.querySelector(`[data-status-for="${id}"]`);
          const note = document.getElementById(`note-${id}`)?.value || '';
          const prev = state.partyStatus.get(id) || {};
          state.partyStatus.set(id, { ...prev, result: resSel.value, status: stSel.value, note });
          renderTable();
          toast('تم حفظ الحالة والملاحظات', 'success');
          audit('تحديث حالة طرف', `ID: ${id}`);
        }
      });

      $('#btnGenerate').addEventListener('click', generateLetters);
      $('#btnEmail').addEventListener('click', sendEmailFake);
      $('#btnZip').addEventListener('click', downloadZIP);
      $('#btnPDF').addEventListener('click', mergedPDFPreview);
      $('#btnCalc').addEventListener('click', recalcAllMatches);

      // Preview modal actions
      $('#printLetter').addEventListener('click', () => window.print());
      $('#downloadLetter').addEventListener('click', () => {
        const article = $('#previewArea .letter');
        if (!article) return toast('لا توجد معاينة نشطة', 'warn');
        const id = Number(article.getAttribute('data-party-id'));
        const p = parties.find(x=>x.id===id);
        downloadAsHTMLBlob(`${p.code}-${p.name}-letter`, article.outerHTML);
      });

      // open/close modals
      $('#openTemplateBtn').addEventListener('click', () => $('#templateModal').showModal());
      $('#openRulesBtn').addEventListener('click', () => $('#rulesModal').showModal());
      $$('dialog [data-close]').forEach(b => b.addEventListener('click', e => e.target.closest('dialog').close()));

      // save template
      $('#saveTemplate').addEventListener('click', () => {
        state.template.positive = $('#tplPositive').value.trim() || state.template.positive;
        state.template.negative = $('#tplNegative').value.trim() || state.template.negative;
        state.template.showOrg = $('#showOrg').checked;
        state.template.showReply = $('#showReply').checked;
        state.template.showMoves = $('#showMoves').checked;
        state.template.showQR = $('#showQR').checked;
        saveAll();
        toast('تم حفظ إعدادات القالب', 'success');
        audit('حفظ القوالب');
      });
      $('#resetTemplate').addEventListener('click', () => {
        state.template = {
          positive: 'نفيدكم بأن رصيد حسابكم لدينا مطابق لسجلاتنا. الطرف: {party} ({code}) — الفرع: {branch} — الرصيد: {balance}. نرجو تأكيدكم الإيجابي خلال 7 أيام من تاريخه {today}.',
          negative: 'نفيدكم بوجود اختلاف في رصيد حسابكم لدينا للطرف: {party} ({code}). الرصيد الظاهر لدينا: {balance}. نأمل التزويد بالملاحظات والمستندات خلال 7 أيام من تاريخه {today}.',
          showOrg: true, showReply: true, showMoves: true, showQR: false
        };
        initOptions(); saveAll();
        toast('تمت الاستعادة للوضع الافتراضي', 'success');
        audit('استعادة القوالب الافتراضية');
      });

      // save rules
      $('#saveRules').addEventListener('click', () => {
        state.rules.tolAmount = Number($('#tolAmount').value||0);
        state.rules.tolPercent = Number($('#tolPercent').value||0);
        state.rules.requireZeroUnapplied = $('#requireZeroUnapplied').checked;
        state.rules.autoDisputeNegative = $('#autoDisputeNegative').checked;
        state.rules.defaultStatus = $('#defaultStatus').value;
        state.rules.allowManualOverride = $('#allowManualOverride').checked;
        state.rules.noteTemplate = $('#noteTemplate').value.trim() || state.rules.noteTemplate;
        saveAll(); summarizeRules();
        toast('تم حفظ قواعد المطابقة', 'success');
        audit('حفظ قواعد المطابقة');
      });

      // theme toggle
      $('#toggleTheme').addEventListener('click', (e) => {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        e.currentTarget.setAttribute('aria-pressed', String(!isDark));
      });

      // row click selects checkbox (keyboard friendly)
      $('#tbody').addEventListener('click', e => {
        const tr = e.target.closest('tr.selectable');
        if (tr && !e.target.closest('input,button,a,select,textarea')) {
          const id = Number(tr.dataset.id);
          const cb = tr.querySelector('[data-check]');
          cb.checked = !cb.checked; cb.dispatchEvent(new Event('change', {bubbles:true}));
        }
      });

      // keyboard navigation hint: focus first input
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement.tagName !== 'INPUT') { e.preventDefault(); $('#q').focus(); }
      });
    }

    /* ============================================================
       Init
    ============================================================ */
    function init() {
      loadAll();
      initOptions();
      recalcAllMatches(); // يحسب ويعرض الجدول
      wireEvents();
      audit('دخول الصفحة');
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
